<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary:#4F46E5; --bg:#F3F4F6; --card:#FFFFFF; --text:#1F2937; }
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); margin:0; padding:20px 20px 80px; color:var(--text); }
    h2 { font-size:20px; margin:0 0 10px; font-weight:800; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; line-height:1.4; }

    .card { background:var(--card); border-radius:18px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .form-group { margin-bottom:16px; }
    label { display:block; font-size:14px; font-weight:700; margin-bottom:8px; color:#4B5563; }

    input, select, textarea {
      width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB;
      background:#fff; font-size:16px; box-sizing:border-box; -webkit-appearance:none;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
    textarea { resize:vertical; min-height:86px; }

    .chiprow { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
      user-select:none;
    }
    .chip input { width:auto; }

    /* âœ… å‰å°èªªäººè©±ï¼Œä¸è¦å·¥ç¨‹å¸«è¨»è§£ */
    .noteBox{
      background:#F9FAFB; border:1px solid #E5E7EB; padding:12px; border-radius:12px;
      font-size:13px; color:#6B7280; line-height:1.45;
    }

    .btn-submit {
      width:100%; background:var(--primary); color:#fff;
      padding:14px; border:none; border-radius:14px;
      font-size:16px; font-weight:800; margin-top:10px; cursor:pointer;
      box-shadow:0 10px 22px rgba(79,70,229,.18);
    }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    .nav {
      position:fixed; bottom:0; left:0; right:0; background:var(--card);
      padding:12px 20px; padding-bottom:max(12px, env(safe-area-inset-bottom));
      display:flex; justify-content:space-around;
      box-shadow:0 -4px 20px rgba(0,0,0,.06);
      border-top-left-radius:24px; border-top-right-radius:24px; z-index:100;
    }
    .nav-item { text-decoration:none; color:#9CA3AF; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
    .nav-item.active { color:var(--primary); }
    .nav-icon { font-size:22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="card">
    <div class="form-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="OUTING">å¤–å‡º</option>
        <option value="CORRECTION">è£œå¡</option>
      </select>
    </div>

    <div class="form-group" id="typeGroup">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="paternity">é™ªç”¢å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <!-- âœ… è£œå¡é¡å‹ï¼šåªç•™ IN / OUTï¼ˆç æ‰åŒä¸€æ™‚é–“é»ï¼‰ -->
    <div class="form-group" id="correctionTypeGroup" style="display:none;">
      <label>è£œå¡é¡å‹</label>
      <select id="correctionType">
        <option value="IN">è£œä¸Šç­ï¼ˆè£œæ‰“å¡ï¼šä¸Šç­ï¼‰</option>
        <option value="OUT">è£œä¸‹ç­ï¼ˆè£œæ‰“å¡ï¼šä¸‹ç­ï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label id="startLabel">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start">
    </div>

    <div class="form-group" id="endWrap">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end">
    </div>

    <div class="form-group" id="extraGroup" style="display:none;">
      <div class="chiprow">
        <label class="chip"><input type="checkbox" id="isTrip"/> å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
        <label class="chip"><input type="checkbox" id="autoClock"/> å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>

    <div class="form-group" id="hoursGroup">
      <label>æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰</label>
      <input type="number" id="hours" value="0.0" readonly style="background-color:#F3F4F6;">
    </div>

    <div class="form-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <div class="noteBox" id="noteBox"></div>

    <button class="btn-submit" id="submitBtn" type="button">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none;"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½
     * ============================== */
    const empId =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      "";

    const userId =
      localStorage.getItem("lineUserId") ||
      localStorage.getItem("LineUserId") ||
      localStorage.getItem("userId") ||
      "";

    const uid = empId || userId || "";

    const isMgr = (localStorage.getItem("isManager") === "true") || !!localStorage.getItem("managerId");
    if (isMgr) document.getElementById("mgrBtn").style.display = "flex";
    if (!uid) location.href = "index.html";

    /* ==============================
     * 1) JSONP API
     * ============================== */
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        if (!window.CONFIG || !window.CONFIG.GAS_ENDPOINT) {
          reject(new Error("Missing CONFIG.GAS_ENDPOINT"));
          return;
        }
        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000000);
        const s = document.createElement("script");

        const payloadObj = Object.assign({}, data, {
          empId: empId || undefined,
          userId: userId || undefined
        });

        if (window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null) {
          payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
        }

        const payload = encodeURIComponent(JSON.stringify(payloadObj));
        s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("timeout"));
        }, 15000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cbName]; } catch (e) {}
          try { s.remove(); } catch (e) {}
        }

        window[cbName] = (res) => { cleanup(); resolve(res); };
        s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
        document.body.appendChild(s);
      });
    }

    /* ==============================
     * 2) æ™‚é–“å·¥å…·
     * ============================== */
    function pad2(n) { return String(n).padStart(2, '0'); }
    function toLocalInputValue(d) {
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function parseLocalInput(v){
      if(!v) return null;
      const d = new Date(v);
      return isNaN(d.getTime()) ? null : d;
    }
    function sameDay_(a, b) {
      return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
    }
    function roundToHalf(h) { return Math.round(h * 2) / 2; }

    /* ==============================
     * 3) ç­åˆ¥è¦å‰‡ï¼ˆä½ çš„è¦å‰‡ï¼‰
     * ============================== */
    const SHIFT_DEF = {
      EARLY: { label:'æ—©ç­', start:'10:00', end:'18:00', breakHours:0 },
      LATE:  { label:'åˆç­', start:'12:00', end:'21:00', breakHours:1 } // ä¸­é–“ä¼‘ä¸€å°æ™‚
    };

    // ä¾æ’ç­ shift å€¼æ¨å°æˆ EARLY/LATEï¼ŒæŸ¥ä¸åˆ°å°± EARLY
    function normalizeShiftValue(v){
      const s = String(v||'').trim().toLowerCase();
      if(s.includes('åˆ') || s.includes('late')) return 'LATE';
      if(s.includes('æ—©') || s.includes('early')) return 'EARLY';
      return 'EARLY';
    }

    function setTimeByShiftForDate(dateObj, shiftKey){
      const def = SHIFT_DEF[shiftKey] || SHIFT_DEF.EARLY;
      const [sh, sm] = def.start.split(':').map(Number);
      const [eh, em] = def.end.split(':').map(Number);

      const s = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), sh, sm, 0, 0);
      const e = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), eh, em, 0, 0);

      document.getElementById("start").value = toLocalInputValue(s);
      document.getElementById("end").value = toLocalInputValue(e);
    }

    /* ==============================
     * 4) å‰å°æç¤ºï¼ˆç°¡çŸ­äººè©±ï¼‰
     * ============================== */
    const noteBox = document.getElementById("noteBox");
    function setNote(){
      const cat = document.getElementById("cat").value;

      if(cat === "CORRECTION"){
        const ct = document.getElementById("correctionType").value;
        noteBox.textContent = (ct === "IN")
          ? "è£œå¡ï¼ˆä¸Šç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚"
          : "è£œå¡ï¼ˆä¸‹ç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚";
        return;
      }

      if(cat === "LEAVE"){
        noteBox.textContent = "è«‹å‡ï¼šç³»çµ±æœƒä¾æ’ç­è‡ªå‹•å¸¶å…¥ç•¶å¤©ç­åˆ¥æ™‚é–“ï¼ˆæ—©ç­/åˆç­ï¼‰ï¼Œå¯å†è‡ªè¡Œå¾®èª¿ã€‚";
        return;
      }

      if(cat === "OUTING"){
        noteBox.textContent = "å¤–å‡ºï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ï¼Œéå‡ºå·®æœ€å¤š 8 å°æ™‚ã€‚";
        return;
      }

      noteBox.textContent = "åŠ ç­ï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ã€‚";
    }

    /* ==============================
     * 5) ä¾æ’ç­è‡ªå‹•å¸¶å…¥è«‹å‡æ™‚é–“ï¼ˆä¿®ä½ èªªçš„è·¨æ—¥æ€ªï¼‰
     *    - ç”¨ schedule çš„ get_roster_data æŸ¥ç•¶å¤© shift
     * ============================== */
    async function applyLeaveAutoTimeByRoster(){
      const cat = document.getElementById("cat").value;
      if(cat !== "LEAVE") return;

      const sVal = document.getElementById("start").value;
      const s = parseLocalInput(sVal);
      if(!s) return;

      const y = s.getFullYear();
      const m = s.getMonth()+1;
      const d = s.getDate();

      // é è¨­ï¼šæ—©ç­
      let shiftKey = 'EARLY';

      try{
        const res = await api("get_roster_data", { year:y, month:m });
        if(res && res.ok){
          const roster = res.roster || {};
          const employees = Array.isArray(res.employees) ? res.employees : [];

          // æ‰¾è‡ªå·±çš„ empId
          const myId = empId || "";
          if(myId && roster[myId] && roster[myId][d] && roster[myId][d].value){
            shiftKey = normalizeShiftValue(roster[myId][d].value);
          }else{
            // æ‰¾ä¸åˆ°å°±ç…§ä½ è¦å‰‡ï¼š10:00 ä¸Šç­ï¼ˆEARLYï¼‰
            shiftKey = 'EARLY';
          }
        }
      }catch(e){
        shiftKey = 'EARLY';
      }

      setTimeByShiftForDate(s, shiftKey);
      calcHoursSmart();
    }

    /* ==============================
     * 6) é¡å‹åˆ‡æ›
     * ============================== */
    function toggleType() {
      const cat = document.getElementById("cat").value;

      const typeGroup = document.getElementById("typeGroup");
      const correctionTypeGroup = document.getElementById("correctionTypeGroup");
      const hoursGroup = document.getElementById("hoursGroup");
      const endWrap = document.getElementById("endWrap");
      const extraGroup = document.getElementById("extraGroup");
      const startLabel = document.getElementById("startLabel");

      if (cat === "CORRECTION") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "block";
        hoursGroup.style.display = "none";
        endWrap.style.display = "none";
        extraGroup.style.display = "none";
        startLabel.textContent = "è£œå¡æ™‚é–“";
        document.getElementById("hours").value = "0.0";
        document.getElementById("end").value = "";
      } else if (cat === "OUTING") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "block";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      } else if (cat === "OT") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      } else {
        typeGroup.style.display = "block";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      }

      setNote();
    }

    /* ==============================
     * 7) æ™‚æ•¸è¨ˆç®—ï¼ˆåˆç­æ‰£ 1 å°æ™‚ä¼‘æ¯ï¼‰
     * ============================== */
    function calcHoursSmart() {
      const cat = document.getElementById("cat").value;
      if (cat === "CORRECTION") {
        document.getElementById("hours").value = "0.0";
        return;
      }

      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if (!sVal || !eVal) return;

      const s = new Date(sVal);
      const e = new Date(eVal);

      if (e <= s) {
        document.getElementById("hours").value = "0.0";
        return;
      }

      // ç”Ÿæ—¥å‡ä¸å¯è·¨æ—¥
      const leaveType = document.getElementById("type")?.value || "";
      if (cat === "LEAVE" && leaveType === "birthday" && !sameDay_(s, e)) {
        document.getElementById("end").value = sVal;
        document.getElementById("hours").value = "0.0";
        return;
      }

      let diff = (e - s) / (1000 * 60 * 60);

      // åˆç­ï¼šå¦‚æœå€é–“è·¨é 16:00-17:00ï¼ˆå‡è¨­ä¼‘æ¯è½åœ¨ä¸­é–“ï¼‰å°±æ‰£ 1 å°æ™‚
      // ä½ è‹¥è¦æŠŠä¼‘æ¯å›ºå®šåœ¨ 16:00-17:00 ä»¥å¤–ä¹Ÿå¯èª¿é€™æ®µ
      if(cat === "LEAVE"){
        const sh = s.getHours()*60 + s.getMinutes();
        const eh = e.getHours()*60 + e.getMinutes();
        const crossesLunchBreak = (sh < 16*60) && (eh > 17*60);
        if(crossesLunchBreak) diff -= 1;
      }

      diff = roundToHalf(diff);
      diff = Math.max(0.5, diff);

      if (cat === "OUTING") {
        const isTrip = !!document.getElementById("isTrip").checked;
        if (!isTrip) diff = Math.min(8, diff);
      }

      document.getElementById("hours").value = diff.toFixed(1);
    }

    /* ==============================
     * 8) é€å‡ºç”³è«‹
     * ============================== */
    async function submitReq() {
      const btn = document.getElementById("submitBtn");
      const cat = document.getElementById("cat").value;

      btn.disabled = true;
      btn.innerText = "é€å‡ºä¸­...";

      const start = document.getElementById("start").value;
      let end = document.getElementById("end").value;

      if (!start) {
        alert("è«‹å…ˆé¸æ“‡é–‹å§‹æ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      if (cat === "CORRECTION") {
        end = start;
      } else {
        if (!end) {
          alert("è«‹å…ˆé¸æ“‡çµæŸæ™‚é–“");
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
          return;
        }
      }

      const hours = (cat === "CORRECTION") ? 0 : Number(document.getElementById("hours").value || 0);

      if (cat !== "CORRECTION" && hours <= 0) {
        alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const leaveType =
        (cat === "LEAVE") ? document.getElementById("type").value :
        (cat === "OT") ? "ot" :
        (cat === "OUTING") ? "outing" : "correction";

      const data = {
        category: cat,
        leaveType,
        start,
        end,
        hours,
        reason: document.getElementById("reason").value || "",
        autoClock: (cat === "OUTING") ? !!document.getElementById("autoClock").checked : false,
        isTrip: (cat === "OUTING") ? !!document.getElementById("isTrip").checked : false
      };

      if (cat === "CORRECTION") {
        data.correctionType = document.getElementById("correctionType").value; // IN / OUT
      }

      try {
        const res = await api("submit_request", data);
        if (res && res.ok) {
          alert("ç”³è«‹æˆåŠŸï¼");
          location.href = "history.html";
        } else {
          alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
        }
      } catch (e) {
        alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }

    /* ==============================
     * 9) ç¶å®šäº‹ä»¶
     * ============================== */
    (function bindAll() {
      const startEl = document.getElementById("start");
      const endEl = document.getElementById("end");
      const catEl = document.getElementById("cat");
      const typeEl = document.getElementById("type");
      const correctionTypeEl = document.getElementById("correctionType");
      const isTripEl = document.getElementById("isTrip");
      const autoClockEl = document.getElementById("autoClock");
      const submitBtn = document.getElementById("submitBtn");

      const safeRecalc = () => { calcHoursSmart(); setNote(); };

      [startEl, endEl].forEach(el => {
        if (!el) return;
        el.addEventListener("input", safeRecalc);
        el.addEventListener("change", safeRecalc);
        el.addEventListener("blur", safeRecalc);
      });

      catEl.addEventListener("change", async () => {
        toggleType();
        safeRecalc();
        await applyLeaveAutoTimeByRoster();
      });

      if(typeEl){
        typeEl.addEventListener("change", safeRecalc);
      }
      if(correctionTypeEl){
        correctionTypeEl.addEventListener("change", setNote);
      }
      if(isTripEl) isTripEl.addEventListener("change", safeRecalc);
      if(autoClockEl) autoClockEl.addEventListener("change", safeRecalc);

      submitBtn.addEventListener("click", submitReq);
    })();

    /* ==============================
     * 10) åˆå§‹åŒ–ï¼šé è¨­ä»Šå¤© 10:00-18:00
     * ============================== */
    (function initDefaultTime() {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0, 0);
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0, 0);
      document.getElementById("start").value = toLocalInputValue(base);
      document.getElementById("end").value = toLocalInputValue(end);
    })();

    toggleType();
    calcHoursSmart();
    setNote();
  </script>
</body>
</html>
