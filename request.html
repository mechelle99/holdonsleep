<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary:#4F46E5; --bg:#F3F4F6; --card:#FFFFFF; --text:#1F2937; }
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); margin:0; padding:20px 20px 80px; color:var(--text); }
    h2 { font-size:20px; margin:0 0 10px; font-weight:800; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; line-height:1.4; }

    .card { background:var(--card); border-radius:18px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .form-group { margin-bottom:16px; }
    label { display:block; font-size:14px; font-weight:700; margin-bottom:8px; color:#4B5563; }

    input, select, textarea {
      width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB;
      background:#fff; font-size:16px; box-sizing:border-box; -webkit-appearance:none;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
    textarea { resize:vertical; min-height:86px; }

    .row { display:flex; gap:10px; }
    .row > div { flex:1; }

    .chiprow { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
      user-select:none;
    }
    .chip input { width:auto; }

    .mutedBox { background:#F9FAFB; border:1px solid #E5E7EB; padding:12px; border-radius:12px; font-size:13px; color:#6B7280; line-height:1.45; }

    .btn-submit {
      width:100%; background:var(--primary); color:#fff;
      padding:14px; border:none; border-radius:14px;
      font-size:16px; font-weight:800; margin-top:10px; cursor:pointer;
      box-shadow:0 10px 22px rgba(79,70,229,.18);
    }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    .nav {
      position:fixed; bottom:0; left:0; right:0; background:var(--card);
      padding:12px 20px; padding-bottom:max(12px, env(safe-area-inset-bottom));
      display:flex; justify-content:space-around;
      box-shadow:0 -4px 20px rgba(0,0,0,.06);
      border-top-left-radius:24px; border-top-right-radius:24px; z-index:100;
    }
    .nav-item { text-decoration:none; color:#9CA3AF; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
    .nav-item.active { color:var(--primary); }
    .nav-icon { font-size:22px; }

    .hide { display:none !important; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>
  

  <div class="card">
    <div class="form-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="OUTING">å¤–å‡º</option>
        <option value="CORRECTION">è£œå¡</option>
      </select>
    </div>

    <div class="form-group" id="typeGroup">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="paternity">é™ªç”¢å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <div class="form-group">
      <label id="startLabel">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start">
    </div>

    <div class="form-group" id="endWrap">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end">
    </div>

    <div class="form-group" id="extraGroup" style="display:none;">
      <div class="chiprow">
        <label class="chip"><input type="checkbox" id="isTrip"/> å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
        <label class="chip"><input type="checkbox" id="autoClock"/> å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>

    <div class="form-group" id="hoursGroup">
      <label>æ™‚æ•¸ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
      <input type="number" id="hours" value="0" readonly style="background-color:#F3F4F6;">
    </div>

    <div class="form-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <div class="mutedBox" id="tipsBox"></div>

    <button class="btn-submit" id="submitBtn" onclick="submitReq()">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none;"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  // ========= åŸºæœ¬èº«ä»½ =========
  const uid = localStorage.getItem("employeeId");
  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) document.getElementById("mgrBtn").style.display = "flex";
  if(!uid) location.href = "index.html";

  // ========= JSONP APIï¼ˆç©©å®šç‰ˆï¼šcallback åå­—å›ºå®šï¼Œä¸æœƒè¢« Date.now() æ‰“æ¶ï¼‰ =========
  function api(act, d={}){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
      const s = document.createElement("script");
      const payload = encodeURIComponent(JSON.stringify({...d, userId: uid}));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(act)}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

      const timer = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        try { s.remove(); } catch(e){}
      }

      window[cbName] = (res) => { cleanup(); resolve(res); };
      s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
      document.body.appendChild(s);
    });
  }

  // ========= ç­è¡¨å¿«å– =========
  let RULES = null;
  async function ensureRules(){
    if (RULES) return RULES;
    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value || sVal;
    const res = await api("get_rules", { start: sVal, end: eVal });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "get_rules failed");
    RULES = { scheduleMap: res.scheduleMap || {} };
    return RULES;
  }

  // ========= åˆå§‹åŒ–æ™‚é–“ï¼šä»Šå¤© 10:00-18:00 =========
  const now = new Date();
  const ymd = now.toISOString().split('T')[0];
  document.getElementById("start").value = `${ymd}T10:00`;
  document.getElementById("end").value   = `${ymd}T18:00`;

  // ========= å°å·¥å…· =========
  function toYMD(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  function overlapHours(aStart,aEnd,bStart,bEnd){
    const ms = Math.max(0, Math.min(aEnd,bEnd) - Math.max(aStart,bStart));
    return ms/(1000*60*60);
  }
  function roundToHalf(h){ return Math.round(h*2)/2; }
  function sameDay_(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

  // EARLY 10-18 / LATE 12-20 / OFF
  function shiftWindowForYMD(ymd, scheduleMap){
    const raw = (scheduleMap && scheduleMap[ymd]) ? String(scheduleMap[ymd]).toUpperCase().trim() : "";
    const isOff = raw.includes("OFF") || raw.includes("ä¼‘");
    if (isOff) return { off:true };

    const isLate = raw.includes("LATE") || raw.includes("åˆ") || raw.includes("12") || raw.includes("21") || raw.includes("20");
    const startH = isLate ? 12 : 10;
    const endH   = isLate ? 20 : 18;
    return { off:false, startH, endH };
  }

  // ========= UI åˆ‡æ› =========
  const tipsBox = document.getElementById("tipsBox");

  function setTips(){
    const cat = document.getElementById("cat").value;
    const type = document.getElementById("type").value;

    let msg = "";
    if (cat === "CORRECTION"){
      msg = "âœ… è£œå¡ï¼šåªéœ€é¸æ“‡ã€Œè£œå¡ç•¶ä¸‹çš„æ™‚é–“é»ã€ï¼Œç³»çµ±ä¸è¦æ±‚çµæŸæ™‚é–“ï¼Œæ™‚æ•¸å›ºå®šç‚º 0ã€‚";
    } else if (cat === "OUTING"){
      msg = "âœ… å¤–å‡ºï¼šä¾å¯¦éš›æ™‚é–“è¨ˆç®—ï¼Œéå‡ºå·®æœ€å¤š 8 å°æ™‚ï¼›å¯å‹¾é¸ã€Œå¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡ã€ã€‚";
    } else if (cat === "OT"){
      msg = "âœ… åŠ ç­ï¼šä¾å¯¦éš›å€é–“è¨ˆç®—ï¼Œæ ¸å‡†å¾Œæœƒè½‰å…¥è£œä¼‘ï¼ˆcompï¼‰ã€‚";
    } else {
      msg = "âœ… è«‹å‡ï¼šä¾æ’ç­æ™‚æ®µè¨ˆç®—é‡ç–Šæ™‚æ•¸ï¼›ç”Ÿæ—¥å‡åªèƒ½åœ¨ç”Ÿæ—¥ç•¶æœˆä¸”ä¸å¯è·¨æ—¥ã€‚";
      if (type === "birthday") msg += "ï¼ˆä½ ç¾åœ¨é¸çš„æ˜¯ç”Ÿæ—¥å‡ï¼‰";
    }
    tipsBox.textContent = msg;
  }

  function toggleType(){
    const cat = document.getElementById("cat").value;
    const typeGroup = document.getElementById("typeGroup");
    const hoursGroup = document.getElementById("hoursGroup");
    const endWrap = document.getElementById("endWrap");
    const extraGroup = document.getElementById("extraGroup");
    const startLabel = document.getElementById("startLabel");

    RULES = null;

    if (cat === "CORRECTION"){
      // âœ… è£œå¡ï¼šåªè¦ startï¼Œä¸€å¾‹ä¸é¡¯ç¤º end/hours/extra/type
      typeGroup.style.display = "none";
      hoursGroup.style.display = "none";
      endWrap.style.display = "none";
      extraGroup.style.display = "none";
      startLabel.textContent = "è£œå¡æ™‚é–“";
      document.getElementById("hours").value = 0;
      document.getElementById("end").value = "";
    } else if (cat === "OUTING"){
      typeGroup.style.display = "none";
      hoursGroup.style.display = "block";
      endWrap.style.display = "block";
      extraGroup.style.display = "block";
      startLabel.textContent = "é–‹å§‹æ™‚é–“";
      calcHoursSmart();
    } else if (cat === "OT"){
      typeGroup.style.display = "none";
      hoursGroup.style.display = "block";
      endWrap.style.display = "block";
      extraGroup.style.display = "none";
      startLabel.textContent = "é–‹å§‹æ™‚é–“";
      calcHoursSmart();
    } else {
      typeGroup.style.display = "block";
      hoursGroup.style.display = "block";
      endWrap.style.display = "block";
      extraGroup.style.display = "none";
      startLabel.textContent = "é–‹å§‹æ™‚é–“";
      calcHoursSmart();
    }

    setTips();
  }

  function onTimeChange(){
    const cat = document.getElementById("cat").value;
    if (cat === "CORRECTION") return;

    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (sVal && eVal){
      const s = new Date(sVal);
      const e = new Date(eVal);
      if (e < s) document.getElementById("end").value = sVal;
    }
    RULES = null;
    calcHoursSmart();
  }

  // ========= æ™‚æ•¸è¨ˆç®— =========
  async function calcHoursSmart(){
    const cat = document.getElementById("cat").value;
    if (cat === "CORRECTION") return;

    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (!sVal || !eVal) return;

    const s = new Date(sVal);
    const e = new Date(eVal);

    const leaveType = document.getElementById("type")?.value;

    // ç”Ÿæ—¥å‡ UX é˜²å‘†
    if (cat === "LEAVE" && leaveType === "birthday" && !sameDay_(s,e)){
      document.getElementById("end").value = sVal;
      document.getElementById("hours").value = "0.0";
      return;
    }

    if (e <= s){
      document.getElementById("hours").value = "0.0";
      return;
    }

    try{
      if (cat === "LEAVE"){
        const rules = await ensureRules();
        const scheduleMap = rules.scheduleMap || {};
        let total = 0;

        const cur = new Date(s); cur.setHours(0,0,0,0);
        const endDay = new Date(e); endDay.setHours(0,0,0,0);

        while (cur <= endDay){
          const ymd = toYMD(cur);
          const win = shiftWindowForYMD(ymd, scheduleMap);
          if (!win.off){
            const shiftStart = new Date(cur); shiftStart.setHours(win.startH,0,0,0);
            const shiftEnd   = new Date(cur); shiftEnd.setHours(win.endH,0,0,0);
            total += overlapHours(s,e,shiftStart,shiftEnd);
          }
          cur.setDate(cur.getDate()+1);
        }

        total = roundToHalf(total);
        document.getElementById("hours").value = total.toFixed(1);
        return;
      }

      if (cat === "OT"){
        let diff = Math.max(0, (e - s) / (1000*60*60));
        diff = roundToHalf(diff);
        diff = Math.max(0.5, diff);
        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }

      if (cat === "OUTING"){
        const isTrip = document.getElementById("isTrip").checked;
        let diff = Math.max(0, (e - s) / (1000*60*60));
        diff = roundToHalf(diff);
        diff = Math.max(0.5, diff);
        if (!isTrip) diff = Math.min(8, diff);
        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }
    }catch(err){
      // fallback
      if (cat === "LEAVE"){
        let total = 0;
        const cur = new Date(s); cur.setHours(0,0,0,0);
        const endDay = new Date(e); endDay.setHours(0,0,0,0);
        while (cur <= endDay){
          const shiftStart = new Date(cur); shiftStart.setHours(10,0,0,0);
          const shiftEnd   = new Date(cur); shiftEnd.setHours(18,0,0,0);
          total += overlapHours(s,e,shiftStart,shiftEnd);
          cur.setDate(cur.getDate()+1);
        }
        total = roundToHalf(total);
        document.getElementById("hours").value = total.toFixed(1);
      } else {
        const diff = roundToHalf(Math.max(0, (e - s) / (1000*60*60)));
        document.getElementById("hours").value = diff.toFixed(1);
      }
    }
  }

  // ========= é€å‡ºç”³è«‹ =========
  async function submitReq(){
    const btn = document.getElementById("submitBtn");
    const cat = document.getElementById("cat").value;

    btn.disabled = true;
    btn.innerText = "é€å‡ºä¸­...";

    const start = document.getElementById("start").value;
    let end = document.getElementById("end").value;

    // âœ… è£œå¡ï¼šå‰ç«¯ç›´æ¥ä¿éšªï¼ˆé¿å…ä½ å¾Œç«¯é‚„æ²’ä¿®å°±ç‚¸ï¼‰
    if (cat === "CORRECTION"){
      end = start; // å¾Œç«¯è‹¥ä»æª¢æŸ¥ end<=startï¼Œè‡³å°‘ä¸æœƒç©º
    }

    const hours = (cat === "CORRECTION") ? 0 : Number(document.getElementById("hours").value || 0);

    // éè£œå¡ï¼šæ™‚æ•¸å¿…é ˆ >0
    if (cat !== "CORRECTION" && hours <= 0){
      alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
      return;
    }

    const data = {
      category: cat,
      // å¾Œç«¯ç›®å‰æœƒæª¢æŸ¥ leaveTypeï¼Œæ‰€ä»¥è£œå¡ä¹Ÿä¸€å®šè¦å¸¶ correction
      leaveType: (cat === "LEAVE") ? document.getElementById("type").value
              : (cat === "OT") ? "ot"
              : (cat === "OUTING") ? "outing"
              : "correction",
      start,
      end,
      hours,
      reason: document.getElementById("reason").value || "",
      autoClock: (cat === "OUTING") ? !!document.getElementById("autoClock").checked : false,
      isTrip: (cat === "OUTING") ? !!document.getElementById("isTrip").checked : false
    };

    try{
      const res = await api("submit_request", data);
      if(res && res.ok){
        alert("ç”³è«‹æˆåŠŸï¼");
        location.href = "history.html";
      }else{
        alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }catch(e){
      alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
    }
  }

  // âœ… Safari/WebView ä¿®æ­£ï¼šdatetime-local å¸¸ä¸è§¸ç™¼ onchange â†’ å…¨ç¶
  (function bindRecalcEvents(){
    const startEl = document.getElementById("start");
    const endEl   = document.getElementById("end");
    const catEl   = document.getElementById("cat");
    const typeEl  = document.getElementById("type");
    const isTripEl= document.getElementById("isTrip");
    const autoClockEl= document.getElementById("autoClock");

    const safeRecalc = () => { RULES = null; calcHoursSmart(); setTips(); };

    [startEl, endEl].forEach(el=>{
      if (!el) return;
      el.addEventListener("input", safeRecalc);
      el.addEventListener("change", safeRecalc);
      el.addEventListener("blur", safeRecalc);
    });

    [catEl, typeEl, isTripEl, autoClockEl].forEach(el=>{
      if (!el) return;
      el.addEventListener("change", safeRecalc);
      el.addEventListener("input", safeRecalc);
    });
  })();

  document.getElementById("cat").addEventListener("change", toggleType);
  document.getElementById("type").addEventListener("change", () => { RULES=null; calcHoursSmart(); setTips(); });
  document.getElementById("start").addEventListener("change", onTimeChange);
  document.getElementById("end").addEventListener("change", onTimeChange);

  // å•Ÿå‹•
  toggleType();
  calcHoursSmart();
  setTips();
</script>
</body>
</html>
