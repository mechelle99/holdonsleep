<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary:#4F46E5; --bg:#F3F4F6; --card:#FFFFFF; --text:#1F2937; }
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); margin:0; padding:20px 20px 80px; color:var(--text); }
    h2 { font-size:20px; margin:0 0 10px; font-weight:800; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; line-height:1.4; }

    .card { background:var(--card); border-radius:18px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .form-group { margin-bottom:16px; }
    label { display:block; font-size:14px; font-weight:700; margin-bottom:8px; color:#4B5563; }

    input, select, textarea {
      width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB;
      background:#fff; font-size:16px; box-sizing:border-box; -webkit-appearance:none;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
    textarea { resize:vertical; min-height:86px; }

    .row { display:flex; gap:10px; }
    .row > div { flex:1; }

    .chiprow { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
      user-select:none;
    }
    .chip input { width:auto; }

    .mutedBox { background:#F9FAFB; border:1px solid #E5E7EB; padding:12px; border-radius:12px; font-size:13px; color:#6B7280; line-height:1.45; }

    .btn-submit {
      width:100%; background:var(--primary); color:#fff;
      padding:14px; border:none; border-radius:14px;
      font-size:16px; font-weight:800; margin-top:10px; cursor:pointer;
      box-shadow:0 10px 22px rgba(79,70,229,.18);
    }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    .nav {
      position:fixed; bottom:0; left:0; right:0; background:var(--card);
      padding:12px 20px; padding-bottom:max(12px, env(safe-area-inset-bottom));
      display:flex; justify-content:space-around;
      box-shadow:0 -4px 20px rgba(0,0,0,.06);
      border-top-left-radius:24px; border-top-right-radius:24px; z-index:100;
    }
    .nav-item { text-decoration:none; color:#9CA3AF; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
    .nav-item.active { color:var(--primary); }
    .nav-icon { font-size:22px; }

    .hide { display:none !important; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="card">
    <div class="form-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="OUTING">å¤–å‡º</option>
        <option value="CORRECTION">è£œå¡</option>
      </select>
    </div>

    <div class="form-group" id="typeGroup">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="paternity">é™ªç”¢å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <div class="form-group">
      <label id="startLabel">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start">
    </div>

    <div class="form-group" id="endWrap">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end">
    </div>

    <div class="form-group" id="extraGroup" style="display:none;">
      <div class="chiprow">
        <label class="chip"><input type="checkbox" id="isTrip"/> å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
        <label class="chip"><input type="checkbox" id="autoClock"/> å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>

    <div class="form-group" id="hoursGroup">
      <label>æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰</label>
      <input type="number" id="hours" value="0.0" readonly style="background-color:#F3F4F6;">
    </div>

    <div class="form-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <div class="mutedBox" id="tipsBox"></div>

    <button class="btn-submit" id="submitBtn" type="button">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none;"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½ï¼ˆåˆ¥å† employeeId / empId æ‰“æ¶ï¼‰
     * ============================== */
    const empId =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      localStorage.getItem("employeeId".toLowerCase()) ||
      "";

    const isMgr = (localStorage.getItem("isManager") === "true");

    if(isMgr) document.getElementById("mgrBtn").style.display = "flex";
    if(!empId) location.href = "index.html";

    /* ==============================
     * 1) JSONP APIï¼ˆaction + payloadï¼‰
     * ============================== */
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        if(!window.CONFIG || !window.CONFIG.GAS_ENDPOINT){
          reject(new Error("Missing CONFIG.GAS_ENDPOINT"));
          return;
        }

        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1000000);
        const s = document.createElement("script");

        const payloadObj = Object.assign({}, data, { empId });

        // âœ… è‹¥å¾Œç«¯æœ‰é©—è­‰ keyï¼Œå¯ä¸€èµ·å¸¶ï¼ˆä¸ä¸€å®šç”¨å¾—åˆ°ï¼Œä½†ä¿éšªï¼‰
        if(window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null){
          payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
        }

        const payload = encodeURIComponent(JSON.stringify(payloadObj));
        s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("timeout"));
        }, 15000);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          try { s.remove(); } catch(e){}
        }

        window[cbName] = (res) => { cleanup(); resolve(res); };
        s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
        document.body.appendChild(s);
      });
    }

    /* ==============================
     * 2) æœ¬åœ°æ™‚é–“å·¥å…·ï¼ˆæœçµ•å‡Œæ™¨è®Šéš”å¤©ï¼‰
     * ============================== */
    function pad2(n){ return String(n).padStart(2,'0'); }
    function toLocalInputValue(d){
      // datetime-local è¦ yyyy-MM-ddTHH:mmï¼ˆæœ¬åœ°ï¼‰
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }
    function localYMD(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    /* ==============================
     * 3) åŠå°æ™‚è¦å‰‡
     * ============================== */
    function roundToHalf(h){
      return Math.round(h * 2) / 2;
    }
    function sameDay_(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    /* ==============================
     * 4) UI æç¤º
     * ============================== */
    const tipsBox = document.getElementById("tipsBox");
    function setTips(){
      const cat = document.getElementById("cat").value;
      const type = document.getElementById("type").value;

      let msg = "";
      if (cat === "CORRECTION"){
        msg = "âœ… è£œå¡ï¼šåªéœ€é¸æ“‡ã€Œè£œå¡æ™‚é–“é»ã€ï¼Œä¸éœ€è¦çµæŸæ™‚é–“ï¼›æ™‚æ•¸å›ºå®šç‚º 0ã€‚";
      } else if (cat === "OUTING"){
        msg = "âœ… å¤–å‡ºï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰ï¼Œéå‡ºå·®æœ€å¤š 8 å°æ™‚ï¼›å¯å‹¾é¸ã€Œå¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡ã€ã€‚";
      } else if (cat === "OT"){
        msg = "âœ… åŠ ç­ï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰ï¼Œæ ¸å‡†å¾Œå¯è½‰è£œä¼‘ã€‚";
      } else {
        msg = "âœ… è«‹å‡ï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰ï¼›ç”Ÿæ—¥å‡ä¸å¯è·¨æ—¥ã€‚";
        if (type === "birthday") msg += "ï¼ˆä½ ç¾åœ¨é¸çš„æ˜¯ç”Ÿæ—¥å‡ï¼‰";
      }
      tipsBox.textContent = msg;
    }

    /* ==============================
     * 5) é¡å‹åˆ‡æ›ï¼ˆè£œå¡ç‰¹è¦ï¼‰
     * ============================== */
    function toggleType(){
      const cat = document.getElementById("cat").value;
      const typeGroup = document.getElementById("typeGroup");
      const hoursGroup = document.getElementById("hoursGroup");
      const endWrap = document.getElementById("endWrap");
      const extraGroup = document.getElementById("extraGroup");
      const startLabel = document.getElementById("startLabel");

      if (cat === "CORRECTION"){
        typeGroup.style.display = "none";
        hoursGroup.style.display = "none";
        endWrap.style.display = "none";
        extraGroup.style.display = "none";
        startLabel.textContent = "è£œå¡æ™‚é–“";
        document.getElementById("hours").value = "0.0";
        document.getElementById("end").value = "";
      } else if (cat === "OUTING"){
        typeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "block";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      } else if (cat === "OT"){
        typeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      } else { // LEAVE
        typeGroup.style.display = "block";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
        calcHoursSmart();
      }

      setTips();
    }

    /* ==============================
     * 6) æ™‚æ•¸è¨ˆç®—ï¼ˆçµ±ä¸€ 0.5 å°æ™‚ã€å«ç”Ÿæ—¥å‡é˜²å‘†ï¼‰
     * ============================== */
    function calcHoursSmart(){
      const cat = document.getElementById("cat").value;
      if (cat === "CORRECTION"){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(!sVal || !eVal) return;

      const s = new Date(sVal);
      const e = new Date(eVal);

      if(e < s){
        document.getElementById("end").value = sVal;
        document.getElementById("hours").value = "0.0";
        return;
      }
      if(e <= s){
        document.getElementById("hours").value = "0.0";
        return;
      }

      // ç”Ÿæ—¥å‡ä¸å¯è·¨æ—¥
      const leaveType = document.getElementById("type")?.value || "";
      if(cat==="LEAVE" && leaveType==="birthday" && !sameDay_(s,e)){
        document.getElementById("end").value = sVal;
        document.getElementById("hours").value = "0.0";
        return;
      }

      let diff = (e - s) / (1000*60*60); // å°æ™‚
      diff = roundToHalf(diff);
      diff = Math.max(0.5, diff);

      if(cat==="OUTING"){
        const isTrip = !!document.getElementById("isTrip").checked;
        if(!isTrip) diff = Math.min(8, diff);
      }

      document.getElementById("hours").value = diff.toFixed(1);
    }

    /* ==============================
     * 7) é€å‡ºç”³è«‹ï¼ˆè£œå¡ end=start ä¿éšªï¼‰
     * ============================== */
    async function submitReq(){
      const btn = document.getElementById("submitBtn");
      const cat = document.getElementById("cat").value;

      btn.disabled = true;
      btn.innerText = "é€å‡ºä¸­...";

      const start = document.getElementById("start").value;
      let end = document.getElementById("end").value;

      if(!start){
        alert("è«‹å…ˆé¸æ“‡é–‹å§‹æ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      if(cat==="CORRECTION"){
        end = start;
      }else{
        if(!end){
          alert("è«‹å…ˆé¸æ“‡çµæŸæ™‚é–“");
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
          return;
        }
      }

      const hours = (cat === "CORRECTION") ? 0 : Number(document.getElementById("hours").value || 0);

      if(cat !== "CORRECTION" && hours <= 0){
        alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const data = {
        category: cat,
        leaveType:
          (cat === "LEAVE") ? document.getElementById("type").value :
          (cat === "OT") ? "ot" :
          (cat === "OUTING") ? "outing" : "correction",
        start,
        end,
        hours,
        reason: document.getElementById("reason").value || "",
        autoClock: (cat === "OUTING") ? !!document.getElementById("autoClock").checked : false,
        isTrip: (cat === "OUTING") ? !!document.getElementById("isTrip").checked : false
      };

      try{
        const res = await api("submit_request", data);
        if(res && res.ok){
          alert("ç”³è«‹æˆåŠŸï¼");
          location.href = "history.html";
        }else{
          alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
        }
      }catch(e){
        alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }

    /* ==============================
     * 8) ç¶å®šäº‹ä»¶ï¼ˆSafari/LINE WebView é˜²é›·ï¼‰
     * ============================== */
    (function bindAll(){
      const startEl = document.getElementById("start");
      const endEl   = document.getElementById("end");
      const catEl   = document.getElementById("cat");
      const typeEl  = document.getElementById("type");
      const isTripEl= document.getElementById("isTrip");
      const autoClockEl= document.getElementById("autoClock");
      const submitBtn = document.getElementById("submitBtn");

      const safeRecalc = () => { calcHoursSmart(); setTips(); };

      [startEl, endEl].forEach(el=>{
        if (!el) return;
        el.addEventListener("input", safeRecalc);
        el.addEventListener("change", safeRecalc);
        el.addEventListener("blur", safeRecalc);
      });

      [catEl, typeEl, isTripEl, autoClockEl].forEach(el=>{
        if (!el) return;
        el.addEventListener("change", ()=>{ toggleType(); safeRecalc(); });
        el.addEventListener("input", safeRecalc);
      });

      submitBtn.addEventListener("click", submitReq);
    })();

    /* ==============================
     * 9) åˆå§‹åŒ–é è¨­æ™‚é–“ï¼ˆæœ¬åœ°ï¼Œä¸ç”¨ toISOStringï¼‰
     *    - é è¨­ï¼šä»Šå¤© 10:00-18:00
     * ============================== */
    (function initDefaultTime(){
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0, 0);
      const end  = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0, 0);
      document.getElementById("start").value = toLocalInputValue(base);
      document.getElementById("end").value   = toLocalInputValue(end);
    })();

    // å•Ÿå‹•
    toggleType();
    calcHoursSmart();
    setTips();
  </script>
</body>
</html>
