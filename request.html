<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”³è«‹ä½œæ¥­</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; padding: 20px; }
    .header { display: flex; justify-content: space-between; margin-bottom: 20px; }
    button { padding: 8px 15px; background: #333; color: #fff; border: none; border-radius: 6px; }
    .card { background: white; padding: 20px; border-radius: 12px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size:16px; }
    .btn-submit { width: 100%; background: #007aff; color: white; padding: 12px; font-size: 16px; border: none; border-radius: 8px; margin-top: 10px; }
  </style>
</head>
<body>

<div class="header">
  <h2>ğŸ“ æå‡ºç”³è«‹</h2>
  <button onclick="location.href='app.html'">è¿”å›</button>
</div>

<div class="card">
  <div class="form-group">
    <label>ç”³è«‹é¡åˆ¥</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="CORRECTION">è£œå¡</option>
      <option value="OUTING">å¤–å‡º (è‡ªå‹•æ‰“å¡)</option>
    </select>
  </div>

  <div class="form-group" id="typeGrp">
    <label>å‡åˆ¥</label>
    <select id="type">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="sick">ç—…å‡</option>
      <option value="personal">äº‹å‡</option>
      <option value="official">å…¬å‡</option>
    </select>
  </div>

  <div class="form-group">
    <label id="startLbl">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start">
  </div>

  <div class="form-group" id="endGrp">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcHours()">
  </div>
  
  <div class="form-group" id="hrsGrp">
    <label>æ™‚æ•¸</label>
    <input type="number" id="hours" step="0.5" placeholder="è‡ªå‹•è¨ˆç®—">
  </div>

  <div class="form-group">
    <label>èªªæ˜</label>
    <input type="text" id="reason">
  </div>

  <button class="btn-submit" onclick="submit()">é€å‡º</button>
</div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");

  function uiChange() {
      const c = document.getElementById("cat").value;
      const type = document.getElementById("type");
      const end = document.getElementById("endGrp");
      const hrs = document.getElementById("hrsGrp");
      const lbl = document.getElementById("startLbl");
      
      // é‡ç½®
      document.getElementById("typeGrp").style.display = 'block';
      end.style.display = 'block';
      hrs.style.display = 'block';
      lbl.innerText = 'é–‹å§‹æ™‚é–“';

      if(c === 'CORRECTION') {
          // è£œå¡ï¼šéš±è—çµæŸæ™‚é–“ã€æ™‚æ•¸
          end.style.display = 'none';
          hrs.style.display = 'none';
          lbl.innerText = 'è£œå¡æ™‚é–“';
          type.innerHTML = '<option value="IN">ä¸Šç­å¡</option><option value="OUT">ä¸‹ç­å¡</option>';
      } else if(c === 'OUTING') {
          // å¤–å‡ºï¼šéš±è—å‡åˆ¥ã€çµæŸæ™‚é–“ã€æ™‚æ•¸
          document.getElementById("typeGrp").style.display = 'none';
          end.style.display = 'none';
          hrs.style.display = 'none';
          lbl.innerText = 'å¤–å‡ºæ™‚é–“ (é è¨­ç¾åœ¨)';
      } else {
          // æ¢å¾©å‡åˆ¥
          type.innerHTML = '<option value="annual">ç‰¹ä¼‘</option><option value="comp">è£œä¼‘</option><option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option>';
      }
  }

  function calcHours() {
      const s = new Date(document.getElementById("start").value);
      const e = new Date(document.getElementById("end").value);
      if(s && e && e > s) {
          document.getElementById("hours").value = ((e - s) / 36e5).toFixed(1);
      }
  }

  function api(act, d={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function submit() {
      const cat = document.getElementById("cat").value;
      const start = document.getElementById("start").value;
      
      if(cat !== 'OUTING' && !start) { alert("è«‹å¡«å¯«æ™‚é–“"); return; }

      const btn = document.querySelector(".btn-submit");
      btn.innerText = "è™•ç†ä¸­...";
      btn.disabled = true;

      const res = await api("submit_request", {
          category: cat,
          leaveType: document.getElementById("type").value,
          start: start,
          end: document.getElementById("end").value || start,
          hours: document.getElementById("hours").value || 0,
          reason: document.getElementById("reason").value
      });
      alert(res.message);
      location.href='app.html';
  }
  
  uiChange();
</script>
</body>
</html>
