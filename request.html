<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; --danger:#EF4444; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }
    h2 { font-size: 20px; margin-bottom: 20px; font-weight: 700; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #4B5563; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #fff; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    textarea { resize: vertical; min-height: 80px; }

    .hint { font-size: 12px; color:#6B7280; margin-top:8px; line-height:1.4; }
    .error { font-size: 12px; color: var(--danger); margin-top:8px; display:none; }

    .btn-submit { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }

    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="form-group">
    <label>ç”³è«‹é¡å‹</label>
    <select id="cat">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡º</option>
      <option value="CORRECTION">è£œå¡</option>
    </select>
    <div class="hint">â€» åŠ ç­æœƒè‡ªå‹•è½‰ç‚ºè£œä¼‘æ™‚æ•¸ï¼›è£œå¡ä¸éœ€è¦å¡«çµæŸæ™‚é–“èˆ‡æ™‚æ•¸</div>
  </div>

  <div class="form-group" id="typeGroup">
    <label>å‡åˆ¥</label>
    <select id="type">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="personal">äº‹å‡</option>
      <option value="sick">ç—…å‡</option>
      <option value="official">å…¬å‡</option>
      <option value="marriage">å©šå‡</option>
      <option value="bereavement">å–ªå‡</option>
      <option value="menstrual">ç”Ÿç†å‡</option>
      <option value="maternity">ç”¢å‡</option>
      <option value="paternity">é™ªç”¢å‡</option>
      <option value="family">å®¶åº­ç…§é¡§å‡</option>
      <option value="birthday">ç”Ÿæ—¥å‡</option>
    </select>
  </div>

  <div class="form-group" id="startWrap">
    <label>é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start">
  </div>

  <div class="form-group" id="endWrap">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end">
    <div class="error" id="timeErr">çµæŸæ™‚é–“ä¸èƒ½å°æ–¼é–‹å§‹æ™‚é–“ï¼ˆå·²è‡ªå‹•ä¿®æ­£ï¼‰</div>
  </div>

  <div class="form-group" id="hoursGroup">
    <label>æ™‚æ•¸ (è‡ªå‹•è¨ˆç®—)</label>
    <input type="number" id="hours" value="0" readonly style="background-color: #F3F4F6;">
  </div>

  <div class="form-group">
    <label>äº‹ç”±</label>
    <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
  </div>

  <button class="btn-submit" id="submitBtn">é€å‡ºç”³è«‹</button>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  const $ = (id) => document.getElementById(id);

  // --- Date helpers ---
  function pad2(n){ return String(n).padStart(2,'0'); }
  function toLocalInputValue(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function parseLocalInput(v){
    // v: "YYYY-MM-DDTHH:mm"
    if (!v) return null;
    const d = new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  // --- UI state ---
  let lastWarnAt = 0;
  function showTimeWarnOnce(){
    const now = Date.now();
    if (now - lastWarnAt < 1200) return; // 1.2s å…§ä¸è¦é€£å™´
    lastWarnAt = now;
    $("timeErr").style.display = 'block';
    setTimeout(()=>{ $("timeErr").style.display = 'none'; }, 1600);
  }

  function enforceEndNotBeforeStart(fix=true){
    const cat = $("cat").value;

    // è£œå¡ï¼šä¸éœ€è¦ end
    if (cat === 'CORRECTION') {
      $("end").value = $("start").value || $("end").value;
      $("end").min = $("start").value || "";
      return true;
    }

    const sVal = $("start").value;
    if (sVal) $("end").min = sVal; // âœ… è®“ picker ç›´æ¥ä¸èƒ½é¸æ›´æ—©

    const s = parseLocalInput(sVal);
    const e = parseLocalInput($("end").value);

    if (!s || !e) return true;
    if (e < s) {
      if (fix) {
        $("end").value = sVal; // âœ… è‡ªå‹•ä¿®æ­£
        showTimeWarnOnce();
      }
      return false;
    }
    return true;
  }

  function calcHours(){
    const cat = $("cat").value;
    if (cat === 'CORRECTION') { $("hours").value = 0; return; }

    enforceEndNotBeforeStart(true);

    const s = parseLocalInput($("start").value);
    const e = parseLocalInput($("end").value);
    if (!s || !e) { $("hours").value = 0; return; }

    const diffHrs = (e - s) / (1000 * 60 * 60);
    $("hours").value = diffHrs > 0 ? diffHrs.toFixed(1) : 0;
  }

  function toggleType(){
    const cat = $("cat").value;

    const typeGroup = $("typeGroup");
    const hoursGroup = $("hoursGroup");
    const endWrap = $("endWrap");

    if (cat === 'CORRECTION') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'none';
      endWrap.style.display = 'none';

      // âœ… è£œå¡ï¼šend=start, hours=0
      if ($("start").value) $("end").value = $("start").value;
      $("hours").value = 0;
      enforceEndNotBeforeStart(true);

    } else if (cat === 'OUTING') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      enforceEndNotBeforeStart(true);
      calcHours();

    } else if (cat === 'OT') {
      // âœ… åŠ ç­ï¼šä¸é¡¯ç¤ºå‡åˆ¥ï¼Œå¼·åˆ¶ comp
      typeGroup.style.display = 'none';
      $("type").value = 'comp';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      enforceEndNotBeforeStart(true);
      calcHours();

    } else { // LEAVE
      typeGroup.style.display = 'block';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      enforceEndNotBeforeStart(true);
      calcHours();
    }
  }

  // --- API(JSONP) ---
  function api(act, d={}) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      const s = document.createElement("script");
      const payload = encodeURIComponent(JSON.stringify({...d, userId:uid}));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(act)}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout"));
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        try { s.remove(); } catch(e){}
      }

      window[cbName] = (res) => {
        cleanup();
        resolve(res);
      };
      s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
      document.body.appendChild(s);
    });
  }

  // --- Submit ---
  async function submit(){
    const btn = $("submitBtn");
    const cat = $("cat").value;

    // âœ… æœ€å¾Œé˜²ç·šï¼šæ ¡æ­£æ™‚é–“
    enforceEndNotBeforeStart(true);
    calcHours();

    const data = {
      category: cat,
      leaveType: (cat === 'LEAVE') ? $("type").value
              : (cat === 'OT') ? 'comp'
              : '',
      start: $("start").value,
      end: (cat === 'CORRECTION') ? $("start").value : $("end").value,
      hours: (cat === 'CORRECTION') ? 0 : Number($("hours").value || 0),
      reason: $("reason").value
    };

    // âœ… ç¡¬é©—è­‰ï¼šéè£œå¡ä¸€å®šè¦ end>=start ä¸” hours>0
    if (cat !== 'CORRECTION') {
      const s = parseLocalInput(data.start);
      const e = parseLocalInput(data.end);
      if (!s || !e || e < s) {
        alert("éŒ¯èª¤ï¼šçµæŸæ™‚é–“ä¸èƒ½å°æ–¼é–‹å§‹æ™‚é–“");
        return;
      }
      if (!(data.hours > 0)) {
        alert("éŒ¯èª¤ï¼šæ™‚æ•¸å¿…é ˆå¤§æ–¼ 0ï¼ˆè«‹ç¢ºèªæ™‚é–“å€é–“ï¼‰");
        return;
      }
    }

    btn.disabled = true;
    btn.innerText = "é€å‡ºä¸­...";

    try {
      const res = await api("submit_request", data);
      if (res && res.ok) {
        alert("ç”³è«‹æˆåŠŸï¼");
        location.href = "history.html";
      } else {
        alert("å¤±æ•—: " + ((res && res.message) || "æœªçŸ¥éŒ¯èª¤"));
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    } catch(e) {
      alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
    }
  }

  // --- Init defaults ---
  (function init(){
    // é è¨­ï¼šä»Šå¤© 09:00 - 18:00ï¼ˆç”¨æœ¬åœ°æ™‚é–“çµ„å­—ä¸²ï¼Œé¿å…æ™‚å€åç§»ï¼‰
    const now = new Date();
    const s = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0);
    const e = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0);
    $("start").value = toLocalInputValue(s);
    $("end").value = toLocalInputValue(e);

    // ç¶äº‹ä»¶ï¼šç”¨ input æ¯” onchange æ›´å³æ™‚ï¼ˆSafari ä¹Ÿè¼ƒç©©ï¼‰
    $("cat").addEventListener("change", toggleType);

    $("start").addEventListener("change", () => { enforceEndNotBeforeStart(true); calcHours(); });
    $("start").addEventListener("input",  () => { enforceEndNotBeforeStart(true); calcHours(); });

    $("end").addEventListener("change", () => { enforceEndNotBeforeStart(true); calcHours(); });
    $("end").addEventListener("input",  () => { enforceEndNotBeforeStart(true); calcHours(); });

    $("submitBtn").addEventListener("click", submit);

    // å…ˆè·‘ä¸€æ¬¡
    toggleType();
    enforceEndNotBeforeStart(true);
    calcHours();
  })();
</script>
</body>
</html>
