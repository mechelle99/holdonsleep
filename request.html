<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }
    h2 { font-size: 20px; margin-bottom: 12px; font-weight: 700; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #4B5563; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #fff; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    textarea { resize: vertical; min-height: 80px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff; }
    .chip input { width:auto; }
    .btn-submit { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>
  <p class="hint">è«‹å‡æœƒç”¨ã€Œå·¥ä½œæ—¥ Ã— 8 å°æ™‚ã€æˆ–ã€Œæ’ç­è¡¨ã€è‡ªå‹•æ›ç®—ï¼›åŠ ç­/å¤–å‡ºç”¨å¯¦éš›å€é–“ä¸¦å¥—ç”¨ä¼‘æ¯è¦å‰‡ã€‚</p>

  <div class="form-group">
    <label>ç”³è«‹é¡å‹</label>
    <select id="cat" onchange="toggleType()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡º</option>
      <option value="CORRECTION">è£œå¡</option>
    </select>
  </div>

  <div class="form-group" id="typeGroup">
    <label>å‡åˆ¥</label>
    <select id="type" onchange="calcHoursSmart()">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="personal">äº‹å‡</option>
      <option value="sick">ç—…å‡</option>
      <option value="official">å…¬å‡</option>
      <option value="marriage">å©šå‡</option>
      <option value="bereavement">å–ªå‡</option>
      <option value="menstrual">ç”Ÿç†å‡</option>
      <option value="maternity">ç”¢å‡</option>
      <option value="paternity">é™ªç”¢å‡</option>
      <option value="family">å®¶åº­ç…§é¡§å‡</option>
      <option value="birthday">ç”Ÿæ—¥å‡</option>
    </select>
  </div>

  <div class="form-group">
    <label>é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start" onchange="onTimeChange()">
  </div>

  <div class="form-group" id="endGroup">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="onTimeChange()">
  </div>

  <div class="form-group" id="extraGroup" style="display:none;">
    <div class="row">
      <div class="chip">
        <input type="checkbox" id="isTrip" onchange="calcHoursSmart()"/>
        <label for="isTrip" style="margin:0;">å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
      </div>
      <div class="chip">
        <input type="checkbox" id="autoClock" />
        <label for="autoClock" style="margin:0;">å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>
  </div>

  <div class="form-group" id="hoursGroup">
    <label>æ™‚æ•¸ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
    <input type="number" id="hours" value="0" readonly style="background-color: #F3F4F6;">
  </div>

  <div class="form-group">
    <label>äº‹ç”±</label>
    <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
  </div>

  <button class="btn-submit" id="submitBtn" onclick="submitReq()">é€å‡ºç”³è«‹</button>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  // ======== JSONP API (å« timeoutï¼Œé¿å…ã€Œé€å‡ºä¸­å¡ä½ã€) ========
  function api(act, d={}) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      const s = document.createElement("script");

      const payload = encodeURIComponent(JSON.stringify({...d, userId: uid}));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        try { s.remove(); } catch(e){}
      }

      window[cbName] = (res) => { cleanup(); resolve(res); };
      s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
      document.body.appendChild(s);
    });
  }

  // ======== æ™‚æ•¸æ›ç®—æ ¸å¿ƒï¼šè¦å‰‡è³‡æ–™å¿«å– ========
  let RULES = null; // { holidays:Set, scheduleMap:{'yyyy-mm-dd':'EARLY|LATE|OFF'} }
  async function ensureRules(){
    if (RULES) return RULES;
    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value || sVal;
    const res = await api("get_rules", { start: sVal, end: eVal });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "get_rules failed");
    RULES = {
      holidays: new Set(res.holidays || []),
      scheduleMap: res.scheduleMap || {}
    };
    return RULES;
  }

  // ======== åˆå§‹åŒ–æ™‚é–“ï¼šä»Šå¤© 09:00-18:00 ========
  const now = new Date();
  const ymd = now.toISOString().split('T')[0];
  document.getElementById("start").value = `${ymd}T09:00`;
  document.getElementById("end").value   = `${ymd}T18:00`;

  // ======== UI toggle ========
  function toggleType() {
    const cat = document.getElementById("cat").value;
    const typeGroup = document.getElementById("typeGroup");
    const hoursGroup = document.getElementById("hoursGroup");
    const endGroup = document.getElementById("endGroup");
    const extraGroup = document.getElementById("extraGroup");

    RULES = null;

    if (cat === 'CORRECTION') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'none';
      endGroup.style.display = 'none';
      extraGroup.style.display = 'none';
      const sVal = document.getElementById("start").value;
      if (sVal) document.getElementById("end").value = sVal;
      document.getElementById("hours").value = 0;
    } else if (cat === 'OUTING') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      extraGroup.style.display = 'block';
      calcHoursSmart();
    } else if (cat === 'OT') {
      typeGroup.style.display = 'none';
      extraGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      calcHoursSmart();
    } else {
      typeGroup.style.display = 'block';
      extraGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      calcHoursSmart();
    }
  }

  function onTimeChange(){
    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (sVal && eVal) {
      const s = new Date(sVal);
      const e = new Date(eVal);
      if (e < s) document.getElementById("end").value = sVal;
    }
    RULES = null;
    calcHoursSmart();
  }

  // ======== å·¥å…·ï¼šæ—¥æœŸ/å€é–“ ========
  function toYMD(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function isWeekend(d){ const w = d.getDay(); return w===0 || w===6; }

  // æ‰£åˆä¼‘ï¼šè¦å‰‡ï¼ˆä½ è¦æ”¹åˆä¼‘æ™‚æ®µå°±æ”¹é€™è£¡ï¼‰
  function breakDeductionHours(s, e){
    const b1s = new Date(s); b1s.setHours(12,0,0,0);
    const b1e = new Date(s); b1e.setHours(13,0,0,0);
    const overlap = Math.max(0, Math.min(e, b1e) - Math.max(s, b1s));
    return overlap > 0 ? 1 : 0;
  }

  // ======== æ ¸å¿ƒï¼šæ™ºèƒ½ç®—æ™‚æ•¸ ========
  async function calcHoursSmart(){
    const cat = document.getElementById("cat").value;
    if (cat === 'CORRECTION') return;

    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (!sVal || !eVal) return;

    const s = new Date(sVal);
    const e = new Date(eVal);

    if (e <= s){
      document.getElementById("hours").value = 0;
      return;
    }

    try{
      // âœ…âœ…âœ… ä¿® BUGï¼šè«‹å‡ç”¨ã€Œæ—¥æœŸã€ç®—å¤©æ•¸ï¼Œend=00:00 ä¸å¤šç®—ä¸€å¤©
      if (cat === 'LEAVE'){
        const rules = await ensureRules();

        let total = 0;

        const s0 = new Date(s); s0.setHours(0,0,0,0);
        const e0 = new Date(e); e0.setHours(0,0,0,0);

        const endHasTime = !(e.getHours() === 0 && e.getMinutes() === 0 && e.getSeconds() === 0);
        const lastDay = new Date(e0);
        if (!endHasTime) {
          lastDay.setDate(lastDay.getDate() - 1);
        }

        if (lastDay < s0){
          document.getElementById("hours").value = (0).toFixed(1);
          return;
        }

        const cur = new Date(s0);
        while (cur <= lastDay){
          const ymd = toYMD(cur);
          const isHol = rules.holidays.has(ymd);
          const shift = (rules.scheduleMap[ymd] || "").toUpperCase();
          const offBySch = (shift.includes("OFF") || shift.includes("ä¼‘"));
          const off = isHol || isWeekend(cur) || offBySch;

          if (!off) total += 8;

          cur.setDate(cur.getDate()+1);
        }

        document.getElementById("hours").value = total.toFixed(1);
        return;
      }

      // åŠ ç­ï¼šå¯¦éš›å€é–“ - æ‰£åˆä¼‘
      if (cat === 'OT'){
        let diff = (e - s) / (1000*60*60);
        diff -= breakDeductionHours(s, e);
        diff = Math.max(0, diff);
        diff = Math.max(0.5, Math.round(diff * 2) / 2);
        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }

      // å¤–å‡ºï¼šå¯¦éš›å€é–“ - æ‰£åˆä¼‘ï¼›æœ€å° 0.5ï¼›æœ€å¤š 8ï¼ˆå‡ºå·®é™¤å¤–ï¼‰
      if (cat === 'OUTING'){
        const isTrip = document.getElementById("isTrip").checked;
        let diff = (e - s) / (1000*60*60);
        diff -= breakDeductionHours(s, e);
        diff = Math.max(0, diff);

        diff = Math.round(diff * 2) / 2;
        diff = Math.max(0.5, diff);

        if (!isTrip) diff = Math.min(8, diff);

        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }
    }catch(err){
      // fallbackï¼ˆä¿å®ˆï¼‰
      if (cat === 'LEAVE'){
        let total = 0;

        const s0 = new Date(s); s0.setHours(0,0,0,0);
        const e0 = new Date(e); e0.setHours(0,0,0,0);

        const endHasTime = !(e.getHours() === 0 && e.getMinutes() === 0 && e.getSeconds() === 0);
        const lastDay = new Date(e0);
        if (!endHasTime) lastDay.setDate(lastDay.getDate() - 1);

        if (lastDay < s0){
          document.getElementById("hours").value = (0).toFixed(1);
          return;
        }

        const cur = new Date(s0);
        while(cur <= lastDay){
          if(!isWeekend(cur)) total += 8;
          cur.setDate(cur.getDate()+1);
        }
        document.getElementById("hours").value = total.toFixed(1);
      } else {
        const diff = Math.max(0, (e - s) / (1000*60*60));
        document.getElementById("hours").value = diff.toFixed(1);
      }
    }
  }

  // ======== é€å‡º ========
  async function submitReq(){
    const btn = document.getElementById("submitBtn");
    const cat = document.getElementById("cat").value;

    btn.disabled = true;
    btn.innerText = "é€å‡ºä¸­...";

    const start = document.getElementById("start").value;
    const end = (cat === 'CORRECTION') ? start : document.getElementById("end").value;
    const hours = (cat === 'CORRECTION') ? 0 : Number(document.getElementById("hours").value || 0);

    if (cat !== 'CORRECTION' && hours <= 0){
      alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
      return;
    }

    const data = {
      category: cat,
      leaveType: (cat === 'LEAVE') ? document.getElementById("type").value : (cat === 'OT') ? 'comp' : '',
      start, end,
      hours,
      reason: document.getElementById("reason").value || "",
      autoClock: (cat === 'OUTING') ? (document.getElementById("autoClock").checked ? true : false) : false,
      isTrip: (cat === 'OUTING') ? (document.getElementById("isTrip").checked ? true : false) : false
    };

    try{
      const res = await api("submit_request", data);
      if(res && res.ok){
        alert("ç”³è«‹æˆåŠŸï¼");
        location.href = "history.html";
      }else{
        alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }catch(e){
      alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
    }
  }

  toggleType();
  calcHoursSmart();
</script>
</body>
</html>
