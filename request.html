<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary:#4F46E5; --bg:#F3F4F6; --card:#FFFFFF; --text:#1F2937; }
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); margin:0; padding:20px 20px 80px; color:var(--text); }
    h2 { font-size:20px; margin:0 0 10px; font-weight:800; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; line-height:1.4; }

    .card { background:var(--card); border-radius:18px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .form-group { margin-bottom:16px; }
    label { display:block; font-size:14px; font-weight:700; margin-bottom:8px; color:#4B5563; }

    input, select, textarea {
      width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB;
      background:#fff; font-size:16px; box-sizing:border-box; -webkit-appearance:none;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
    textarea { resize:vertical; min-height:86px; }

    .chiprow { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
      user-select:none;
    }
    .chip input { width:auto; }

    .noteBox{
      background:#F9FAFB; border:1px solid #E5E7EB; padding:12px; border-radius:12px;
      font-size:13px; color:#6B7280; line-height:1.45;
    }

    .btn-submit {
      width:100%; background:var(--primary); color:#fff;
      padding:14px; border:none; border-radius:14px;
      font-size:16px; font-weight:800; margin-top:10px; cursor:pointer;
      box-shadow:0 10px 22px rgba(79,70,229,.18);
    }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    .nav {
      position:fixed; bottom:0; left:0; right:0; background:var(--card);
      padding:12px 20px; padding-bottom:max(12px, env(safe-area-inset-bottom));
      display:flex; justify-content:space-around;
      box-shadow:0 -4px 20px rgba(0,0,0,.06);
      border-top-left-radius:24px; border-top-right-radius:24px; z-index:100;
    }
    .nav-item { text-decoration:none; color:#9CA3AF; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
    .nav-item.active { color:var(--primary); }
    .nav-icon { font-size:22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="card">
    <div class="form-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="OUTING">å¤–å‡º</option>
        <option value="CORRECTION">è£œå¡</option>
      </select>
    </div>

    <div class="form-group" id="typeGroup">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="paternity">é™ªç”¢å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <div class="form-group" id="correctionTypeGroup" style="display:none;">
      <label>è£œå¡é¡å‹</label>
      <select id="correctionType">
        <option value="IN">è£œä¸Šç­ï¼ˆè£œæ‰“å¡ï¼šä¸Šç­ï¼‰</option>
        <option value="OUT">è£œä¸‹ç­ï¼ˆè£œæ‰“å¡ï¼šä¸‹ç­ï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label id="startLabel">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start">
    </div>

    <div class="form-group" id="endWrap">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end">
    </div>

    <div class="form-group" id="extraGroup" style="display:none;">
      <div class="chiprow">
        <label class="chip"><input type="checkbox" id="isTrip"/> å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
        <label class="chip"><input type="checkbox" id="autoClock"/> å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>

    <div class="form-group" id="hoursGroup">
      <label>æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰</label>
      <input type="number" id="hours" value="0.0" readonly style="background-color:#F3F4F6;">
    </div>

    <div class="form-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <div class="noteBox" id="noteBox"></div>

    <button class="btn-submit" id="submitBtn" type="button">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none;"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½
     * ============================== */
    const empId =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      "";

    const userId =
      localStorage.getItem("lineUserId") ||
      localStorage.getItem("LineUserId") ||
      localStorage.getItem("userId") ||
      "";

    const uid = empId || userId || "";

    const isMgr = (localStorage.getItem("isManager") === "true") || !!localStorage.getItem("managerId");
    if (isMgr) document.getElementById("mgrBtn").style.display = "flex";
    if (!uid) location.href = "index.html";

    /* ==============================
     * 1) JSONP API
     * ============================== */
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        const ENDPOINT = window.CONFIG && (window.CONFIG.GAS_ENDPOINT || window.CONFIG.API_BASE || window.CONFIG.API_URL);
        if (!ENDPOINT) {
          reject(new Error("Missing CONFIG.GAS_ENDPOINT"));
          return;
        }

        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 1000000);
        const s = document.createElement("script");

        const payloadObj = Object.assign({}, data, {
          empId: empId || undefined,
          userId: userId || undefined
        });

        if (window.CONFIG && window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null) {
          payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
        }

        const payload = encodeURIComponent(JSON.stringify(payloadObj));
        const sep = ENDPOINT.includes("?") ? "&" : "?";
        s.src = `${ENDPOINT}${sep}action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("timeout"));
        }, 15000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cbName]; } catch (e) {}
          try { s.remove(); } catch (e) {}
        }

        window[cbName] = (res) => { cleanup(); resolve(res); };
        s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
        document.body.appendChild(s);
      });
    }

    /* ==============================
     * 2) æ™‚é–“å·¥å…·ï¼ˆâœ… ä¿®æ­£ï¼šdatetime-local ä¸€å¾‹æ‰‹å‹•è§£æï¼Œé¿å… Safari/æ™‚å€ç‚¸è£‚ï¼‰
     * ============================== */
    function pad2(n) { return String(n).padStart(2, '0'); }

    function toLocalInputValue(d) {
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    // âœ… æ›´å¯¬é¬†ï¼šå…è¨± 1~2 ä½ï¼ˆå°‘æ•¸ç’°å¢ƒå¯èƒ½åå‡º 2026-2-9T8:05ï¼‰
    function parseLocalInput(v){
      if(!v) return null;
      const m = String(v).match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]), hh = Number(m[4]), mm = Number(m[5]);
      const dt = new Date(y, mo-1, d, hh, mm, 0, 0);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function sameDay_(a, b) {
      return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
    }

    // Date -> "yyyy/MM/dd HH:mm" çµ¦å¾Œç«¯ï¼ˆä¸å«æ™‚å€ï¼‰
    function toServerDateTimeStr_(d){
      return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    // âœ… å‰ç«¯å‚™æ´ï¼š0.5 å°æ™‚å–®ä½ï¼ˆç•¶å¾Œç«¯ calc_hours æ›æ‰æ™‚è‡³å°‘ä¸æœƒé¡¯ç¤º 0ï¼‰
    function calcHoursLocalHalf_(s, e){
      const diffH = (e - s) / 36e5;
      if (!(diffH > 0)) return 0;
      return Math.round(diffH * 2) / 2;
    }

    /* ==============================
     * 3) å‰å°æç¤º
     * ============================== */
    const noteBox = document.getElementById("noteBox");
    function setNote(extraText){
      const cat = document.getElementById("cat").value;

      if(cat === "CORRECTION"){
        const ct = document.getElementById("correctionType").value;
        noteBox.textContent = (ct === "IN")
          ? "è£œå¡ï¼ˆä¸Šç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚"
          : "è£œå¡ï¼ˆä¸‹ç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚";
        return;
      }

      if(cat === "LEAVE"){
        noteBox.textContent = extraText || "è«‹å‡ï¼šç³»çµ±æœƒä¾æ’ç­/ç­åˆ¥è¦å‰‡è‡ªå‹•è¨ˆç®—æ™‚æ•¸ï¼ˆæ—©ç­ä¸æ‰£åˆä¼‘ã€åˆç­æ‰æ‰£åˆä¼‘ï¼‰ã€‚";
        return;
      }

      if(cat === "OUTING"){
        noteBox.textContent = extraText || "å¤–å‡ºï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ï¼Œéå‡ºå·®æœ€å¤š 8 å°æ™‚ã€‚";
        return;
      }

      if(cat === "OT"){
        noteBox.textContent = extraText || "åŠ ç­ï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ã€‚";
        return;
      }

      noteBox.textContent = extraText || "";
    }

    /* ==============================
     * 4) UI åˆ‡æ›
     * ============================== */
    function toggleType() {
      const cat = document.getElementById("cat").value;

      const typeGroup = document.getElementById("typeGroup");
      const correctionTypeGroup = document.getElementById("correctionTypeGroup");
      const hoursGroup = document.getElementById("hoursGroup");
      const endWrap = document.getElementById("endWrap");
      const extraGroup = document.getElementById("extraGroup");
      const startLabel = document.getElementById("startLabel");

      if (cat === "CORRECTION") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "block";
        hoursGroup.style.display = "none";
        endWrap.style.display = "none";
        extraGroup.style.display = "none";
        startLabel.textContent = "è£œå¡æ™‚é–“";
        document.getElementById("hours").value = "0.0";
        document.getElementById("end").value = "";
      } else if (cat === "OUTING") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "block";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      } else if (cat === "OT") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      } else {
        typeGroup.style.display = "block";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      }

      setNote();
    }

    /* ==============================
     * 5) è«‹å‡ï¼šä¾æ’ç­è‡ªå‹•å¸¶å…¥ç­è¡¨æ™‚é–“
     * ============================== */
    function normalizeShiftValue(v){
      const s = String(v||'').trim().toLowerCase();
      if(s.includes('åˆ') || s.includes('late')) return 'LATE';
      if(s.includes('æ—©') || s.includes('early')) return 'EARLY';
      return 'EARLY';
    }

    function setTimeByShiftForDate(dateObj, shiftKey){
      const def = (shiftKey === 'LATE')
        ? { start:'12:00', end:'21:00' }
        : { start:'10:00', end:'18:00' };

      const [sh, sm] = def.start.split(':').map(Number);
      const [eh, em] = def.end.split(':').map(Number);

      const s = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), sh, sm, 0, 0);
      const e = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), eh, em, 0, 0);

      document.getElementById("start").value = toLocalInputValue(s);
      document.getElementById("end").value = toLocalInputValue(e);
    }

    async function applyLeaveAutoTimeByRoster(){
      const cat = document.getElementById("cat").value;
      if(cat !== "LEAVE") return;

      const sVal = document.getElementById("start").value;
      const s = parseLocalInput(sVal);
      if(!s) return;

      const y = s.getFullYear();
      const m = s.getMonth()+1;
      const d = s.getDate();

      let shiftKey = 'EARLY';

      try{
        const res = await api("get_roster_data", { year:y, month:m });
        if(res && res.ok){
          const roster = res.roster || {};
          const myId = empId || "";
          const cell = myId && roster[myId] ? roster[myId][d] : null;
          const val = (cell && typeof cell === 'object') ? (cell.value || cell.shift || cell.v) : cell;
          if(val) shiftKey = normalizeShiftValue(val);
        }
      }catch(e){
        shiftKey = 'EARLY';
      }

      setTimeByShiftForDate(s, shiftKey);
      await calcHoursByServer();
    }

    /* ==============================
     * 6) æ™‚æ•¸è¨ˆç®—ï¼šå¾Œç«¯ calc_hoursï¼ˆæ¬Šå¨ï¼‰
     * âœ… ä¿®æ­£é‡é»ï¼š
     *   1) calc_hours ä¹Ÿä¸€èµ·é€ startServer/endServerï¼ˆè·Ÿ submit_request ä¸€æ¨£ï¼‰
     *   2) ä¹Ÿå¸¶ category/leaveTypeï¼ˆå¾ˆå¤šå¾Œç«¯è¦ç”¨é€™å€‹åˆ¤åˆä¼‘/ç­åˆ¥ï¼‰
     *   3) å¾Œç«¯å¤±æ•—æ™‚ï¼Œç”¨å‰ç«¯å‚™æ´è¨ˆç®—ï¼Œä¸è®“ä½ çœ‹åˆ° 0.0 + å¤±æ•—è¨Šæ¯ä¸€ç›´å¡
     * ============================== */
    let __calcTimer = null;

    async function calcHoursByServer(){
      const cat = document.getElementById("cat").value;

      if(cat === "CORRECTION"){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(!sVal || !eVal) return;

      const s = parseLocalInput(sVal);
      const e = parseLocalInput(eVal);

      if(!s || !e || e <= s){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const leaveType = (cat === "LEAVE") ? (document.getElementById("type")?.value || "") :
                       (cat === "OT") ? "ot" :
                       (cat === "OUTING") ? "outing" : "";

      if(cat === "LEAVE" && leaveType === "birthday" && !sameDay_(s, e)) {
        document.getElementById("end").value = sVal;
        document.getElementById("hours").value = "0.0";
        return;
      }

      // âœ… å…ˆç®—æœ¬æ©Ÿå‚™æ´ï¼ˆå¾Œç«¯æ›äº†ä¹Ÿä¸æœƒ 0ï¼‰
      let fallbackH = calcHoursLocalHalf_(s, e);
      if(cat === "OUTING"){
        const isTrip = !!document.getElementById("isTrip").checked;
        if(!isTrip) fallbackH = Math.min(8, fallbackH);
      }

      try{
        const res = await api("calc_hours", {
          // å…¼å®¹èˆŠå¾Œç«¯
          start: toServerDateTimeStr_(s),
          end: toServerDateTimeStr_(e),

          // âœ… å¼·åŠ›å»ºè­°å¾Œç«¯ç”¨é€™å…©å€‹ï¼ˆå®Œå…¨é¿é–‹æ™‚å€/ç€è¦½å™¨ Date parse å·®ç•°ï¼‰
          startServer: toServerDateTimeStr_(s),
          endServer: toServerDateTimeStr_(e),

          // âœ… å¾Œç«¯è‹¥éœ€è¦åˆ¤è¦å‰‡ï¼ˆåˆä¼‘/ç­åˆ¥/å‡åˆ¥ï¼‰
          category: cat,
          leaveType: leaveType,

          // âœ… è‹¥å¾Œç«¯æƒ³æ‹¿åŸå§‹ inputï¼ˆdatetime-localï¼‰
          startRaw: sVal,
          endRaw: eVal
        });

        if(res && res.ok){
          let h = Number(res.hours || 0);

          if(cat === "OUTING"){
            const isTrip = !!document.getElementById("isTrip").checked;
            if(!isTrip) h = Math.min(8, h);
          }

          document.getElementById("hours").value = Number(h).toFixed(1);

          if(cat === "LEAVE"){
            const shiftText = res.inferredShift ? `ç³»çµ±åˆ¤å®šï¼š${res.inferredShift}` : "";
            const lunchText = (res.lunchApplied === true) ? "ï¼ˆåˆç­å·²æ‰£åˆä¼‘ï¼‰" : "ï¼ˆæ—©ç­ä¸æ‰£åˆä¼‘ï¼‰";
            setNote(`è«‹å‡ï¼š${shiftText}${shiftText? " " : ""}${lunchText}ï¼Œæ™‚æ•¸ä»¥ç³»çµ±è¨ˆç®—ç‚ºæº–ã€‚`);
          }else{
            setNote();
          }
        }else{
          // âœ… å¾Œç«¯å› ok:falseï¼šæ”¹æˆç”¨å‚™æ´é¡¯ç¤ºï¼Œä¸è¦å¡ 0 + å¤±æ•—è¨Šæ¯
          document.getElementById("hours").value = Number(fallbackH).toFixed(1);
          setNote("ç³»çµ±æ™‚æ•¸è¨ˆç®—æš«æ™‚ä¸å¯ç”¨ï¼ˆå·²ç”¨æœ¬æ©Ÿå‚™æ´è¨ˆç®—ï¼‰ã€‚è‹¥ç‚ºè«‹å‡æ™‚æ•¸ï¼Œæœ€çµ‚ä»ä»¥ç³»çµ±å¯©æ ¸ç‚ºæº–ã€‚");
        }
      }catch(e){
        // âœ… é€¾æ™‚/ç¶²è·¯ï¼šåŒæ¨£ç”¨å‚™æ´
        document.getElementById("hours").value = Number(fallbackH).toFixed(1);
        setNote("ç³»çµ±æ™‚æ•¸è¨ˆç®—é€¾æ™‚ï¼ˆå·²ç”¨æœ¬æ©Ÿå‚™æ´è¨ˆç®—ï¼‰ã€‚è‹¥ç‚ºè«‹å‡æ™‚æ•¸ï¼Œæœ€çµ‚ä»ä»¥ç³»çµ±å¯©æ ¸ç‚ºæº–ã€‚");
      }
    }

    function debounceCalc(){
      clearTimeout(__calcTimer);
      __calcTimer = setTimeout(()=>{ calcHoursByServer(); }, 220);
    }

    /* ==============================
     * 7) é€å‡ºç”³è«‹ï¼ˆâœ… ä¸€ä½µå¸¶ startServer/endServerï¼Œé¿å…å¾Œç«¯æ™‚å€èª¤å·®ï¼‰
     * ============================== */
    async function submitReq() {
      const btn = document.getElementById("submitBtn");
      const cat = document.getElementById("cat").value;

      btn.disabled = true;
      btn.innerText = "é€å‡ºä¸­...";

      const start = document.getElementById("start").value;
      let end = document.getElementById("end").value;

      if (!start) {
        alert("è«‹å…ˆé¸æ“‡é–‹å§‹æ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      if (cat === "CORRECTION") {
        end = start;
      } else {
        if (!end) {
          alert("è«‹å…ˆé¸æ“‡çµæŸæ™‚é–“");
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
          return;
        }
      }

      const sObj = parseLocalInput(start);
      const eObj = parseLocalInput(end);
      if(!sObj || !eObj){
        alert("æ™‚é–“æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°é¸æ“‡");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const hours = (cat === "CORRECTION") ? 0 : Number(document.getElementById("hours").value || 0);

      if (cat !== "CORRECTION" && hours <= 0) {
        alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const leaveType =
        (cat === "LEAVE") ? document.getElementById("type").value :
        (cat === "OT") ? "ot" :
        (cat === "OUTING") ? "outing" : "correction";

      const data = {
        category: cat,
        leaveType,

        // åŸæœ¬æ¬„ä½ï¼ˆå…¼å®¹å¾Œç«¯æ—¢æœ‰ï¼‰
        start: start,
        end: end,

        // âœ… æ–°å¢ï¼šå¾Œç«¯å»ºè­°ç›´æ¥ç”¨é€™å…©å€‹ç®—ï¼Œå®Œå…¨é¿é–‹æ™‚å€å•é¡Œ
        startServer: toServerDateTimeStr_(sObj),
        endServer: toServerDateTimeStr_(eObj),

        hours,
        reason: document.getElementById("reason").value || "",
        autoClock: (cat === "OUTING") ? !!document.getElementById("autoClock").checked : false,
        isTrip: (cat === "OUTING") ? !!document.getElementById("isTrip").checked : false
      };

      if (cat === "CORRECTION") {
        data.correctionType = document.getElementById("correctionType").value;
      }

      try {
        const res = await api("submit_request", data);
        if (res && res.ok) {
          alert("ç”³è«‹æˆåŠŸï¼");
          location.href = "history.html";
        } else {
          alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
        }
      } catch (e) {
        alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }

    /* ==============================
     * 8) ç¶å®šäº‹ä»¶
     * ============================== */
    (function bindAll() {
      const startEl = document.getElementById("start");
      const endEl = document.getElementById("end");
      const catEl = document.getElementById("cat");
      const typeEl = document.getElementById("type");
      const correctionTypeEl = document.getElementById("correctionType");
      const isTripEl = document.getElementById("isTrip");
      const autoClockEl = document.getElementById("autoClock");
      const submitBtn = document.getElementById("submitBtn");

      const safeRecalc = () => { debounceCalc(); };

      [startEl, endEl].forEach(el => {
        if (!el) return;
        el.addEventListener("input", safeRecalc);
        el.addEventListener("change", safeRecalc);
        el.addEventListener("blur", safeRecalc);
      });

      catEl.addEventListener("change", async () => {
        toggleType();
        debounceCalc();
        await applyLeaveAutoTimeByRoster();
      });

      if(typeEl){
        typeEl.addEventListener("change", () => {
          debounceCalc();
        });
      }
      if(correctionTypeEl){
        correctionTypeEl.addEventListener("change", () => setNote());
      }
      if(isTripEl) isTripEl.addEventListener("change", debounceCalc);
      if(autoClockEl) autoClockEl.addEventListener("change", debounceCalc);

      submitBtn.addEventListener("click", submitReq);
    })();

    /* ==============================
     * 9) åˆå§‹åŒ–ï¼šé è¨­ä»Šå¤© 10:00-18:00 + å¾Œç«¯ç®—æ™‚æ•¸
     * ============================== */
    (function initDefaultTime() {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0, 0);
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0, 0);
      document.getElementById("start").value = toLocalInputValue(base);
      document.getElementById("end").value = toLocalInputValue(end);
    })();

    toggleType();
    setNote();
    calcHoursByServer();
  </script>
</body>
</html>
