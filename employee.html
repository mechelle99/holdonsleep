<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æˆ‘çš„å‡ºå‹¤çµ±è¨ˆ</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:16px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .btn-back{padding:8px 16px;background:#333;color:#fff;text-decoration:none;border-radius:6px;font-size:14px;}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:16px;}
    h3{margin-top:0;border-bottom:1px solid #eee;padding-bottom:10px;}
    
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 5px;text-align:left;border-bottom:1px solid #eee;}
    th{background:#fafafa;color:#666;font-weight:600;}
    .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:12px;color:#fff;}
    .bg-red{background:#e74c3c;} .bg-green{background:#2ecc71;} .bg-gray{background:#95a5a6;}
    
    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>
<body>

  <div class="header">
    <a href="app.html" class="btn-back">â† å›é¦–é </a>
    <div style="font-weight:bold;">å€‹äººå‡ºå‹¤ç´€éŒ„</div>
  </div>

  <div class="card">
    <h3>ğŸ“Š ç•¶æœˆçµ±è¨ˆ (æœ¬æœˆ)</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
      <div>
        <div style="font-size:12px;color:#888">é²åˆ°æ¬¡æ•¸</div>
        <div style="font-size:24px;font-weight:bold;color:#e74c3c;" id="statLate">-</div>
      </div>
      <div>
        <div style="font-size:12px;color:#888">è«‹å‡æ™‚æ•¸</div>
        <div style="font-size:24px;font-weight:bold;color:#f39c12;" id="statLeave">-</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“… æœ€è¿‘æ‰“å¡ (æ—¥å ±è¡¨)</h3>
    <table>
      <thead>
        <tr><th>æ—¥æœŸ</th><th>ä¸Šç­</th><th>ä¸‹ç­</th><th>ç‹€æ…‹</th></tr>
      </thead>
      <tbody id="attendanceBody"></tbody>
    </table>
    <div id="loading">è¼‰å…¥ä¸­...</div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const userId = localStorage.getItem("employeeId");

    if(!userId) { alert("è«‹å…ˆç™»å…¥"); location.href="index.html"; }

    function api(act, data={}){
      return new Promise((resolve, reject)=>{
        const cb = "cb"+Date.now();
        // ç¢ºä¿åŠ ä¸Š webhookKey
        const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
        const s = document.createElement("script");
        s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        window[cb] = (res) => { resolve(res); try{delete window[cb]; document.body.removeChild(s);}catch(e){} };
        s.onerror = () => reject("é€£ç·šå¤±æ•—");
        document.body.appendChild(s);
      });
    }

    async function loadMyData(){
      try {
        const res = await api("get_my_dashboard"); 
        document.getElementById("loading").style.display = "none";

        if(res.ok) {
          // 1. æ›´æ–°çµ±è¨ˆæ•¸å­—
          document.getElementById("statLate").textContent = res.stats?.lateCount || 0;
          document.getElementById("statLeave").textContent = res.stats?.leaveHours || 0;

          // 2. è™•ç†è¡¨æ ¼è³‡æ–™ (é—œéµï¼šå°‡æµæ°´å¸³åˆä½µç‚ºæ—¥å ±è¡¨)
          const tbody = document.getElementById("attendanceBody");
          tbody.innerHTML = "";
          
          if(res.attendance && res.attendance.length > 0){
            // --- [æ–°å¢] è³‡æ–™åˆä½µé‚è¼¯ ---
            const dailyMap = {};
            
            res.attendance.forEach(r => {
              // å–å‡ºæ—¥æœŸéƒ¨åˆ† (ä¾‹å¦‚ 2023-10-27)
              const dateKey = r.date.substring(0, 10);
              
              if (!dailyMap[dateKey]) {
                dailyMap[dateKey] = { 
                  date: r.date, 
                  in: '-', 
                  out: '-', 
                  isLate: false 
                };
              }
              
              // å¦‚æœé€™ç­†æ˜¯ä¸Šç­å¡ (æœ‰ r.in)
              if (r.in && r.in !== '') dailyMap[dateKey].in = r.in;
              
              // å¦‚æœé€™ç­†æ˜¯ä¸‹ç­å¡ (æœ‰ r.out)
              if (r.out && r.out !== '') dailyMap[dateKey].out = r.out;
              
              // æ¨™è¨˜é²åˆ°
              if (r.isLate) dailyMap[dateKey].isLate = true;
            });

            // å°‡ Map è½‰å›é™£åˆ—ä¸¦æ’åº (æ—¥æœŸæ–°åˆ°èˆŠ)
            const mergedList = Object.values(dailyMap).sort((a,b) => 
              new Date(b.date) - new Date(a.date)
            );
            // ------------------------

            mergedList.forEach(r => {
              let statusBadge = '<span class="badge bg-green">æ­£å¸¸</span>';
              
              if(r.isLate) {
                statusBadge = '<span class="badge bg-red">é²åˆ°</span>';
              }
              
              // æª¢æŸ¥ç¼ºå¡ (åˆä½µå¾Œåˆ¤æ–·æ‰æº–ç¢º)
              // é‚è¼¯ï¼šä»Šå¤©ä»¥å‰çš„æ—¥å­ï¼Œå¦‚æœæœ‰ç©ºç¼ºï¼Œå°±æ˜¯ç•°å¸¸
              const isToday = new Date().toDateString() === new Date(r.date).toDateString();
              const hasIn = r.in !== '-';
              const hasOut = r.out !== '-';

              if (!isToday) {
                 if(hasIn && !hasOut) {
                    statusBadge = '<span class="badge bg-gray">ç¼ºä¸‹ç­å¡</span>';
                 } else if (!hasIn && hasOut) {
                    statusBadge = '<span class="badge bg-gray">ç¼ºä¸Šç­å¡</span>';
                 }
              } else {
                 // å¦‚æœæ˜¯ä»Šå¤©ï¼Œä¸”åªæœ‰ä¸Šç­æ²’ä¸‹ç­ï¼Œé¡¯ç¤ºã€Œå·¥ä½œä¸­ã€
                 if(hasIn && !hasOut) statusBadge = '<span class="badge bg-green">å·¥ä½œä¸­</span>';
              }

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${r.date.substring(5,10)}</td>
                <td>${r.in}</td>
                <td>${r.out}</td>
                <td>${statusBadge}</td>
              `;
              tbody.appendChild(tr);
            });
            
          } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">å°šç„¡æ‰“å¡è³‡æ–™</td></tr>';
          }
        } else {
          document.getElementById("loading").innerText = "è¼‰å…¥å¤±æ•—ï¼š" + (res.message || "æœªçŸ¥éŒ¯èª¤");
        }
      } catch(e) {
        console.error(e);
        document.getElementById("loading").innerText = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹çœ‹ Console";
      }
    }

    loadMyData();
  </script>
</body>
</html>
