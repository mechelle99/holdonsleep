<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>我的出勤</title>

<style>
body{
  font-family:system-ui;
  margin:0;
  background:#f6f7fb;
}

.wrap{
  max-width:720px;
  margin:auto;
  padding:16px;
}

.card{
  background:white;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}

h2{
  margin-top:0;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th,td{
  border-bottom:1px solid #eee;
  padding:8px;
  text-align:left;
}

.badge{
  background:#fee2e2;
  color:#991b1b;
  padding:3px 8px;
  border-radius:999px;
  font-size:12px;
}
</style>
</head>

<body>

<div class="wrap">

<div class="card">
<h2>載入中...</h2>
<div id="msg">請稍候</div>
</div>

<div class="card">
<h2>最近打卡</h2>
<table id="attendanceTable">
<thead>
<tr>
<th>日期</th>
<th>上班</th>
<th>下班</th>
<th>備註</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="card">
<h2>請假紀錄</h2>
<table id="requestTable">
<thead>
<tr>
<th>日期</th>
<th>類型</th>
<th>狀態</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>

const API_URL = "你的GAS_URL";
const LIFF_ID = "你的LIFF_ID";

function fillAttendance(data){
  const tbody=document.querySelector("#attendanceTable tbody");
  tbody.innerHTML="";

  data.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.date}</td>
      <td>${r.in||"-"}</td>
      <td>${r.out||"-"}</td>
      <td>${r.late?'<span class="badge">遲到</span>':''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function fillRequests(data){
  const tbody=document.querySelector("#requestTable tbody");
  tbody.innerHTML="";

  data.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.date}</td>
      <td>${r.type}</td>
      <td>${r.status}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function postApi(action,data){
  const idToken = liff.getIDToken();

  const res = await fetch(API_URL,{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({action,data,idToken})
  });

  return res.json();
}

async function boot(){
  await liff.init({liffId:LIFF_ID});

  if(!liff.isLoggedIn()){
    liff.login();
    return;
  }

  const res = await postApi("get_my_dashboard",{});

  if(!res.ok){
    document.getElementById("msg").innerText="載入失敗";
    return;
  }

  document.getElementById("msg").innerText="資料已更新";

  fillAttendance(res.attendance||[]);
  fillRequests(res.requests||[]);
}

boot();

</script>

</body>
</html>
