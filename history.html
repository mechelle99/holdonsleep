<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ç´€éŒ„æŸ¥è©¢</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }
    
    .header { margin-bottom: 15px; } 
    h2 { margin: 0; font-size: 22px; font-weight: 700; }

    /* â˜… åˆ†é åˆ‡æ›å™¨ (Tabs) */
    .tabs { display: flex; background: #E5E7EB; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; color: #6B7280; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* éæ¿¾å™¨ */
    .filter-card { 
        background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 20px; 
        display: flex; align-items: center; gap: 15px; width: 100%; box-sizing: border-box;
        box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .filter-group { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .filter-group label { font-size: 12px; margin-bottom: 6px; color: #6B7280; font-weight: 600; }
    .filter-group select { 
        width: 100%; box-sizing: border-box; height: 42px; padding: 0 12px; 
        border: 1px solid #E5E7EB; border-radius: 10px; background: #F9FAFB; 
        font-size: 14px; outline: none; -webkit-appearance: none;
    }

    /* å…§å®¹å®¹å™¨ */
    .content-area { display: none; }
    .content-area.active { display: block; }

    /* --- å‡ºå‹¤å¡ç‰‡æ¨£å¼ (Attendance) --- */
    .att-card { background: white; padding: 15px; border-radius: 16px; display: flex; align-items: center; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); border-left: 5px solid transparent; }
    .att-date { width: 50px; text-align: center; border-right: 1px solid #eee; margin-right: 15px; padding-right: 15px; }
    .d-num { font-size: 18px; font-weight: 800; color: #333; }
    .d-week { font-size: 12px; color: #999; }
    .weekend .d-num, .weekend .d-week { color: #EF4444; }
    
    .att-times { flex: 1; font-size: 13px; color: #555; line-height: 1.6; }
    .t-row span { display: inline-block; width: 32px; color: #999; font-size: 11px; }
    
    .att-tag { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; color: white; min-width: 60px; text-align: center; }
    
    /* ç‹€æ…‹é¡è‰² */
    .cls-ok { border-left-color: #10B981; } .tag-ok { background: #10B981; }
    .cls-late { border-left-color: #F59E0B; } .tag-late { background: #F59E0B; }
    .cls-miss { border-left-color: #EF4444; } .tag-miss { background: #EF4444; }
    .cls-leave { border-left-color: #3B82F6; } .tag-leave { background: #3B82F6; }
    .cls-off { border-left-color: #E5E7EB; } .tag-off { background: #E5E7EB; color: #9CA3AF; }

    /* --- ç”³è«‹å–®æ¨£å¼ (Requests) --- */
    .req-card { background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 12px; border-left: 4px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .req-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .req-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 6px; }
    .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .status-PENDING { background: #FEF3C7; color: #92400E; }
    .status-APPROVED { background: #D1FAE5; color: #065F46; }
    .status-REJECTED { background: #FEE2E2; color: #991B1B; }
    .req-time { font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 4px; }
    .req-reason { margin-top: 8px; background: #F3F4F6; padding: 10px; border-radius: 8px; font-size: 14px; color: #4B5563; word-break: break-all; }

    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <div class="header"><h2>ğŸ“‹ ç´€éŒ„æŸ¥è©¢</h2></div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('att')">æ¯æ—¥å‡ºå‹¤</div>
    <div class="tab" onclick="switchTab('req')">ç”³è«‹å–®æ“š</div>
  </div>

  <div class="filter-card">
    <div class="filter-group">
      <label>æœˆä»½</label>
      <select id="mSelect" onchange="refresh()"></select>
    </div>
    
    <div class="filter-group" id="statusFilter" style="display:none;">
      <label>ç‹€æ…‹</label>
      <select id="sSelect" onchange="refresh()">
        <option value="">å…¨éƒ¨</option>
        <option value="PENDING">å¯©æ ¸ä¸­</option>
        <option value="APPROVED">å·²é€šé</option>
        <option value="REJECTED">å·²é§å›</option>
      </select>
    </div>
  </div>

  <div id="view-att" class="content-area active">
    <div id="list-att" style="text-align:center;color:#999;padding:40px;">è«‹é¸æ“‡æœˆä»½æŸ¥è©¢</div>
  </div>

  <div id="view-req" class="content-area">
    <div id="list-req" style="text-align:center;color:#999;padding:40px;">è«‹é¸æ“‡æœˆä»½æŸ¥è©¢</div>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item active"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) document.getElementById("mgrBtn").style.display = 'flex';

  // åˆå§‹åŒ–æœˆä»½é¸å–®
  const mSel = document.getElementById("mSelect");
  const now = new Date();
  for(let i=0; i<6; i++) {
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const v = `${d.getFullYear()}/${d.getMonth()+1}`; // 2026/2
      const t = `${d.getFullYear()}å¹´${String(d.getMonth()+1).padStart(2,'0')}æœˆ`;
      mSel.add(new Option(t, v));
  }

  let currentTab = 'att'; // é è¨­é¡¯ç¤ºå‡ºå‹¤

  function switchTab(tab) {
      currentTab = tab;
      
      // UI åˆ‡æ›
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.currentTarget.classList.add('active');
      
      document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
      document.getElementById(`view-${tab}`).classList.add('active');

      // ç‹€æ…‹éæ¿¾å™¨åªåœ¨ã€Œç”³è«‹å–®ã€é¡¯ç¤º
      document.getElementById('statusFilter').style.display = (tab === 'req') ? 'flex' : 'none';

      refresh();
  }

  function refresh() {
      if (currentTab === 'att') loadAttendance();
      else loadRequests();
  }

  function api(act, d={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  // â˜… è¼‰å…¥æ¯æ—¥å‡ºå‹¤ (èˆŠ attendance.html é‚è¼¯)
  async function loadAttendance() {
      const listDiv = document.getElementById("list-att");
      listDiv.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">è¼‰å…¥ä¸­...</div>';
      
      const [y, m] = mSel.value.split('/');
      const res = await api("get_dashboard", {year: y, month: m});

      if(!res.ok || !res.dailyData || res.dailyData.length === 0) {
          listDiv.innerHTML = `<div style="text-align:center;padding:40px;color:#9CA3AF;">ç„¡æ‰“å¡è³‡æ–™</div>`;
          return;
      }

      let h = "";
      res.dailyData.forEach(d => {
          const isWk = (d.week==='æ—¥'||d.week==='å…­') ? 'weekend' : '';
          // æ¨£å¼å°æ‡‰: cls-ok, cls-late, cls-miss...
          const cls = `cls-${d.cls}`; 
          const tagCls = `tag-${d.cls}`;

          h += `
          <div class="att-card ${cls}">
            <div class="att-date ${isWk}">
              <div class="d-num">${d.date}</div>
              <div class="d-week">${d.week}</div>
            </div>
            <div class="att-times">
              <div class="t-row"><span>ä¸Šç­</span> ${d.in}</div>
              <div class="t-row"><span>ä¸‹ç­</span> ${d.out}</div>
            </div>
            <div class="att-tag ${tagCls}">${d.tag}</div>
          </div>`;
      });
      listDiv.innerHTML = h;
  }

  // â˜… è¼‰å…¥ç”³è«‹å–®æ“š (èˆŠ history.html é‚è¼¯)
  async function loadRequests() {
      const listDiv = document.getElementById("list-req");
      listDiv.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">è¼‰å…¥ä¸­...</div>';
      
      // æ³¨æ„ï¼šç›®å‰çš„å¾Œç«¯ listRequests API å°šæœªæ”¯æ´ "æœˆä»½éæ¿¾"ï¼Œå®ƒåªçµ¦å…¨éƒ¨
      // ç‚ºäº†ä¸è¦æ”¹å‹•å¾Œç«¯å¤ªå¤šï¼Œæˆ‘å€‘å‰ç«¯éæ¿¾å³å¯
      const [y, m] = mSel.value.split('/');
      const status = document.getElementById("sSelect").value;
      
      const res = await api("list_requests", { filterStatus: status });

      if(!res.ok || res.list.length === 0) {
          listDiv.innerHTML = `<div style="text-align:center;padding:40px;color:#9CA3AF;">ç„¡ç”³è«‹è³‡æ–™</div>`;
          return;
      }

      // å‰ç«¯éæ¿¾æœˆä»½
      const targetPrefix = `${y}-${m.padStart(2,'0')}`; // e.g. 2026-02
      const filtered = res.list.filter(r => r.start.startsWith(targetPrefix));

      if(filtered.length === 0) {
          listDiv.innerHTML = `<div style="text-align:center;padding:40px;color:#9CA3AF;">æœ¬æœˆç„¡ç”³è«‹è³‡æ–™</div>`;
          return;
      }

      let h = "";
      filtered.forEach(r => {
          let badge = "å¯©æ ¸ä¸­";
          if(r.status==='APPROVED') badge="å·²é€šé";
          if(r.status==='REJECTED') badge="å·²é§å›";
          
          let icon = "ğŸ“„";
          if(r.category==='LEAVE') icon="è¯·";
          if(r.category==='OT') icon="åŠ ";
          if(r.category==='OUTING') icon="å¤–";
          
          let typeTxt = r.leaveType;
          if(typeTxt==='annual') typeTxt='ç‰¹ä¼‘';
          if(typeTxt==='comp') typeTxt='è£œä¼‘';
          if(typeTxt==='sick') typeTxt='ç—…å‡';
          if(typeTxt==='personal') typeTxt='äº‹å‡';

          h += `
          <div class="req-card" style="border-left-color:${r.status==='PENDING'?'#F59E0B':(r.status==='APPROVED'?'#10B981':'#EF4444')}">
            <div class="req-header">
              <div class="req-title">
                 <span>${icon}</span> ${typeTxt || r.category}
              </div>
              <div class="status-badge status-${r.status}">${badge}</div>
            </div>
            <div class="req-time">ğŸ“… ${r.start.replace('T',' ')} (${r.hours}h)</div>
            <div class="req-reason">${r.reason || 'ç„¡å‚™è¨»'}</div>
          </div>`;
      });
      listDiv.innerHTML = h;
  }
  
  // å•Ÿå‹•
  refresh();
</script>
</body>
</html>
