<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>åœ˜éšŠæ’ç­</title>
  <style>
    :root{
      --primary:#4F46E5;
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --text:#111827;
      --muted:#6B7280;

      --ok:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;

      --shadow: 0 10px 26px rgba(17,24,39,.10);
      --shadow2: 0 6px 16px rgba(17,24,39,.06);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--text);
      padding: 18px 18px calc(90px + env(safe-area-inset-bottom)) 18px;
    }

    /* toast */
    .toast{
      position: fixed;
      left: 16px; right: 16px;
      top: calc(16px + env(safe-area-inset-top));
      background: #111827;
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      display:none;
      z-index: 9999;
      font-size: 13px;
      line-height: 1.4;
    }

    /* hero */
    .hero{
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      border-radius: 26px;
      padding: 18px;
      box-shadow: var(--shadow);
      color:#fff;
      margin-bottom: 14px;
    }
    .hero h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hero .sub{
      margin-top: 8px;
      font-size: 13px;
      opacity: .9;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.22);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* controls */
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin: 12px 0 14px 0;
    }
    .controls select{
      border:none;
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow2);
      font-size: 13px;
      outline:none;
      font-weight: 900;
      color: var(--text);
      -webkit-appearance:none;
    }
    .controls button{
      border:none;
      background: var(--primary);
      color:#fff;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .controls button:active{ transform: scale(.99); }

    /* card */
    .card{
      background: var(--card);
      border-radius: 20px;
      box-shadow: var(--shadow2);
      border: 1px solid rgba(17,24,39,.06);
      overflow:hidden;
    }
    .card-head{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(17,24,39,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-head .title{
      font-size: 14px;
      font-weight: 1000;
      color: var(--primary);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .card-head .small{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    /* table */
    .table-scroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 920px;
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: #F9FAFB;
      font-weight: 1000;
      color:#374151;
      border-bottom: 1px solid rgba(17,24,39,.06);
    }
    th, td{
      padding: 10px 10px;
      text-align:center;
      font-size: 12px;
      white-space: nowrap;
      border-bottom: 1px solid rgba(17,24,39,.06);
      background:#fff;
    }

    /* sticky first col */
    th:first-child, td:first-child{
      position: sticky;
      left: 0;
      z-index: 6;
      background:#fff;
      border-right: 1px solid rgba(17,24,39,.08);
      text-align:left;
      padding-left: 12px;
      font-weight: 1000;
      color: var(--primary);
      min-width: 150px;
    }
    thead th:first-child{
      z-index: 10;
      background:#F9FAFB;
      color:#374151;
    }

    .wk-red{ color: var(--danger) !important; }
    .dayHead{
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:center;
      line-height: 1.1;
    }
    .dayHead small{
      font-size: 11px;
      font-weight: 900;
      opacity: .9;
    }

    /* shift select */
    .shift-sel{
      width: 56px;
      max-width: 100%;
      border: 1px solid rgba(17,24,39,.12);
      border-radius: 12px;
      padding: 8px 8px;
      font-size: 12px;
      font-weight: 1000;
      outline:none;
      background:#fff;
      color:#111827;
      -webkit-appearance:none;
      text-align:center;
      cursor:pointer;
    }
    .shift-sel:disabled{
      cursor:not-allowed;
      opacity:.55;
      background:#F3F4F6;
    }

    .bg-EARLY{ background: rgba(16,185,129,.14) !important; border-color: rgba(16,185,129,.55) !important; color:#065F46 !important; }
    .bg-LATE { background: rgba(245,158,11,.16) !important; border-color: rgba(245,158,11,.55) !important; color:#92400E !important; }
    .bg-OFF  { background: rgba(156,163,175,.16) !important; border-color: rgba(156,163,175,.45) !important; color:#4B5563 !important; }

    /* leave pill */
    .leave-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 1000;
      background: #EEF2FF;
      color: var(--primary);
      border: 1px solid rgba(79,70,229,.22);
      min-width: 56px;
    }

    .mutedRow{
      padding: 22px;
      text-align:center;
      color:#9CA3AF;
      font-weight: 1000;
    }

    /* bottom nav */
    .nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 18px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      box-shadow: 0 -10px 30px rgba(17,24,39,.08);
      display:flex;
      justify-content: space-around;
      z-index: 1000;
    }
    .nav-item{
      text-decoration:none;
      color:#9CA3AF;
      display:flex; flex-direction:column; align-items:center;
      gap: 4px;
      font-size: 10px;
      font-weight: 900;
    }
    .nav-item.active{ color: var(--primary); }
    .nav-icon{ font-size: 22px; }
    #mgrBtn{ display:none; }
    .showMgr #mgrBtn{ display:flex; }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <section class="hero">
    <h2>ğŸ“… åœ˜éšŠæ’ç­</h2>
    <div class="sub">
      <span class="pill" id="modeTag">è¼‰å…¥ä¸­â€¦</span>
      <span class="pill" id="ymTag">â€”</span>
    </div>
  </section>

  <div class="controls">
    <select id="y"></select>
    <select id="m"></select>
    <button type="button" id="btnLoad">æŸ¥è©¢</button>
  </div>

  <section class="card">
    <div class="card-head">
      <div class="title">ğŸ“Œ æ’ç­ç¸½è¦½</div>
      <div class="small" id="hintRight">â€”</div>
    </div>

    <div class="table-scroll">
      <table id="tbl">
        <thead>
          <tr id="thRow">
            <th>å“¡å·¥</th>
          </tr>
        </thead>
        <tbody id="tbRow">
          <tr><td class="mutedRow" colspan="10">è¼‰å…¥ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <nav class="nav" id="bottomNav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item active"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½èˆ‡æ¨¡å¼
     * ============================== */
    const uid =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      "";

    const isMgr = (localStorage.getItem("isManager") === "true");

    if(!uid) location.href = "index.html";
    if(isMgr) document.getElementById("bottomNav").classList.add("showMgr");

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.style.display="none", 2400);
    }

    /* ==============================
     * 1) JSONP APIï¼ˆçµ±ä¸€æ ¼å¼ï¼‰
     * ============================== */
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        const ENDPOINT = window.CONFIG && window.CONFIG.GAS_ENDPOINT;
        if(!ENDPOINT) return reject(new Error("ç¼ºå°‘ CONFIG.GAS_ENDPOINT"));

        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
        const s = document.createElement("script");

        const payloadObj = Object.assign({}, data, {
          userId: uid
        });

        if(window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null){
          payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
        }

        const payload = encodeURIComponent(JSON.stringify(payloadObj));
        const bust = Date.now();

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("è«‹æ±‚é€¾æ™‚"));
        }, 20000);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          try { s.remove(); } catch(e){}
        }

        window[cbName] = (res) => { cleanup(); resolve(res); };
        s.onerror = () => { cleanup(); reject(new Error("ç¶²è·¯é€£ç·šå¤±æ•—")); };

        s.src = `${ENDPOINT}?action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${bust}`;
        document.body.appendChild(s);
      });
    }

    /* ==============================
     * 2) å¹´æœˆä¸‹æ‹‰åˆå§‹åŒ–
     * ============================== */
    const yS = document.getElementById("y");
    const mS = document.getElementById("m");
    const now = new Date();

    const yStart = 2024;
    const yEnd   = 2026;

    for(let y=yStart; y<=yEnd; y++){
      const opt = new Option(String(y), String(y));
      if(y === now.getFullYear()) opt.selected = true;
      yS.appendChild(opt);
    }
    for(let m=1; m<=12; m++){
      const opt = new Option(String(m), String(m));
      if(m === (now.getMonth()+1)) opt.selected = true;
      mS.appendChild(opt);
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymtag(y,m){
      return `${y}-${pad2(m)}`;
    }
    function weekdayOf(y,m,d){
      return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(y, m-1, d).getDay()];
    }

    /* ==============================
     * 3) ç•«è¡¨
     * ============================== */
    function setModeTag(isLocked, lockDay, isNextMonth, y, m){
      const modeTag = document.getElementById("modeTag");
      const hintRight = document.getElementById("hintRight");

      if(isMgr){
        modeTag.textContent = "ğŸ‘‘ ä¸»ç®¡æ¨¡å¼ï¼ˆå¯ä»»æ„ç·¨è¼¯ï¼‰";
        hintRight.textContent = "ä¸»ç®¡å¯ç›´æ¥èª¿æ•´";
        return;
      }

      if(!isLocked){
        modeTag.textContent = `ğŸŸ¢ é–‹æ”¾æ’ç­ä¸­ï¼ˆæ¯æœˆ ${lockDay} è™Ÿæˆªæ­¢ï¼‰`;
        hintRight.textContent = `å¯ç·¨è¼¯ï¼š${ymtag(y,m)}ï¼ˆæˆªæ­¢æ—¥ï¼š${lockDay}è™Ÿï¼‰`;
      }else{
        if(!isNextMonth){
          modeTag.textContent = "ğŸ”’ å·²é–å®šï¼ˆåƒ…å¯æŸ¥çœ‹ï¼‰";
          hintRight.textContent = "æœ¬æœˆ/éæœŸ/é æœŸç­è¡¨ä¸å¯ç·¨è¼¯";
        }else{
          modeTag.textContent = `ğŸ”´ æ’ç­å·²æˆªæ­¢ï¼ˆ${lockDay}è™Ÿå¾Œé–å®šï¼‰`;
          hintRight.textContent = "å·²æˆªæ­¢ï¼Œåƒ…å¯æŸ¥çœ‹";
        }
      }
    }

    function normalizeShiftForUI(v){
      const s = String(v||'').trim();
      const low = s.toLowerCase();
      if(s === "æ—©ç­" || low === "early") return { val:"æ—©ç­", cls:"bg-EARLY", short:"æ—©" };
      if(s === "åˆç­" || low === "late")  return { val:"åˆç­", cls:"bg-LATE",  short:"åˆ" };
      if(s === "ä¼‘å‡" || low === "off")   return { val:"ä¼‘å‡", cls:"bg-OFF",   short:"ä¼‘" };
      return { val:"", cls:"", short:"-" };
    }

    function buildHeader(y,m,days){
      let head = `<th>å“¡å·¥</th>`;
      for(let d=1; d<=days; d++){
        const wk = weekdayOf(y,m,d);
        const isWeekend = (wk === 'å…­' || wk === 'æ—¥');
        head += `
          <th class="${isWeekend ? 'wk-red' : ''}">
            <div class="dayHead">
              <div>${d}</div>
              <small>${wk}</small>
            </div>
          </th>`;
      }
      document.getElementById("thRow").innerHTML = head;
    }

    function buildBody(y,m,days, employees, roster, isLocked){
      const tb = document.getElementById("tbRow");
      if(!employees || employees.length === 0){
        tb.innerHTML = `<tr><td class="mutedRow" colspan="${days+1}">æ²’æœ‰å¯æ’ç­çš„äººå“¡</td></tr>`;
        return;
      }

      let rows = "";
      employees.forEach(e=>{
        const empId = e.empId || e.id || "";
        const empName = e.empName || e.name || empId;

        let tds = `<td>${escapeHtml(empName)}</td>`;

        for(let d=1; d<=days; d++){
          const cell = (roster && roster[empId] && roster[empId][d]) ? roster[empId][d] : {};
          const dateStr = `${y}-${pad2(m)}-${pad2(d)}`;

          if(cell && String(cell.type||'').toUpperCase() === 'LEAVE'){
            const txt = String(cell.value||'').trim() || 'å‡';
            tds += `<td><span class="leave-pill">${escapeHtml(txt)}</span></td>`;
            continue;
          }

          const ui = normalizeShiftForUI(cell && cell.value);
          const dis = (isLocked && !isMgr) ? "disabled" : "";

          tds += `<td>
            <select class="shift-sel ${ui.cls}" ${dis}
              data-prev="${ui.val}"
              onchange="upd('${escapeAttr(empId)}','${dateStr}',this)">
              <option value="" ${ui.val===""?'selected':''}>-</option>
              <option value="æ—©ç­" ${ui.val==="æ—©ç­"?'selected':''}>æ—©</option>
              <option value="åˆç­" ${ui.val==="åˆç­"?'selected':''}>åˆ</option>
              <option value="ä¼‘å‡" ${ui.val==="ä¼‘å‡"?'selected':''}>ä¼‘</option>
            </select>
          </td>`;
        }

        rows += `<tr>${tds}</tr>`;
      });

      tb.innerHTML = rows;
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, c=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }
    function escapeAttr(s){
      return String(s||'').replace(/['"]/g, '');
    }

    /* ==============================
     * 4) æ›´æ–°æ’ç­ï¼ˆå«å¤±æ•—å›å¾©ï¼‰
     * ============================== */
    async function upd(targetEmpId, dateStr, el){
      // å…ˆè¨˜ä½èˆŠå€¼ï¼Œå¤±æ•—è¦å›å¾©
      const prev = el.getAttribute("data-prev") || "";

      // UI ä¸Šè‰²
      paintShift(el);

      try{
        const res = await api("update_schedule", {
          targetEmpId,
          date: dateStr,
          shift: el.value
        });

        if(!res || !res.ok){
          // å›å¾©
          el.value = prev;
          paintShift(el);
          toast(res && res.message ? res.message : "æ›´æ–°å¤±æ•—");
          return;
        }

        // æˆåŠŸï¼šæ›´æ–° prev
        el.setAttribute("data-prev", el.value || "");
        toast("å·²æ›´æ–° âœ…");

      }catch(e){
        el.value = prev;
        paintShift(el);
        toast("æ›´æ–°å¤±æ•—ï¼ˆé€£ç·š/é€¾æ™‚ï¼‰");
      }
    }

    function paintShift(el){
      el.classList.remove("bg-EARLY","bg-LATE","bg-OFF");
      if(el.value === "æ—©ç­") el.classList.add("bg-EARLY");
      if(el.value === "åˆç­") el.classList.add("bg-LATE");
      if(el.value === "ä¼‘å‡") el.classList.add("bg-OFF");
    }

    window.upd = upd; // çµ¦ inline onchange ç”¨

    /* ==============================
     * 5) ä¸»æµç¨‹ï¼šload roster
     * ============================== */
    async function load(){
      const y = Number(yS.value);
      const m = Number(mS.value);
      document.getElementById("ymTag").textContent = `ç¯©é¸ï¼š${ymtag(y,m)}`;

      document.getElementById("tbRow").innerHTML =
        `<tr><td class="mutedRow" colspan="10">è³‡æ–™è®€å–ä¸­â€¦</td></tr>`;

      try{
        const res = await api("get_roster_data", { year:y, month:m });
        if(!res || !res.ok){
          document.getElementById("tbRow").innerHTML =
            `<tr><td class="mutedRow" colspan="10" style="color:#EF4444">è®€å–å¤±æ•—ï¼š${escapeHtml(res && res.message ? res.message : "unknown")}</td></tr>`;
          document.getElementById("modeTag").textContent = "âš ï¸ è®€å–å¤±æ•—";
          return;
        }

        // ===== é–å®šåˆ¤å®šï¼ˆç¶­æŒä½ åŸæœ¬è¦å‰‡ï¼Œä½†æ›´æ¸…æ¥šï¼‰=====
        const today = new Date();
        const lockDay = Number(res.lockDay || 25);

        const currentVal = today.getFullYear()*12 + (today.getMonth()+1);
        const targetVal  = y*12 + m;
        const isNextMonth = (targetVal === currentVal + 1);

        // res.isManagerï¼šå¾Œç«¯åˆ¤å®šï¼ŒisMgrï¼šå‰ç«¯æœ¬åœ°åˆ¤å®š
        const isManagerFromServer = !!res.isManager;
        const canEditAsManager = isMgr || isManagerFromServer;

        // éä¸»ç®¡ï¼šåªé–‹æ”¾ã€Œä¸‹å€‹æœˆã€ä¸” <= lockDay
        const isLocked = !canEditAsManager && (!isNextMonth || (isNextMonth && today.getDate() > lockDay));

        setModeTag(isLocked, lockDay, isNextMonth, y, m);

        // ===== ç•«è¡¨ =====
        const days = new Date(y, m, 0).getDate();
        buildHeader(y,m,days);

        const employees = Array.isArray(res.employees) ? res.employees : [];
        const roster = res.roster || {};
        buildBody(y,m,days, employees, roster, isLocked);

      }catch(e){
        document.getElementById("tbRow").innerHTML =
          `<tr><td class="mutedRow" colspan="10" style="color:#EF4444">é€£ç·šç•°å¸¸ï¼š${escapeHtml(e.message || "error")}</td></tr>`;
        document.getElementById("modeTag").textContent = "âš ï¸ é€£ç·šç•°å¸¸";
      }
    }

    document.getElementById("btnLoad").addEventListener("click", load);

    // init
    load();
  </script>
</body>
</html>
