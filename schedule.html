<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>æ’ç­è¡¨</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 100px 20px; color: var(--text); }
    
    .header { margin-bottom: 15px; }
    .status-bar { font-size: 13px; color: #6B7280; margin-top: 5px; background: #EEF2FF; padding: 8px; border-radius: 8px; display: inline-block; }
    .controls { display: flex; gap: 8px; margin-top: 10px; }
    select, button { padding: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
    button { background: var(--text); color: white; border: none; }

    .table-wrapper { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #F3F4F6; font-size: 13px; white-space: nowrap; }
    th { background: #F9FAFB; font-weight: 700; height: 40px; }
    th:first-child, td:first-child { position: sticky; left: 0; background: var(--card); z-index: 10; border-right: 2px solid #F3F4F6; font-weight: 700; color: var(--primary); }
    th:first-child { background: #F9FAFB; z-index: 20; }

    .shift-sel { width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #E5E7EB; font-size: 12px; -webkit-appearance: none; background: white; text-align: center; font-weight: 700; }
    .shift-sel:disabled { background: #F3F4F6; color: #9CA3AF; border-color: #E5E7EB; opacity: 0.7; }
    
    .bg-EARLY { background-color: #D1FAE5 !important; color: #065F46 !important; border: 1px solid #10B981 !important; }
    .bg-LATE { background-color: #FEF3C7 !important; color: #92400E !important; border: 1px solid #F59E0B !important; }
    .bg-OFF { background-color: #F3F4F6 !important; color: #9CA3AF !important; border: 1px solid #E5E7EB !important; }
    
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; display: grid; grid-template-columns: repeat(4, 1fr); align-items: center; }
    .nav.is-manager { grid-template-columns: repeat(5, 1fr); }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; width: 100%; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
    #mgrBtn { display: none; } .nav.is-manager #mgrBtn { display: flex; }
  </style>
</head>
<body>

  <div class="header">
    <h2 style="margin:0;font-size:20px;">ğŸ“… åœ˜éšŠæ’ç­</h2>
    <div id="statusInfo" class="status-bar">è¼‰å…¥ä¸­...</div>
    <div class="controls">
      <select id="y"></select><select id="m"></select>
      <button onclick="load()">æŸ¥è©¢</button>
    </div>
  </div>

  <div class="table-wrapper">
    <div class="table-scroll">
      <table id="tbl">
        <thead><tr id="thRow"><th>å“¡å·¥</th></tr></thead>
        <tbody id="tbRow"><tr><td colspan="5" style="padding:30px;color:#999">è¼‰å…¥ä¸­...</td></tr></tbody>
      </table>
    </div>
  </div>

  <nav class="nav" id="bottomNav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span><span>ç”³è«‹</span></a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>ç´€éŒ„</span></a>
    <a href="schedule.html" class="nav-item active"><span class="nav-icon">ğŸ“…</span><span>æ’ç­</span></a>
    <a href="manager.html" class="nav-item" id="mgrBtn"><span class="nav-icon">ğŸ‘‘</span><span>ä¸»ç®¡</span></a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html'; // è£œä¸Šæœªç™»å…¥è¸¢å‡º

  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) { document.getElementById("bottomNav").classList.add('is-manager'); }

  const yS = document.getElementById("y");
  const mS = document.getElementById("m");
  const now = new Date();
  for(let i=2024; i<=2026; i++) yS.add(new Option(i,i,i===now.getFullYear(),i===now.getFullYear()));
  for(let i=1; i<=12; i++) mS.add(new Option(i,i,i===now.getMonth()+1,i===now.getMonth()+1));

  // â˜… æ ¸å¿ƒä¿®å¾©ï¼šç©©å®šçš„ API å‘¼å« (V106)
  function api(act, d = {}) {
    return new Promise((resolve, reject) => {
      // 1. ç”¢ç”Ÿå”¯ä¸€çš„ callback åç¨± (åªç”¢ç”Ÿä¸€æ¬¡ï¼Œå­˜å…¥è®Šæ•¸)
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);

      const s = document.createElement("script");
      const payload = encodeURIComponent(JSON.stringify({ ...d, userId: uid }));

      // 15ç§’è¶…æ™‚ä¿è­·
      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout: è«‹æ±‚é€¾æ™‚"));
      }, 15000);

      function cleanup() {
        clearTimeout(timer);
        try { delete window[cbName]; } catch (e) {}
        try { s.remove(); } catch (e) {}
      }

      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(act)}&payload=${payload}&callback=${cbName}`;

      window[cbName] = (res) => {
        cleanup();
        resolve(res);
      };

      s.onerror = () => {
        cleanup();
        reject(new Error("Network Error: é€£ç·šå¤±æ•—"));
      };

      document.body.appendChild(s);
    });
  }

  // â˜… è¼‰å…¥é‚è¼¯ (å«éŒ¯èª¤è™•ç†)
  async function load() {
    try {
      document.getElementById("statusInfo").innerText = "è¼‰å…¥ä¸­...";
      // æ¸…ç©ºèˆŠè³‡æ–™ï¼Œé¿å…èª¤æœƒ
      document.getElementById("tbRow").innerHTML = '<tr><td colspan="5" style="padding:30px;color:#999">è³‡æ–™è®€å–ä¸­...</td></tr>';

      const res = await api("get_roster_data", {year: yS.value, month: mS.value});
      
      if(!res.ok) { 
        document.getElementById("tbRow").innerHTML = `<tr><td style="color:red;padding:20px;">${res.message || 'è®€å–å¤±æ•—'}</td></tr>`; 
        document.getElementById("statusInfo").innerText = "è®€å–å¤±æ•—";
        return; 
      }

      // â˜… ç‹€æ…‹åˆ¤å®š (é–å®šé‚è¼¯)
      const today = new Date();
      const lockDay = res.lockDay || 25;
      const targetY = Number(yS.value);
      const targetM = Number(mS.value);
      
      const currentVal = today.getFullYear() * 12 + (today.getMonth() + 1);
      const targetVal = targetY * 12 + targetM;
      const isNextMonth = (targetVal === currentVal + 1);
      
      const isLocked = !res.isManager && (!isNextMonth || (isNextMonth && today.getDate() > lockDay));

      let info = "";
      if (res.isManager) info = "ğŸ‘‘ ä¸»ç®¡æ¨¡å¼ (å¯ä»»æ„ç·¨è¼¯)";
      else if (!isLocked) info = `ğŸŸ¢ é–‹æ”¾æ’ç­ä¸­ (æ¯æœˆ${lockDay}è™Ÿæˆªæ­¢)`;
      else if (!isNextMonth) info = "ğŸ”’ æœ¬æœˆ/éæœŸ/æœªä¾†ç­è¡¨å·²é–å®š";
      else info = `ğŸ”´ æ’ç­å·²æˆªæ­¢ (æˆªæ­¢æ—¥: ${lockDay}è™Ÿ)`;
      
      document.getElementById("statusInfo").innerText = info;
      if(isLocked) document.getElementById("statusInfo").style.color = "#EF4444";

      // è¡¨æ ¼ç¹ªè£½
      const days = new Date(yS.value, mS.value, 0).getDate();
      let head = `<th>å“¡å·¥</th>`;
      for(let d=1; d<=days; d++) {
          const wk = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(yS.value, mS.value-1, d).getDay()];
          const color = (wk==='æ—¥'||wk==='å…­') ? 'color:#EF4444' : '';
          head += `<th style="${color}">${d}<br><small>${wk}</small></th>`;
      }
      document.getElementById("thRow").innerHTML = head;

      let rows = "";
      res.employees.forEach(e => {
          let tds = `<td>${e.name}</td>`;
          for(let d=1; d<=days; d++) {
              const cell = (res.roster[e.id] && res.roster[e.id][d]) ? res.roster[e.id][d] : {};
              const dateStr = `${yS.value}-${String(mS.value).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
              
              if(cell.type === 'LEAVE') {
                  tds += `<td><span class="tag" style="background:#DBEAFE;color:#1E40AF;padding:2px 6px;border-radius:4px;font-size:11px;">${cell.value}</span></td>`;
              } else {
                  let v = cell.value || '';
                  let cls = '';
                  if(v==='æ—©ç­'||v==='EARLY') { v='æ—©ç­'; cls='bg-EARLY'; }
                  else if(v==='åˆç­'||v==='LATE') { v='åˆç­'; cls='bg-LATE'; }
                  else if(v==='ä¼‘å‡'||v==='OFF') { v='ä¼‘å‡'; cls='bg-OFF'; }
                  
                  const dis = isLocked ? 'disabled' : '';
                  
                  tds += `<td><select class="shift-sel ${cls}" ${dis} onchange="upd('${e.id}','${dateStr}',this)">
                    <option value="">-</option>
                    <option value="æ—©ç­" ${v==='æ—©ç­'?'selected':''}>æ—©</option>
                    <option value="åˆç­" ${v==='åˆç­'?'selected':''}>åˆ</option>
                    <option value="ä¼‘å‡" ${v==='ä¼‘å‡'?'selected':''}>ä¼‘</option>
                  </select></td>`;
              }
          }
          rows += `<tr>${tds}</tr>`;
      });
      document.getElementById("tbRow").innerHTML = rows;

    } catch (err) {
      document.getElementById("tbRow").innerHTML = `<tr><td style="color:red;padding:20px;">${err.message}</td></tr>`;
      document.getElementById("statusInfo").innerText = "é€£ç·šç•°å¸¸";
    }
  }

  function upd(eid, d, el) {
      el.className = 'shift-sel';
      if(el.value==='æ—©ç­') el.classList.add('bg-EARLY');
      if(el.value==='åˆç­') el.classList.add('bg-LATE');
      if(el.value==='ä¼‘å‡') el.classList.add('bg-OFF');
      
      api("update_schedule", {empId:eid, date:d, shift:el.value}).then(res => {
          if(!res.ok) { 
              alert(res.message); 
              el.value = ""; // é‚„åŸ
              el.className = 'shift-sel'; 
          }
      }).catch(err => {
          alert("æ›´æ–°å¤±æ•—: " + err.message);
      });
  }
  
  load();
</script>
</body>
</html>
