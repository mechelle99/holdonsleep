<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>排班</title>
<style>
  body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;}
  table{border-collapse:collapse;min-width:100%;}
  th,td{border:1px solid #ddd;text-align:center;min-width:40px;height:40px;font-size:12px;}
  .bg-early{background:#e3f2fd} .bg-late{background:#fff3e0}
</style>
</head>
<body>
  <div style="padding:10px;background:#eee;">
    <button onclick="location.href='app.html'">返回</button>
    <select id="y"></select><select id="m"></select>
    <button onclick="load()">刷</button>
    <div id="hols" style="margin-top:5px;font-size:12px;color:blue"></div>
  </div>
  <div style="flex:1;overflow:auto;">
    <table id="tbl"><thead><tr id="th"></tr></thead><tbody id="tb"></tbody></table>
  </div>
  <script src="config.js"></script>
  <script>
    const uid=localStorage.getItem("employeeId");
    const yS=document.getElementById("y"), mS=document.getElementById("m");
    for(let i=2024;i<=2026;i++) yS.add(new Option(i,i));
    for(let i=1;i<=12;i++) mS.add(new Option(i,i));
    const now=new Date(); yS.value=now.getFullYear(); mS.value=now.getMonth()+1;

    function api(a,d={}){
      return new Promise(r=>{
        const s=document.createElement("script");
        s.src=`${window.CONFIG.GAS_ENDPOINT}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d,userId:uid}))}&callback=cb${Date.now()}`;
        window[`cb${Date.now()}`]=(res)=>{r(res);s.remove()};
        document.body.appendChild(s);
      });
    }
    async function load(){
      const y=yS.value, m=mS.value;
      const days = new Date(y,m,0).getDate();
      let h="<th>員</th>"; for(let i=1;i<=days;i++) h+=`<th>${i}</th>`;
      document.getElementById("th").innerHTML=h;
      document.getElementById("tb").innerHTML="<tr><td colspan='32'>讀取中...</td></tr>";
      
      const r = await api("get_roster_data",{year:y,month:m});
      if(r.ok){
        document.getElementById("hols").innerText = `本月應休: ${r.holidayCount.total} 天 (週末:${r.holidayCount.weekends} + 國定:${r.holidayCount.national})`;
        let b="";
        r.employees.forEach(e=>{
          b+=`<tr><td>${e.name}</td>`;
          for(let i=1;i<=days;i++){
            const cell = (r.roster[e.id] && r.roster[e.id][i]) ? r.roster[e.id][i] : {};
            const v = cell.val || 'OFF';
            const cls = v==='EARLY'?'bg-early':(v==='LATE'?'bg-late':'');
            const txt = v==='EARLY'?'早':(v==='LATE'?'午':'');
            if(r.isManager) {
               b+=`<td class="${cls}"><select style="border:none;background:transparent;width:100%" onchange="save('${e.id}','${e.name}',${i},this.value)">
               <option value="OFF" ${v==='OFF'?'selected':''}></option>
               <option value="EARLY" ${v==='EARLY'?'selected':''}>早</option>
               <option value="LATE" ${v==='LATE'?'selected':''}>午</option></select></td>`;
            } else { b+=`<td class="${cls}">${txt}</td>`; }
          }
          b+="</tr>";
        });
        document.getElementById("tb").innerHTML=b;
      }
    }
    async function save(eid,nm,d,v){
      await api("update_schedule",{empId:eid,empName:nm,date:`${yS.value}-${mS.value}-${d}`,shift:v});
      load();
    }
    load();
  </script>
</body>
</html>
