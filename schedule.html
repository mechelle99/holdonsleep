<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>åœ˜éšŠæ’ç­</title>
  <style>
    :root{
      --primary:#4F46E5;
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --text:#111827;
      --muted:#6B7280;

      --shadow: 0 10px 26px rgba(17,24,39,.10);
      --shadow2: 0 6px 16px rgba(17,24,39,.06);

      --ok:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;

      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--text);
      padding: 18px 18px calc(96px + env(safe-area-inset-bottom)) 18px;
    }

    .hero{
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      border-radius: 26px;
      padding: 18px;
      box-shadow: var(--shadow);
      color:#fff;
      margin-bottom: 14px;
    }
    .hero h2{
      margin:0;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .hero .sub{
      margin-top: 8px;
      font-size: 13px;
      opacity: .90;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.22);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 12px 0 14px 0;
      align-items:center;
    }
    .controls select{
      border:none;
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow2);
      font-size: 13px;
      outline:none;
      min-width: 88px;
    }
    .controls button{
      border:none;
      background: var(--primary);
      color:#fff;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .controls button:active{ transform: scale(.99); }

    .card{
      background:var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      border: 1px solid rgba(17,24,39,.06);
    }
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    table{ width:100%; border-collapse:collapse; min-width: 900px; }
    th, td{
      padding: 12px 10px;
      text-align:center;
      border-bottom: 1px solid rgba(17,24,39,.06);
      font-size: 13px;
      white-space: nowrap;
    }
    thead th{
      background:#F9FAFB;
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    th:first-child, td:first-child{
      position: sticky;
      left: 0;
      z-index: 12;
      background: #fff;
      border-right: 2px solid rgba(17,24,39,.06);
      font-weight: 900;
      color: var(--primary);
      text-align:left;
      padding-left: 14px;
      min-width: 140px;
    }
    thead th:first-child{
      z-index: 25;
      background:#F9FAFB;
    }

    .dayHead{
      line-height:1.15;
      font-weight: 900;
    }
    .dayHead small{
      display:block;
      margin-top: 4px;
      font-weight: 900;
      opacity: .72;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 44px;
      padding: 8px 10px;
      border-radius: 14px;
      font-weight: 900;
      border: 1px solid rgba(17,24,39,.10);
      background:#fff;
      color:#111827;
    }
    .badge-early{
      background: rgba(16,185,129,.14);
      border-color: rgba(16,185,129,.45);
      color:#065F46;
    }
    .badge-late{
      background: rgba(245,158,11,.16);
      border-color: rgba(245,158,11,.50);
      color:#92400E;
    }
    .badge-off{
      background: rgba(156,163,175,.16);
      border-color: rgba(156,163,175,.35);
      color:#6B7280;
    }
    .badge-leave{
      background: rgba(59,130,246,.14);
      border-color: rgba(59,130,246,.45);
      color:#1E40AF;
      min-width: 70px;
      padding: 8px 12px;
      border-radius: 14px;
    }

    .shift-sel{
      width: 74px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.10);
      background:#fff;
      font-weight: 900;
      text-align:center;
      outline:none;
      box-shadow: none;
      -webkit-appearance: none;
      appearance: none;
      cursor:pointer;
    }
    .shift-sel.badge-early{
      background: rgba(16,185,129,.14);
      border-color: rgba(16,185,129,.45);
      color:#065F46;
    }
    .shift-sel.badge-late{
      background: rgba(245,158,11,.16);
      border-color: rgba(245,158,11,.50);
      color:#92400E;
    }
    .shift-sel.badge-off{
      background: rgba(156,163,175,.16);
      border-color: rgba(156,163,175,.35);
      color:#6B7280;
    }
    .shift-sel:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .empty{
      text-align:center;
      padding: 26px 18px;
      color: #9CA3AF;
      font-weight: 900;
    }
    .toast{
      position: fixed;
      left: 16px; right: 16px;
      top: calc(16px + env(safe-area-inset-top));
      background: #111827;
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      display:none;
      z-index: 9999;
      font-size: 13px;
      line-height: 1.4;
    }

    .nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px 18px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      box-shadow: 0 -10px 30px rgba(17,24,39,.08);
      display:flex;
      justify-content: space-around;
      z-index: 1000;
    }
    .nav-item{
      text-decoration:none;
      color:#9CA3AF;
      display:flex; flex-direction:column; align-items:center;
      gap: 4px;
      font-size: 10px;
      font-weight: 900;
    }
    .nav-item.active{ color: var(--primary); }
    .nav-icon{ font-size: 22px; }
    #mgrBtn{ display:none; }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <section class="hero">
    <h2>ğŸ“… åœ˜éšŠæ’ç­</h2>
    <div class="sub">
      <span class="pill" id="modeTag">è¼‰å…¥ä¸­â€¦</span>
      <span class="pill" id="rangeTag">ç¯©é¸ï¼šâ€”</span>
      <span class="pill" id="lockTag" style="display:none;">â€”</span>
    </div>
  </section>

  <div class="controls">
    <select id="y"></select>
    <select id="m"></select>
    <button type="button" id="btnLoad">æŸ¥è©¢</button>
  </div>

  <div class="card">
    <div class="table-scroll">
      <table>
        <thead>
          <tr id="thRow">
            <th>å“¡å·¥</th>
          </tr>
        </thead>
        <tbody id="tbRow">
          <tr><td class="empty" colspan="10">è¼‰å…¥ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <nav class="nav" id="bottomNav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item active"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½ & å°å·¥å…·
     * ============================== */

    const uid =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      localStorage.getItem("lineUserId") ||
      localStorage.getItem("LineUserId") ||
      localStorage.getItem("userId") ||
      "";

    if(!uid) location.href="index.html";

    // âœ… æ–°å¢ï¼šåœ¨è¼‰å…¥æ™‚å°±æ ¹æ“š localStorage é¡¯ç¤ºä¸»ç®¡æŒ‰éˆ• (ä¿æŒ UI ä¸€è‡´ä¸é–ƒçˆ)
    if (localStorage.getItem("isManager") === "true") {
      document.getElementById("mgrBtn").style.display = "flex";
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.style.display="none", 2400);
    }
    function pad2(n){ return String(n).padStart(2,'0'); }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    /* ==============================
     * 1) JSONP APIï¼ˆçµ±ä¸€ action + payloadï¼‰
     * ============================== */
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        const ENDPOINT = window.CONFIG && (window.CONFIG.GAS_ENDPOINT || window.CONFIG.API_BASE || window.CONFIG.API_URL);
        if(!ENDPOINT){
          reject(new Error("Missing CONFIG.GAS_ENDPOINT"));
          return;
        }

        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
        const s = document.createElement("script");

        const payloadObj = Object.assign({}, data, { userId: uid, empId: uid });

        if(window.CONFIG && window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null){
          payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
        }

        const payload = encodeURIComponent(JSON.stringify(payloadObj));
        const bust = Date.now();

        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("timeout"));
        }, 20000);

        function cleanup(){
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e){}
          try { s.remove(); } catch(e){}
        }

        window[cbName] = (res) => { cleanup(); resolve(res); };
        s.onerror = () => { cleanup(); reject(new Error("Network Error")); };

        const sep = ENDPOINT.includes("?") ? "&" : "?";
        s.src = `${ENDPOINT}${sep}action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${bust}`;
        document.body.appendChild(s);
      });
    }

    /* ==============================
     * 2) å¹´æœˆé¸å–®
     * ============================== */
    const yS = document.getElementById("y");
    const mS = document.getElementById("m");
    const now = new Date();

    const START_YEAR = 2024;
    const END_YEAR   = 2028;

    for(let y=START_YEAR; y<=END_YEAR; y++){
      yS.add(new Option(y, y, y===now.getFullYear(), y===now.getFullYear()));
    }
    for(let m=1; m<=12; m++){
      mS.add(new Option(m, m, m===now.getMonth()+1, m===now.getMonth()+1));
    }

    /* ==============================
     * 3) Shift/Leave å‘ˆç¾çµ±ä¸€ï¼ˆâœ… IN/OUT ä¸å†è¢«åƒæ‰ï¼‰
     * ============================== */
    function classifyShift(v){
      const raw = String(v||'').trim();
      const low = raw.toLowerCase();

      // âœ… ä»¥å‰ä½ æŠŠ IN/OUT ç›´æ¥å°æ­»æˆ '-'ï¼Œä¸»ç®¡æ”¹ä¸äº†ã€é‚„æœƒå›å¾©éŒ¯
      // ç¾åœ¨æ”¹æˆï¼šä¿ç•™ IN/OUT é¡¯ç¤ºèˆ‡ prevï¼Œä½†ä¸€æ¨£æ­¸é¡æˆ badge-off
      if(low === 'in' || low === 'out'){
        return { label: raw.toUpperCase(), cls:'badge-off', value: raw.toUpperCase() };
      }

      if(!raw || raw==='-') return { label:'-', cls:'badge-off', value:'' };

      if(raw==='æ—©ç­' || low==='early' || raw==='æ—©') return { label:'æ—©', cls:'badge-early', value:'æ—©ç­' };
      if(raw==='åˆç­' || low==='late'  || raw==='åˆ') return { label:'åˆ', cls:'badge-late',  value:'åˆç­' };
      if(raw==='ä¼‘å‡' || low==='off'   || raw==='ä¼‘') return { label:'ä¼‘', cls:'badge-off',   value:'ä¼‘å‡' };

      return { label: raw, cls:'badge-off', value: raw };
    }

    function getLeaveText(cell){
      if(!cell) return "";
      if(typeof cell === "string") return ""; // string ç•¶ shift ç”¨ï¼Œä¸ç•¶ leave
      if(cell.type === "LEAVE") return String(cell.value||"").trim();
      if(cell.isLeave) return String(cell.leaveText || cell.value || cell.leaveType || "").trim();
      if(cell.leaveType) return String(cell.leaveType).trim();
      if(cell.leaveText) return String(cell.leaveText).trim();
      return "";
    }

    function pickShiftValue(cell){
      if(cell == null) return "";
      if(typeof cell === "string") return cell;
      if(typeof cell.value === "string") return cell.value;
      if(typeof cell.shift === "string") return cell.shift;
      if(typeof cell.v === "string") return cell.v;
      return "";
    }

    /* ==============================
     * 4) é–å®šé‚è¼¯ï¼ˆå¾Œç«¯ isManager ç‚ºæº–ï¼‰
     * ============================== */
    function computeLock(res, targetY, targetM){
      const today = new Date();
      const lockDay = Number(res.lockDay || 25);

      const currentVal = today.getFullYear()*12 + (today.getMonth()+1);
      const targetVal  = targetY*12 + targetM;
      const isNextMonth = (targetVal === currentVal + 1);

      const isManager = !!res.isManager;

      const isLocked = (!isManager) && (!isNextMonth || (isNextMonth && today.getDate() > lockDay));

      return { isManager, isLocked, lockDay, isNextMonth };
    }

    /* ==============================
     * 5) roster å…¼å®¹è®€å–
     * ============================== */
    function getCell(roster, empId, d, dateStr){
      if(!roster) return null;
      const byEmp = roster[empId];
      if(!byEmp) return null;

      if(byEmp[d] != null) return byEmp[d];
      if(byEmp[dateStr] != null) return byEmp[dateStr];

      return null;
    }

    /* ==============================
     * 6) ä¸»æµç¨‹ï¼šload
     * ============================== */
    async function load(){
      const y = Number(yS.value);
      const m = Number(mS.value);

      document.getElementById("rangeTag").textContent = `ç¯©é¸ï¼š${y}-${pad2(m)}`;

      const modeTag = document.getElementById("modeTag");
      const lockTag = document.getElementById("lockTag");
      lockTag.style.display = "none";

      modeTag.textContent = "è¼‰å…¥ä¸­â€¦";
      document.getElementById("tbRow").innerHTML =
        `<tr><td class="empty" colspan="10">è³‡æ–™è®€å–ä¸­â€¦</td></tr>`;

      try{
        const res = await api("get_roster_data", { year:y, month:m });

        if(!res || !res.ok){
          modeTag.textContent = "è®€å–å¤±æ•—";
          toast(res && res.message ? res.message : "è®€å–å¤±æ•—");
          document.getElementById("tbRow").innerHTML =
            `<tr><td class="empty" colspan="10" style="color:#EF4444">è®€å–å¤±æ•—</td></tr>`;
          return;
        }

        const { isManager, isLocked, lockDay } = computeLock(res, y, m);

        if(isManager){
          modeTag.textContent = "ğŸ‘‘ ä¸»ç®¡æ¨¡å¼ï¼ˆå¯ä»»æ„ç·¨è¼¯ï¼‰";
        }else{
          modeTag.textContent = "ğŸ‘¤ å“¡å·¥æ¨¡å¼";
          lockTag.style.display = "inline-flex";
          lockTag.textContent = isLocked ? `ğŸ”’ å·²é–å®šï¼ˆæ¯æœˆ${lockDay}è™Ÿæˆªæ­¢ï¼‰` : `ğŸŸ¢ é–‹æ”¾æ’ç­ä¸­ï¼ˆæ¯æœˆ${lockDay}è™Ÿæˆªæ­¢ï¼‰`;
        }

        // ç¢ºèªä¸€æ¬¡ API å›å‚³çš„æ¬Šé™
        document.getElementById("mgrBtn").style.display = isManager ? "flex" : "none";

        const days = new Date(y, m, 0).getDate();
        let head = `<th>å“¡å·¥</th>`;
        for(let d=1; d<=days; d++){
          const wk = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(y, m-1, d).getDay()];
          const isWeekend = (wk==='æ—¥' || wk==='å…­');
          head += `<th class="dayHead" style="${isWeekend ? 'color:#EF4444' : ''}">
                    ${d}<small>${wk}</small>
                  </th>`;
        }
        document.getElementById("thRow").innerHTML = head;

        const employees = Array.isArray(res.employees) ? res.employees : [];
        const roster = res.roster || {};

        if(employees.length === 0){
          document.getElementById("tbRow").innerHTML =
            `<tr><td class="empty" colspan="${days+1}">æ²’æœ‰å¯æ’ç­çš„äººå“¡</td></tr>`;
          return;
        }

        let rows = "";
        employees.forEach(e=>{
          const empId = e.empId || e.id || e.employeeId || "";
          const empName = e.empName || e.name || empId || "â€”";
          let tds = `<td>${escapeHtml(empName)}</td>`;

          for(let d=1; d<=days; d++){
            const dateStr = `${y}-${pad2(m)}-${pad2(d)}`;
            const cell = getCell(roster, empId, d, dateStr);

            const leaveText = getLeaveText(cell);
            if(leaveText){
              tds += `<td><span class="badge badge-leave">${escapeHtml(leaveText)}</span></td>`;
              continue;
            }

            const shiftVal = pickShiftValue(cell);
            const shiftInfo = classifyShift(shiftVal);

            if(isManager){
              // âœ… ä¸»ç®¡ï¼šIN/OUT ä¹Ÿèƒ½æ”¹ï¼ˆä¸¦ä¿ç•™ prev ä»¥ä¾¿å›å¾©ï¼‰
              tds += `
                <td>
                  <select class="shift-sel ${shiftInfo.cls}"
                          data-prev="${escapeHtml(shiftInfo.value||'')}"
                          onchange="upd('${String(empId).replace(/'/g,"\\'")}','${dateStr}',this)">
                    <option value="" ${shiftInfo.value===''?'selected':''}>-</option>
                    <option value="æ—©ç­" ${shiftInfo.value==='æ—©ç­'?'selected':''}>æ—©</option>
                    <option value="åˆç­" ${shiftInfo.value==='åˆç­'?'selected':''}>åˆ</option>
                    <option value="ä¼‘å‡" ${shiftInfo.value==='ä¼‘å‡'?'selected':''}>ä¼‘</option>
                    <option value="IN" ${shiftInfo.value==='IN'?'selected':''}>IN</option>
                    <option value="OUT" ${shiftInfo.value==='OUT'?'selected':''}>OUT</option>
                  </select>
                </td>`;
            }else{
              tds += `<td><span class="badge ${shiftInfo.cls}">${escapeHtml(shiftInfo.label)}</span></td>`;
            }
          }

          rows += `<tr>${tds}</tr>`;
        });

        document.getElementById("tbRow").innerHTML = rows;

      }catch(err){
        toast("é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œé‡è©¦");
        document.getElementById("tbRow").innerHTML =
          `<tr><td class="empty" colspan="10" style="color:#EF4444">é€£ç·šç•°å¸¸</td></tr>`;
        document.getElementById("modeTag").textContent = "é€£ç·šç•°å¸¸";
      }
    }

    /* ==============================
     * 7) æ›´æ–°æ’ç­ï¼ˆä¸»ç®¡ç·¨è¼¯ï¼‰
     * ============================== */
    function upd(targetEmpId, dateStr, el){
      const prev = el.getAttribute("data-prev") || "";
      const next = String(el.value||"").trim();

      el.classList.remove('badge-early','badge-late','badge-off');
      const info = classifyShift(next);
      el.classList.add(info.cls);

      api("update_schedule", { targetEmpId, date: dateStr, shift: next })
        .then(res=>{
          if(!res || !res.ok){
            toast(res && res.message ? res.message : "æ›´æ–°å¤±æ•—");

            el.value = prev;
            el.classList.remove('badge-early','badge-late','badge-off');
            const back = classifyShift(prev);
            el.classList.add(back.cls);
          }else{
            toast("âœ… å·²æ›´æ–°");
            el.setAttribute("data-prev", next);
          }
        })
        .catch(()=>{
          toast("æ›´æ–°å¤±æ•—ï¼šç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚");

          el.value = prev;
          el.classList.remove('badge-early','badge-late','badge-off');
          const back = classifyShift(prev);
          el.classList.add(back.cls);
        });
    }

    document.getElementById("btnLoad").addEventListener("click", load);
    load();
  </script>
</body>
</html>
