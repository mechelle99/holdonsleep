<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é–€å¸‚æ’ç­ç®¡ç†</title>
  
  <link rel="icon" href="./assets/icon/favicon.ico">

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f4f6f8; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 6px; margin-bottom: 20px; font-size: 14px; transition: background 0.2s; }
    .btn-back:hover { background: #555; }
    
    /* çµ±è¨ˆå€å¡Š */
    .quota-box { background:#e3f2fd; color:#0d47a1; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; }
    .btn-approve-all { background: #007aff; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }
    .btn-approve-all:hover { background: #005bb5; }
    .btn-approve-all:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Modal å½ˆçª— */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    
    /* è¡¨å–®å…ƒä»¶ */
    select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
    label { display: block; margin-top: 15px; font-size: 14px; color: #666; }
    
    /* æŒ‰éˆ•ç¾¤çµ„ */
    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; min-width: 80px; transition: opacity 0.2s; }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-save { background: #007aff; color: #fff; }
    .btn-approve { background: #28a745; color: #fff; display: none; }
    .btn-del { background: #dc3545; color: #fff; display: none; }
    .btn-request { background: #ff9800; color: #fff; display: none; } /* æ”¹ç­ç”³è«‹æŒ‰éˆ• */
    .btn-close { background: #eee; color: #333; }

    /* Loading é®ç½© */
    #loadingOverlay {
      display: none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.8); z-index: 2000;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color:#555; font-weight:bold;">è³‡æ–™å‚³è¼¸ä¸­...</div>
  </div>

  <div class="container">
    <a href="manager.html" class="btn-back">â† å›ä¸»ç®¡é </a>
    
    <div class="quota-box">
      <span id="currentMonthStr" style="font-weight:bold; font-size:18px;">...</span> 
      <br>
      æ‡‰ä¼‘å¤©æ•¸ï¼š<span id="monthlyQuota" style="font-size:24px; font-weight:bold; color:#c22;">-</span> å¤©
      <div id="quotaDetail" style="font-size:13px; color:#555; margin-top:5px;"></div>
      <button id="btnApproveAll" class="btn-approve-all" onclick="approveMonthAll()">âœ… ä¸€éµæ ¸å‡†æœ¬æœˆæ‰€æœ‰ç­è¡¨</button>
    </div>

    <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
      <span style="color:#3788d8">â— æ—©ç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#dc3545">â— åˆç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#6c757d">â— å¾…æ ¸å‡†</span> &nbsp;
      <span style="color:#000000">â— æ› è·</span>
    </div>
    <div id='calendar'></div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’ç­è¨­å®š</h3>
      <input type="hidden" id="selectedDate">
      
      <label>é¸æ“‡å“¡å·¥</label>
      <select id="empSelect"><option value="">è¼‰å…¥ä¸­...</option></select>

      <label>ç­åˆ¥</label>
      <select id="shiftSelect">
        <option value="æ—©ç­">â˜€ï¸ æ—©ç­ (10:00-18:00)</option>
        <option value="åˆç­">ğŸŒ™ åˆç­ (12:00-21:00)</option>
      </select>
      
      <div id="statusInfo" style="margin-top:10px; font-size:12px; color:#888;"></div>

      <div class="btn-group">
        <button class="btn-approve" id="btnApprove" onclick="approveEvent()">âœ… æ ¸å‡†</button>
        <button class="btn-del" id="btnDelete" onclick="deleteEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="btn-request" id="btnRequest" onclick="requestChange()">ğŸ“£ ç”³è«‹æ”¹ç­</button>
        <button class="btn-save" id="btnSave" onclick="saveEvent()">ğŸ’¾ å„²å­˜</button>
        <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  
  <script>
    // 1. è¨­å®šèˆ‡è®Šæ•¸
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    // ğŸ”¥ é‡è¦ï¼šå¾ Config å–å¾— API Keyï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼ (éœ€èˆ‡å¾Œç«¯ Script Properties ä¸€è‡´)
    const API_KEY = window.CONFIG?.API_KEY || "MY_SECRET_KEY_2026"; 
    
    const userId = localStorage.getItem("employeeId");
    const userName = localStorage.getItem("employeeName") || "Unknown";

    let isManager = false; 
    let calendar;
    let currentYear, currentMonth;
    let currentEventObj = null;

    // 2. Loading æ§åˆ¶
    function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
    function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

    // 3. ğŸ”¥ é€šç”¨ API è«‹æ±‚å‡½å¼ (CORS å‹å–„ç‰ˆ)
    // é‡é»ï¼šç§»é™¤ Content-Type headerï¼Œé¿å…è§¸ç™¼ Preflight OPTIONS è«‹æ±‚
    async function postToGAS(action, dataObj = {}) {
      if (!ENDPOINT) { alert("å°šæœªè¨­å®š GAS ç¶²å€ (config.js)"); return { ok: false }; }
      
      const payload = { 
        action: action, 
        userId: userId, 
        displayName: userName, 
        userAgent: navigator.userAgent, // å‚³é€è£ç½®è³‡è¨Š
        apiKey: API_KEY,                // å‚³é€ API Key
        data: dataObj 
      };

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          // ğŸ”¥ é—œéµï¼šä¸è¨­å®š headersï¼Œç€è¦½å™¨æœƒä½¿ç”¨é è¨­ text/plainï¼Œé¿é–‹ CORS æª¢æŸ¥
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹
        if (!res.ok) {
          console.error("HTTP Error:", res.status, text);
          if (res.status === 403) return { ok: false, message: "å­˜å–è¢«æ‹’ (403): è«‹æª¢æŸ¥ Webhook è¨­å®š" };
          return { ok: false, message: `ä¼ºæœå™¨éŒ¯èª¤ (HTTP ${res.status})`, raw: text.slice(0, 150) };
        }
        
        // è§£æ JSON
        try {
          return JSON.parse(text);
        } catch (e) {
          console.error("Non-JSON Response:", text);
          return { ok: false, message: "ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ (å¯èƒ½ç‚º HTML)", raw: text.slice(0, 150) };
        }
      } catch (e) {
        console.error(e);
        return { ok: false, message: "ç¶²è·¯é€£ç·šå¤±æ•— (CORS æˆ– ç¶²è·¯ä¸­æ–·)" };
      }
    }

    // 4. åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      // æª¢æŸ¥ç™»å…¥
      if (!userId) { 
        alert("è«‹å…ˆç™»å…¥");
        location.href = "index.html"; 
        return; 
      }

      showLoading(); 
      await loadEmployees(); // è¼‰å…¥å“¡å·¥èˆ‡æ¬Šé™

      // åˆå§‹åŒ–æ—¥æ›†
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-tw',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
        height: 'auto',
        events: fetchEvents,
        
        // é»æ“Šæ—¥æœŸï¼šæ–°å¢æ’ç­
        dateClick: function(info) { openModal(info.dateStr, null); },
        
        // é»æ“Šäº‹ä»¶ï¼šç·¨è¼¯/æŸ¥çœ‹
        eventClick: function(info) { 
          // ç³»çµ±å›ºå®šç­è¡¨ä¸èƒ½æ”¹
          if (info.event.extendedProps.type === 'auto') {
            alert("é€™æ˜¯å›ºå®šç­è¡¨ (è‡ªå‹•ç”¢ç”Ÿ)ï¼Œç„¡æ³•ç·¨è¼¯ã€‚");
            return;
          }
          // æ¨‚è§€ UI çš„å‡äº‹ä»¶ä¸èƒ½é»
          if (info.event.extendedProps.temp) {
            alert("âš ï¸ è³‡æ–™å¯«å…¥ä¸­ï¼Œè«‹ç¨å€™å†æ“ä½œ...");
            return;
          }
          openModal(info.event.startStr, info.event); 
        }
      });
      calendar.render();
    });

    // 5. è¼‰å…¥å“¡å·¥åˆ—è¡¨èˆ‡åˆ¤æ–·æ¬Šé™
    async function loadEmployees() {
      const json = await postToGAS("get_all_employees");
      const sel = document.getElementById("empSelect");
      sel.innerHTML = "";
      
      if (json.ok) {
        isManager = json.isManager;
        if (isManager) document.getElementById("btnApproveAll").style.display = "inline-block";
        
        json.list.forEach(emp => {
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = emp.name;
          sel.appendChild(opt);
        });
      } else {
        alert("ç„¡æ³•è¼‰å…¥å“¡å·¥è³‡æ–™ï¼š" + json.message);
      }
    }

    // 6. æŠ“å–ç­è¡¨ (FullCalendar å‘¼å«)
    async function fetchEvents(info, successCallback, failureCallback) {
      showLoading();
      
      // è¨ˆç®—ç•¶å‰é¡¯ç¤ºçš„æœˆä»½
      const start = info.start; 
      const end = info.end; 
      const mid = new Date((start.getTime() + end.getTime()) / 2);
      
      currentYear = mid.getFullYear();
      currentMonth = mid.getMonth() + 1;
      
      document.getElementById("currentMonthStr").textContent = `${currentYear}å¹´ ${currentMonth}æœˆ`;
      updateMonthlyQuota(currentYear, currentMonth); // æ›´æ–°æ‡‰ä¼‘å¤©æ•¸

      const json = await postToGAS("get_schedule", { start: info.startStr, end: info.endStr });
      
      hideLoading();

      if (json.ok) {
        successCallback(json.events);
      } else {
        failureCallback(json.message);
        console.error(json.message);
      }
    }

    // 7. æ›´æ–°æ‡‰ä¼‘å¤©æ•¸
    async function updateMonthlyQuota(year, month) {
      const elDays = document.getElementById("monthlyQuota");
      const elMsg = document.getElementById("quotaDetail");
      elDays.textContent = "...";
      
      const json = await postToGAS("get_month_quota", { year, month });
      if (json.ok) { 
        elDays.textContent = json.days; 
        elMsg.textContent = json.msg; 
      } else { 
        elDays.textContent = "??"; 
      }
    }

    // 8. æ‰¹é‡æ ¸å‡†
    async function approveMonthAll() {
      if(!confirm(`ç¢ºå®šæ ¸å‡† ${currentYear}å¹´${currentMonth}æœˆ æ‰€æœ‰ç­è¡¨ï¼Ÿ`)) return;
      
      const btn = document.getElementById("btnApproveAll");
      btn.disabled = true; btn.textContent = "è™•ç†ä¸­...";
      
      const json = await postToGAS("approve_month_all", { year: currentYear, month: currentMonth });
      alert(json.message);
      calendar.refetchEvents();
      
      btn.disabled = false; btn.textContent = "âœ… ä¸€éµæ ¸å‡†æœ¬æœˆæ‰€æœ‰ç­è¡¨";
    }

    // 9. æ‰“é–‹ Modal (æ ¸å¿ƒ UI é‚è¼¯)
    function openModal(dateStr, eventObj) {
      document.getElementById("eventModal").style.display = "flex";
      document.getElementById("selectedDate").value = dateStr;
      currentEventObj = eventObj; 
      
      const btnSave = document.getElementById("btnSave");
      const btnDel = document.getElementById("btnDelete");
      const btnApprove = document.getElementById("btnApprove");
      const btnRequest = document.getElementById("btnRequest");
      const empSel = document.getElementById("empSelect");
      const shiftSel = document.getElementById("shiftSelect");
      const info = document.getElementById("statusInfo");

      // é è¨­é¡¯ç¤ºç‹€æ…‹
      btnSave.style.display = "block";
      btnDel.style.display = "none";
      btnApprove.style.display = "none";
      btnRequest.style.display = "none";
      empSel.disabled = false;
      info.textContent = "";
      info.style.color = "#888";

      // é‡ç½®æŒ‰éˆ•å¯ç”¨æ€§
      btnSave.disabled = false; btnSave.textContent = "ğŸ’¾ å„²å­˜";
      btnDel.disabled = false; btnDel.textContent = "ğŸ—‘ï¸ åˆªé™¤";
      btnApprove.disabled = false; btnApprove.textContent = "âœ… æ ¸å‡†";
      btnRequest.disabled = false; btnRequest.textContent = "ğŸ“£ ç”³è«‹æ”¹ç­";

      if (eventObj) {
        // --- ç·¨è¼¯æ¨¡å¼ ---
        document.getElementById("modalTitle").textContent = `${dateStr} æ’ç­è©³æƒ…`;
        empSel.value = eventObj.extendedProps.empId;
        empSel.disabled = true; // ç·¨è¼¯æ™‚ä¸èƒ½æ”¹äºº
        shiftSel.value = eventObj.extendedProps.shift || "æ—©ç­";

        const status = eventObj.extendedProps.reqStatus; 
        info.textContent = `ç‹€æ…‹ï¼š${status}`;

        if (status === "APPROVED") {
          // å·²æ ¸å‡†ç‹€æ…‹
          btnSave.style.display = "none"; // ä¸èƒ½ç›´æ¥å„²å­˜ä¿®æ”¹
          if (isManager) {
            btnDel.style.display = "block"; // ä¸»ç®¡å¯ä»¥åˆª
          } else {
            // å“¡å·¥åªèƒ½ç”³è«‹æ”¹ç­
            btnDel.style.display = "none";
            btnRequest.style.display = "block"; 
            info.textContent = "ç‹€æ…‹ï¼šå·²æ ¸å‡†ï¼ˆå¦‚éœ€èª¿ç­ï¼Œè«‹é»æ“Šç”³è«‹ï¼‰";
            info.style.color = "#d9534f";
          }
        } else {
          // PENDING ç‹€æ…‹
          btnDel.style.display = "block"; 
          if (isManager) { 
            btnApprove.style.display = "block"; 
            btnSave.style.display = "none"; // ä¸»ç®¡æ ¸å‡†å°±å¥½ï¼Œä¸ç”¨å„²å­˜
          }
        }
      } else {
        // --- æ–°å¢æ¨¡å¼ ---
        document.getElementById("modalTitle").textContent = `æ–°å¢æ’ç­ (${dateStr})`;
        shiftSel.value = "æ—©ç­";
        // éä¸»ç®¡åªèƒ½é¸è‡ªå·±
        if (!isManager) { empSel.value = userId; empSel.disabled = true; }
      }
    }

    function closeModal() { document.getElementById("eventModal").style.display = "none"; }

    // 10. å„²å­˜ (æ–°å¢æ’ç­)
    async function saveEvent() {
      const empSel = document.getElementById("empSelect");
      const dateVal = document.getElementById("selectedDate").value;
      const shiftVal = document.getElementById("shiftSelect").value;
      const empNameText = empSel.options[empSel.selectedIndex].text;
      const empIdVal = empSel.value;

      if (!empIdVal) { alert("è«‹å…ˆé¸æ“‡å“¡å·¥"); return; }

      const btn = document.getElementById("btnSave");
      btn.disabled = true; btn.textContent = "å„²å­˜ä¸­...";

      // æ¨‚è§€ UI: å…ˆç•«ä¸€å€‹åŠé€æ˜äº‹ä»¶
      const fakeEvent = {
        title: `${empNameText} (${shiftVal})`,
        start: dateVal,
        color: isManager ? (shiftVal.includes("åˆ") ? "#dc3545" : "#3788d8") : "#6c757d", 
        extendedProps: { 
          empId: empIdVal, 
          reqStatus: isManager?"APPROVED":"PENDING", 
          shift: shiftVal, 
          type: 'manual', 
          temp: true 
        }
      };
      const addedEvent = calendar.addEvent(fakeEvent);
      closeModal();

      const json = await postToGAS("add_schedule", {
        date: dateVal, empId: empIdVal, empName: empNameText, shift: shiftVal
      });

      if (!json.ok) {
        addedEvent.remove(); // å¤±æ•—å›æ»¾
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + json.message);
      } else {
        addedEvent.remove(); // ç§»é™¤å‡äº‹ä»¶
        calendar.refetchEvents(); // é‡æŠ“çœŸäº‹ä»¶ (ç²å–æ­£ç¢º ID)
      }
    }

    // 11. åˆªé™¤
    async function deleteEvent() {
      if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
      if (!currentEventObj) return;

      const btn = document.getElementById("btnDelete");
      btn.disabled = true; btn.textContent = "åˆªé™¤ä¸­...";

      const targetDate = document.getElementById("selectedDate").value;
      const targetEmpId = currentEventObj.extendedProps.empId;
      const targetScheduleId = currentEventObj.extendedProps.scheduleId; 

      currentEventObj.remove(); // æ¨‚è§€åˆªé™¤
      closeModal();

      const json = await postToGAS("del_schedule", {
        date: targetDate, empId: targetEmpId, scheduleId: targetScheduleId
      });

      if (!json.ok) {
        alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + json.message);
        calendar.refetchEvents(); // å¤±æ•—å°±æŠŠäº‹ä»¶è£œå›ä¾†
      }
    }

    // 12. æ ¸å‡†
    async function approveEvent() {
      if (!currentEventObj) return;
      const btn = document.getElementById("btnApprove");
      btn.disabled = true; btn.textContent = "æ ¸å‡†ä¸­...";

      const targetDate = document.getElementById("selectedDate").value;
      const targetEmpId = currentEventObj.extendedProps.empId;
      const targetScheduleId = currentEventObj.extendedProps.scheduleId;

      const json = await postToGAS("approve_schedule", {
        date: targetDate, empId: targetEmpId, scheduleId: targetScheduleId
      });
      
      alert(json.message);
      
      if(json.ok) { 
        closeModal(); 
        calendar.refetchEvents(); 
      } else {
        btn.disabled = false; btn.textContent = "âœ… æ ¸å‡†"; 
      }
    }

    // 13. æ”¹ç­ç”³è«‹ (æ–°åŠŸèƒ½)
    async function requestChange() {
      if (!currentEventObj) return;
      
      const currentShift = currentEventObj.extendedProps.shift;
      // è‡ªå‹•åˆ¤å®šå°èª¿ç­åˆ¥
      const targetShift = currentShift === "æ—©ç­" ? "åˆç­" : "æ—©ç­";
      
      const reason = prompt(`æ‚¨ç›®å‰æ˜¯ ${currentShift}ï¼Œæƒ³ç”³è«‹æ”¹æˆ ${targetShift} å—ï¼Ÿ\nè«‹è¼¸å…¥æ”¹ç­åŸå› ï¼š`, "è‡¨æ™‚æœ‰äº‹");
      if (!reason) return; // å–æ¶ˆ

      const btn = document.getElementById("btnRequest");
      btn.disabled = true; btn.textContent = "ç”³è«‹ä¸­...";

      const targetDate = document.getElementById("selectedDate").value;
      const targetEmpId = currentEventObj.extendedProps.empId;
      const targetScheduleId = currentEventObj.extendedProps.scheduleId;

      const json = await postToGAS("request_schedule_change", {
        date: targetDate,
        empId: targetEmpId,
        scheduleId: targetScheduleId,
        fromShift: currentShift,
        toShift: targetShift,
        reason: reason
      });

      alert(json.message);
      closeModal();
    }
  </script>
</body>
</html>
