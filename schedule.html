<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>排班管理表</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:10px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    .controls{display:flex;gap:10px;align-items:center;}
    .table-container { overflow-x: auto; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); padding-bottom: 10px; }
    table { width:100%; border-collapse: collapse; min-width: 800px; font-size: 13px; }
    th, td { border: 1px solid #eee; padding: 8px; text-align: center; white-space: nowrap; }
    th { background: #f8f9fa; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    .col-emp { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #ddd; font-weight: bold; }
    .shift-select { border:1px solid #ddd; padding:4px; border-radius:4px; width:100%; }
    .cell-early { background-color: #e3f2fd; } 
    .cell-late { background-color: #fff3e0; }
    .cell-off { background-color: #f5f5f5; color:#999; }
    .cell-leave { background-color: #ffebee; color:#c62828; font-weight:bold; cursor: not-allowed; }
    .btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:#fff; }
    .btn-back { background:#333; text-decoration:none; display:inline-block; font-size:14px;}
    .btn-save { background:#28a745; }
    .btn-approve { background:#6f42c1; }
    .hidden{display:none;}
    #loading { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:99;}
  </style>
</head>
<body>
<div id="loading">載入資料中...</div>
<div class="header">
  <a href="app.html" class="btn btn-back">← 回首頁</a>
  <div class="controls">
    <select id="selYear"></select>
    <select id="selMonth"></select>
    <button class="btn btn-save" onclick="loadRoster()">重新載入</button>
  </div>
</div>
<div class="table-container">
  <table id="rosterTable">
    <thead>
      <tr id="dateRow">
        <th class="col-emp">員工</th>
      </tr>
    </thead>
    <tbody id="rosterBody"></tbody>
  </table>
</div>
<div style="margin-top:15px; text-align:right;">
  <span style="font-size:12px; color:#666; margin-right:10px;">* 灰色:休假 / 藍色:早班 / 橘色:午班 / 紅色:已請假(鎖定)</span>
  <button id="btnBatchApprove" class="btn btn-approve hidden" onclick="approveAll()">主管：核准本月所有班表</button>
</div>
<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");
  let isManager = false;
  if(!userId) location.href="index.html";

  const now = new Date();
  const ySel = document.getElementById("selYear");
  const mSel = document.getElementById("selMonth");
  for(let y=now.getFullYear()-1; y<=now.getFullYear()+1; y++){
    ySel.add(new Option(y+"年", y, y===now.getFullYear(), y===now.getFullYear()));
  }
  for(let m=1; m<=12; m++){
    mSel.add(new Option(m+"月", m, m===(now.getMonth()+1), m===(now.getMonth()+1)));
  }

  function api(act, data={}){
    document.getElementById("loading").style.display="flex";
    return new Promise((resolve, reject)=>{
      const cb = "cb"+Date.now();
      const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
      window[cb] = (res) => { resolve(res); try{delete window[cb];document.body.removeChild(s);}catch(e){} document.getElementById("loading").style.display="none"; };
      s.onerror = () => { alert("連線失敗"); document.getElementById("loading").style.display="none"; };
      document.body.appendChild(s);
    });
  }

  async function loadRoster(){
    const y = ySel.value;
    const m = mSel.value;
    const daysInMonth = new Date(y, m, 0).getDate();
    
    const dateRow = document.getElementById("dateRow");
    dateRow.innerHTML = '<th class="col-emp">員工</th>';
    for(let i=1; i<=daysInMonth; i++){
      const dayOfWeek = new Date(y, m-1, i).getDay();
      const color = (dayOfWeek===0||dayOfWeek===6) ? 'color:red' : '';
      dateRow.innerHTML += `<th style="${color}">${i}<br><span style="font-size:10px">${['日','一','二','三','四','五','六'][dayOfWeek]}</span></th>`;
    }

    try {
      const res = await api("get_roster_data", { year: y, month: m });
      if(!res.ok) return alert(res.message);

      isManager = res.isManager;
      if(isManager) document.getElementById("btnBatchApprove").classList.remove("hidden");

      const tbody = document.getElementById("rosterBody");
      tbody.innerHTML = "";

      res.employees.forEach(emp => {
        const tr = document.createElement("tr");
        let html = `<td class="col-emp">${emp.name}</td>`;
        for(let d=1; d<=daysInMonth; d++){
          const cellData = (res.roster[emp.id] && res.roster[emp.id][d]) ? res.roster[emp.id][d] : {};
          
          if(cellData.type === 'LEAVE') {
            html += `<td class="cell-leave">${cellData.value}</td>`;
          } else {
            const shift = cellData.value || 'OFF';
            const schId = cellData.scheduleId || '';
            const disabled = (cellData.status === 'APPROVED' && !isManager) ? 'disabled' : '';
            const bgClass = shift==='EARLY'?'cell-early':(shift==='LATE'?'cell-late':'cell-off');
            html += `
              <td class="${bgClass}">
                <select class="shift-select" ${disabled} 
                  onchange="updateShift('${emp.id}', '${emp.name}', ${d}, this.value, '${schId}')">
                  <option value="OFF" ${shift==='OFF'?'selected':''}>休</option>
                  <option value="EARLY" ${shift==='EARLY'?'selected':''}>早 10-18</option>
                  <option value="LATE" ${shift==='LATE'?'selected':''}>午 12-21</option>
                </select>
              </td>`;
          }
        }
        tr.innerHTML = html;
        tbody.appendChild(tr);
      });
    } catch(e){ alert("錯誤:"+e); }
  }

  async function updateShift(empId, empName, day, shift, oldId){
    const y = ySel.value;
    const m = mSel.value;
    const fullDate = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const action = oldId ? "update_schedule" : "add_schedule";
    if(!oldId && shift === 'OFF') return; 

    try {
      await api(action, { scheduleId: oldId, empId, empName, date: fullDate, shift });
    } catch(e) { alert("儲存失敗: " + e); loadRoster(); }
  }

  async function approveAll(){
    if(!confirm("確定核准本月所有排班？")) return;
    await api("approve_month_all", { year: ySel.value, month: mSel.value });
    alert("✅ 全月已核准");
    loadRoster();
  }

  loadRoster();
</script>
</body>
</html>
