<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é–€å¸‚æ’ç­ç®¡ç†</title>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f6f8; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    
    #calendar { max-width: 100%; margin: 0 auto; }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
    
    /* å½ˆçª—æ¨£å¼ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .modal h3 { margin-top: 0; }
    label { display: block; margin: 12px 0 6px; font-size: 14px; color: #666; }
    select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-save { background: #007aff; color: #fff; }
    .btn-del { background: #dc3545; color: #fff; display: none; }
    .btn-close { background: #eee; color: #333; }
  </style>
</head>
<body>

  <div class="container">
    <a href="manager.html" class="btn-back">â† å›ä¸»ç®¡é </a>
    <h2>ğŸ“… é–€å¸‚äººå“¡æ’ç­è¡¨</h2>
    <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
      <span style="color:#28a745">â— å·²å‡ºå¸­</span> &nbsp;
      <span style="color:#007aff">â— é å®šç­è¡¨</span> &nbsp;
      <span style="color:#dc3545">â— æ› è· (æœªæ‰“å¡)</span>
    </div>
    <div id='calendar'></div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ–°å¢æ’ç­</h3>
      <input type="hidden" id="selectedDate">
      
      <label>é¸æ“‡å“¡å·¥</label>
      <select id="empSelect">
        <option>è¼‰å…¥ä¸­...</option>
      </select>

      <label>ç­åˆ¥</label>
      <select id="shiftSelect">
        <option value="æ—©ç­">â˜€ï¸ æ—©ç­ (10:00-18:00)</option>
        <option value="æ™šç­">ğŸŒ™ æ™šç­ (14:00-22:00)</option>
        <option value="å…¨ç­">ğŸ”¥ å…¨ç­ (10:00-22:00)</option>
      </select>

      <div class="btn-group">
        <button class="btn-del" id="btnDelete" onclick="deleteEvent()">åˆªé™¤æ’ç­</button>
        <button class="btn-save" id="btnSave" onclick="saveEvent()">å„²å­˜</button>
        <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || window.GAS_ENDPOINT;
    const userId = localStorage.getItem("employeeId");
    let calendar;
    let employeeList = [];

    document.addEventListener('DOMContentLoaded', function() {
      if (!userId) { alert("è«‹å…ˆç™»å…¥"); location.href = "login.html"; return; }

      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-tw',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listWeek'
        },
        height: 'auto',
        events: fetchEvents, // è‡ªå‹•å»å¾Œç«¯æŠ“è³‡æ–™
        dateClick: function(info) {
          openModal(info.dateStr, null); // é»æ“Šç©ºç™½è™• -> æ–°å¢
        },
        eventClick: function(info) {
          // é»æ“Šå·²å­˜åœ¨çš„ç­è¡¨ -> åˆªé™¤æ¨¡å¼
          // è‹¥æ˜¯éå»çš„æ› è·ç´€éŒ„ï¼Œä¹Ÿå¯ä»¥åˆªé™¤(ä¿®æ­£)
          openModal(info.event.startStr, info.event);
        }
      });
      calendar.render();
    });

    // å¾ GAS æŠ“å–ç­è¡¨
    async function fetchEvents(info, successCallback, failureCallback) {
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ 
            action: "get_schedule", 
            userId: userId,
            start: info.startStr,
            end: info.endStr
          })
        });
        const json = await res.json();
        if (json.ok) {
          // æ›´æ–°å“¡å·¥é¸å–®
          employeeList = json.employees;
          updateEmpSelect();
          successCallback(json.events);
        } else {
          failureCallback(json.message);
        }
      } catch (e) { failureCallback(e); }
    }

    function updateEmpSelect() {
      const sel = document.getElementById("empSelect");
      sel.innerHTML = "";
      employeeList.forEach(emp => {
        const opt = document.createElement("option");
        opt.value = emp.id;
        opt.textContent = `${emp.name} (${emp.id})`;
        sel.appendChild(opt);
      });
    }

    // é–‹å•Ÿå½ˆçª—
    function openModal(dateStr, eventObj) {
      document.getElementById("eventModal").style.display = "flex";
      document.getElementById("selectedDate").value = dateStr;
      
      const title = document.getElementById("modalTitle");
      const btnDel = document.getElementById("btnDelete");
      const btnSave = document.getElementById("btnSave");
      const empSel = document.getElementById("empSelect");

      if (eventObj) {
        // ç·¨è¼¯æ¨¡å¼ (åˆªé™¤)
        title.textContent = `${dateStr} æ’ç­è©³æƒ…`;
        btnDel.style.display = "block";
        btnSave.style.display = "none";
        empSel.disabled = true; // ä¸èƒ½æ”¹äººï¼Œåªèƒ½åˆª
        // é é¸è©²å“¡å·¥
        empSel.value = eventObj.extendedProps.empId;
      } else {
        // æ–°å¢æ¨¡å¼
        title.textContent = `æ–°å¢æ’ç­ (${dateStr})`;
        btnDel.style.display = "none";
        btnSave.style.display = "block";
        empSel.disabled = false;
      }
    }

    function closeModal() {
      document.getElementById("eventModal").style.display = "none";
    }

    async function saveEvent() {
      const date = document.getElementById("selectedDate").value;
      const empId = document.getElementById("empSelect").value;
      const empName = document.getElementById("empSelect").options[document.getElementById("empSelect").selectedIndex].text.split(' (')[0];
      const shift = document.getElementById("shiftSelect").value;

      document.getElementById("btnSave").textContent = "è™•ç†ä¸­...";
      
      await callApi({
        action: "add_schedule",
        date: date, shift: shift, empId: empId, empName: empName, userId: userId
      });
      
      closeModal();
      calendar.refetchEvents(); // é‡æ–°æ•´ç†æ—¥æ›†
      document.getElementById("btnSave").textContent = "å„²å­˜";
    }

    async function deleteEvent() {
      const date = document.getElementById("selectedDate").value;
      const empId = document.getElementById("empSelect").value;

      if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ­¤æ’ç­å—ï¼Ÿ")) return;
      
      await callApi({
        action: "del_schedule",
        date: date, empId: empId, userId: userId
      });
      
      closeModal();
      calendar.refetchEvents();
    }

    async function callApi(payload) {
      try {
        await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify(payload)
        });
      } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    }
  </script>
</body>
</html>
