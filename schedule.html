<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>排班表</title>
  <style>
    body{font-family:-apple-system,sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;}
    .header{padding:10px;background:#f9f9f9;border-bottom:1px solid #ddd;display:flex;gap:10px;}
    .table-wrap{flex:1;overflow:auto;}
    table{border-collapse:collapse;min-width:100%;}
    th,td{border:1px solid #ddd;padding:0;text-align:center;min-width:40px;height:40px;font-size:12px;}
    thead th{position:sticky;top:0;background:#eee;z-index:2;}
    td:first-child{position:sticky;left:0;background:#fff;z-index:1;min-width:70px;font-weight:bold;}
    .sel{width:100%;height:100%;border:none;background:transparent;text-align-last:center;}
    .bg-early{background:#e3f2fd;color:#0d47a1;} /* 早班藍 */
    .bg-late{background:#fff3e0;color:#e65100;}  /* 午班橘 */
    .bg-off{background:#fafafa;color:#999;}
  </style>
</head>
<body>
<div class="header">
  <button onclick="location.href='app.html'">← 返回</button>
  <select id="y"></select><select id="m"></select>
  <button onclick="load()">刷新</button>
</div>
<div class="table-wrap">
  <table id="tbl">
    <thead><tr id="th"></tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>
<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  const now = new Date();
  const selY = document.getElementById("y");
  const selM = document.getElementById("m");
  
  for(let i=now.getFullYear()-1; i<=now.getFullYear()+1; i++) selY.add(new Option(i,i, i===now.getFullYear(), i===now.getFullYear()));
  for(let i=1; i<=12; i++) selM.add(new Option(i+"月",i, i===(now.getMonth()+1), i===(now.getMonth()+1)));

  function api(act, data={}) {
    return new Promise(r => {
      const cb = "c"+Date.now();
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...data,userId:uid}))}&callback=${cb}`;
      window[cb]=res=>{r(res);s.remove()};
      document.body.appendChild(s);
    });
  }

  async function load() {
    const y=selY.value, m=selM.value;
    const days = new Date(y,m,0).getDate();
    
    let h = "<th>員工</th>";
    for(let d=1; d<=days; d++) h+=`<th>${d}</th>`;
    document.getElementById("th").innerHTML = h;
    document.getElementById("tb").innerHTML = "<tr><td colspan='32'>載入中...</td></tr>";

    const res = await api("get_roster_data", {year:y, month:m});
    if(!res.ok) return alert("失敗");

    let b = "";
    res.employees.forEach(e => {
      b += `<tr><td>${e.name}</td>`;
      for(let d=1; d<=days; d++) {
        const cell = (res.roster[e.id] && res.roster[e.id][d]) ? res.roster[e.id][d] : {};
        const v = cell.value || 'OFF';
        const cls = (v==='EARLY')?'bg-early':(v==='LATE'?'bg-late':'bg-off');
        const txt = (v==='EARLY')?'早':(v==='LATE'?'午':'休');
        
        // 這裡僅顯示，若要編輯需判斷權限
        if(res.isManager) {
           b += `<td class="${cls}"><select class="sel" onchange="save('${e.id}','${e.name}',${d},this.value)">
             <option value="OFF" ${v==='OFF'?'selected':''}>休</option>
             <option value="EARLY" ${v==='EARLY'?'selected':''}>早</option>
             <option value="LATE" ${v==='LATE'?'selected':''}>午</option>
           </select></td>`;
        } else {
           b += `<td class="${cls}">${txt}</td>`;
        }
      }
      b += "</tr>";
    });
    document.getElementById("tb").innerHTML = b;
  }

  async function save(eid, ename, day, val) {
    const dStr = `${selY.value}-${String(selM.value).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    await api("update_schedule", {empId:eid, empName:ename, date:dStr, shift:val});
  }
  load();
</script>
</body>
</html>
