<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æˆ‘çš„æ­·å²ç´€éŒ„</title>

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      background:#f4f6f8;
      margin:0;
      padding:20px;
      color:#333;
    }

    .container{max-width:800px;margin:0 auto;}

    .btn-back{
      display:inline-block;
      padding:8px 16px;
      background:#333;
      color:#fff;
      text-decoration:none;
      border-radius:6px;
      margin-bottom:20px;
    }

    .card{
      background:#fff;
      border-radius:12px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      margin-bottom:20px;
    }

    .filter-box { display:flex; gap:10px; margin-bottom:15px; }

    select, button {
      padding:10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:16px;
    }

    button {
      background:#007aff;
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:bold;
    }

    .hist-item {
      border-bottom:1px solid #eee;
      padding:12px 0;
    }

    .hist-status {
      font-size:12px;
      padding:2px 6px;
      border-radius:4px;
      float:right;
      font-weight:bold;
    }

    .st-PENDING { background:#fff3e0; color:#ff9800; }
    .st-APPROVED { background:#e8f5e9; color:#28a745; }
    .st-REJECTED { background:#ffebee; color:#c62828; }

    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>

<body>

<div class="container">

  <!-- ä¿®æ­£å›é¦–é  -->
  <a href="./index.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>

  <div class="card">
    <h3 style="margin-top:0;">ğŸ“œ æ­·å²ç”³è«‹ç´€éŒ„æŸ¥è©¢</h3>

    <div class="filter-box">
      <select id="selYear"></select>
      <select id="selMonth"></select>
      <button onclick="loadData()">æŸ¥è©¢</button>
    </div>

    <div id="listArea">
      <div id="loading">è«‹é¸æ“‡å¹´ä»½èˆ‡æœˆä»½é€²è¡ŒæŸ¥è©¢</div>
    </div>
  </div>

</div>

<script src="./config.js"></script>

<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");

  if(!userId){
    alert("è«‹é‡æ–°ç™»å…¥");
    location.href="./index.html";
  }

  function initSelects() {
    const ySel = document.getElementById("selYear");
    const mSel = document.getElementById("selMonth");

    const now = new Date();
    const curY = now.getFullYear();
    const curM = now.getMonth() + 1;

    for(let y = curY - 1; y <= curY + 1; y++) {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y + "å¹´";
      if(y === curY) opt.selected = true;
      ySel.appendChild(opt);
    }

    for(let m = 1; m <= 12; m++) {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m + "æœˆ";
      if(m === curM) opt.selected = true;
      mSel.appendChild(opt);
    }

    loadData();
  }

  function api(act, data={}){
    return new Promise((resolve, reject)=>{
      const cb = "cb"+Date.now();

      const payload = JSON.stringify({
        ...data,
        userId
      });

      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;

      window[cb] = (res) => {
        resolve(res);
        document.body.removeChild(s);
      };

      s.onerror = () => reject("é€£ç·šå¤±æ•—");
      document.body.appendChild(s);
    });
  }

  async function loadData(){
    const y = document.getElementById("selYear").value;
    const m = document.getElementById("selMonth").value;
    const div = document.getElementById("listArea");

    div.innerHTML = '<div id="loading">è¼‰å…¥ä¸­...</div>';

    try {
      const res = await api("list_requests", { year: y, month: m });

      if (res.ok && res.list && res.list.length > 0) {

        div.innerHTML = "";

        res.list.forEach(r => {

          if (r.category === 'CLOCK') return;

          const stMap = { 'PENDING':'å¯©æ ¸ä¸­', 'APPROVED':'é€šé', 'REJECTED':'é§å›' };
          const catMap = { 'LEAVE':'è«‹å‡', 'OT':'åŠ ç­', 'OUTING':'å¤–å‡º', 'CORRECTION':'è£œå¡' };

          let title = catMap[r.category] || r.category;
          if (r.leaveType) title += ` (${r.leaveType})`;

          const timeStr =
            r.start.substring(5,16).replace('T',' ') +
            ' ~ ' +
            r.end.substring(5,16).replace('T',' ');

          div.innerHTML += `
            <div class="hist-item">
              <span class="hist-status st-${r.status}">${stMap[r.status]||r.status}</span>
              <div style="font-weight:bold; font-size:15px;">${title}</div>
              <div style="color:#666; margin-top:4px;">${timeStr}</div>
              <div style="color:#888; margin-top:4px;">äº‹ç”±: ${r.reason || 'ç„¡'}</div>
            </div>
          `;
        });

        if(div.innerHTML === "")
          div.innerHTML = "<div style='text-align:center;padding:20px;color:#999;'>è©²æœˆä»½ç„¡ç”³è«‹ç´€éŒ„</div>";

      } else {
        div.innerHTML = "<div style='text-align:center;padding:20px;color:#999;'>è©²æœˆä»½å°šç„¡ç´€éŒ„</div>";
      }

    } catch(e) {
      div.innerHTML = "è¼‰å…¥å¤±æ•—: " + e;
    }
  }

  initSelects();
</script>

</body>
</html>

