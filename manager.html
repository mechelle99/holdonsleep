<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ä¸»ç®¡å°ˆå€</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; --success: #10B981; --danger: #EF4444; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 100px 20px; color: var(--text); }
    
    h2 { margin: 0 0 20px 0; font-size: 22px; }
    h3 { margin: 30px 0 15px 0; font-size: 16px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }

    /* çµ±è¨ˆ Grid */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .stat-card { background: var(--card); padding: 16px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
    .stat-name { font-weight: 700; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #6B7280; margin-top: 4px; }
    .stat-val { font-weight: 700; color: var(--primary); }

    /* å¾…å¯©å¡ç‰‡ */
    .req-card { background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .req-info { display: flex; flex-direction: column; gap: 4px; max-width: 70%; }
    .req-title { font-weight: 700; font-size: 15px; display: flex; align-items: center; gap: 6px; }
    .req-tag { background: #EEF2FF; color: var(--primary); padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; white-space: nowrap; }
    .req-sub { font-size: 12px; color: #6B7280; }

    .actions { display: flex; gap: 8px; }
    .btn-act { width: 36px; height: 36px; border-radius: 50%; border: none; color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
    .btn-act:active { transform: scale(0.9); }
    .btn-ok { background: var(--success); }
    .btn-no { background: var(--danger); }

    .btn-approve-all { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; float: right; cursor: pointer; }

    /* åº•éƒ¨å°èˆª */
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å°ˆå€</h2>

  <h3>åœ˜éšŠä¼‘å‡æ¦‚æ³</h3>
  <div id="teamStats" class="stat-grid">è¼‰å…¥ä¸­...</div>

  <h3>
    å¾…å¯©æ ¸ç”³è«‹ 
    <button class="btn-approve-all" onclick="approveAll()">ä¸€éµå…¨å‡†</button>
  </h3>
  <div id="pendingList">è¼‰å…¥ä¸­...</div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span><span>ç”³è«‹</span></a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>ç´€éŒ„</span></a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span><span>æ’ç­</span></a>
    <a href="manager.html" class="nav-item active"><span class="nav-icon">ğŸ‘‘</span><span>ä¸»ç®¡</span></a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");

  function api(act, d={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function load() {
    // 1. è¼‰å…¥åœ˜éšŠé¤˜é¡
    const stats = await api("get_team_stats");
    const sDiv = document.getElementById("teamStats");
    
    if(stats.ok) {
        let h = "";
        stats.list.forEach(d => {
            // é˜²å‘†ï¼šå¦‚æœæ²’åå­—ï¼Œé¡¯ç¤º ID
            const name = (d.name && d.name !== 'undefined') ? d.name : d.id;
            h += `<div class="stat-card">
              <div class="stat-name">${name}</div>
              <div class="stat-row"><span>ç‰¹ä¼‘</span><span class="stat-val">${d.annual}</span></div>
              <div class="stat-row"><span>è£œä¼‘</span><span class="stat-val">${d.comp}</span></div>
            </div>`;
        });
        sDiv.innerHTML = h || "<div style='grid-column:1/-1;text-align:center;color:#999'>ç„¡å“¡å·¥è³‡æ–™</div>";
    } else {
        sDiv.innerHTML = "è®€å–å¤±æ•—";
    }

    // 2. è¼‰å…¥å¾…å¯©æ ¸åå–® (å«ä¸­æ–‡è½‰æ›)
    const pend = await api("get_pending");
    const pDiv = document.getElementById("pendingList");
    
    if(pend.ok && pend.list.length > 0) {
        let h = "";
        
        // å‡åˆ¥å°ç…§è¡¨
        const typeMap = {
            'annual': 'ç‰¹ä¼‘', 'sick': 'ç—…å‡', 'personal': 'äº‹å‡', 'comp': 'è£œä¼‘',
            'official': 'å…¬å‡', 'marriage': 'å©šå‡', 'bereavement': 'å–ªå‡',
            'menstrual': 'ç”Ÿç†å‡', 'maternity': 'ç”¢å‡', 'prenatal': 'ç”¢æª¢å‡',
            'paternity': 'é™ªç”¢å‡', 'miscarriage': 'æµç”¢å‡', 'injury': 'å…¬å‚·ç—…å‡',
            'family': 'å®¶åº­ç…§é¡§å‡', 'epidemic': 'é˜²ç–«ç…§é¡§å‡', 'birthday': 'ç”Ÿæ—¥å‡'
        };

        pend.list.forEach(r => {
            // è½‰æ›é¡åˆ¥èˆ‡å‡åˆ¥
            let displayType = typeMap[r.leaveType] || r.leaveType;
            if(r.category === 'CORRECTION') displayType = "è£œå¡";
            if(r.category === 'OT') displayType = "åŠ ç­";
            if(r.category === 'OUTING') displayType = "å¤–å‡º";

            // æ™‚é–“æ ¼å¼è™•ç†
            const dateStr = r.start.split('T')[0];
            const hoursInfo = (r.category !== 'CORRECTION' && r.hours > 0) ? ` â€¢ ${r.hours}å°æ™‚` : '';

            h += `<div class="req-card" id="c-${r.reqId}">
              <div class="req-info">
                <div class="req-title">${r.reqId} <span class="req-tag">${displayType}</span></div>
                <div class="req-sub">${dateStr} ${hoursInfo}</div>
                <div class="req-sub" style="color:#4B5563;">${r.reason || 'ç„¡äº‹ç”±'}</div>
              </div>
              <div class="actions">
                <button class="btn-act btn-ok" onclick="review('${r.reqId}','APPROVED')">âœ”</button>
                <button class="btn-act btn-no" onclick="review('${r.reqId}','REJECTED')">âœ–</button>
              </div>
            </div>`;
        });
        pDiv.innerHTML = h;
    } else {
        pDiv.innerHTML = "<div style='text-align:center;color:#999;padding:20px'>ç›®å‰ç„¡å¾…å¯©æ ¸é …ç›®</div>";
    }
  }

  async function review(rid, dec) {
      if(!confirm(dec==='APPROVED' ? "ç¢ºå®šæ ¸å‡†ï¼Ÿ" : "ç¢ºå®šé§å›ï¼Ÿ")) return;
      await api("review_request", {reqId:rid, decision:dec});
      // ç§»é™¤è©²å¡ç‰‡
      const card = document.getElementById(`c-${rid}`);
      if(card) card.remove();
      
      // å¦‚æœæ¸…ç©ºäº†ï¼Œé¡¯ç¤ºç„¡è³‡æ–™
      if(document.querySelectorAll('.req-card').length === 0) {
          document.getElementById("pendingList").innerHTML = "<div style='text-align:center;color:#999;padding:20px'>ç›®å‰ç„¡å¾…å¯©æ ¸é …ç›®</div>";
      }
  }

  async function approveAll() {
      if(!confirm("ç¢ºå®šå…¨éƒ¨æ ¸å‡†æœ¬æœˆç”³è«‹ï¼Ÿ")) return;
      const now = new Date();
      await api("approve_month_all", {year:now.getFullYear(), month:now.getMonth()+1});
      alert("æ‰¹æ¬¡å¯©æ ¸å®Œæˆ"); 
      location.reload();
  }

  load();
</script>
</body>
</html>
