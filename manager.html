<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸»ç®¡å¯©æ ¸å¾Œå°</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333;}
    .container{max-width:800px;margin:0 auto;}
    .btn-back{display:inline-block;padding:8px 16px;background:#333;color:#fff;text-decoration:none;border-radius:6px;margin-bottom:20px;}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:20px;}
    h3{margin-top:0;border-bottom:1px solid #eee;padding-bottom:10px;}
    
    .req-item{border-bottom:1px solid #eee;padding:12px 0;display:flex;justify-content:space-between;align-items:center;}
    .req-info{font-size:14px;}
    .req-actions button{margin-left:8px;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;}
    .btn-approve{background:#28a745;color:#fff;}
    .btn-reject{background:#dc3545;color:#fff;}
    
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee;}
    th{background:#fafafa;}
    
    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>
<body>

<div class="container">
  <a href="app.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>

  <div class="card">
    <h3>âš¡ å¾…å¯©æ ¸ç”³è«‹ (Pending)</h3>
    <div id="pendingList">
      <div id="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å“¡å·¥å‡å‹¤é¤˜é¡ç¸½è¦½</h3>
    <div style="overflow-x:auto;">
      <table id="statsTable">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>ç‰¹ä¼‘å‰©é¤˜</th>
            <th>è£œä¼‘å‰©é¤˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");

  if(!userId) location.href="index.html";

  function api(act, data={}){
    return new Promise((resolve, reject)=>{
      const cb = "cb"+Date.now();
      const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
      window[cb] = (res) => { resolve(res); document.body.removeChild(s); };
      s.onerror = () => reject("é€£ç·šå¤±æ•—");
      document.body.appendChild(s);
    });
  }

  async function loadData(){
    try {
      // 1. è¼‰å…¥å¾…å¯©æ ¸
      const pRes = await api("get_pending");
      const pDiv = document.getElementById("pendingList");
      pDiv.innerHTML = "";
      
      if(pRes.ok && pRes.list && pRes.list.length > 0) {
        pRes.list.forEach(r => {
          const div = document.createElement("div");
          div.className = "req-item";
          // è½‰æ›å‡åˆ¥é¡¯ç¤º
          const typeMap = {
            'LEAVE': 'è«‹å‡', 'OT': 'åŠ ç­', 'OUTING': 'å¤–å‡º',
            'annual':'ç‰¹ä¼‘', 'comp':'è£œä¼‘', 'sick':'ç—…å‡', 'personal':'äº‹å‡'
          };
          const cat = typeMap[r.category] || r.category;
          const type = typeMap[r.leaveType] || r.leaveType;
          
          div.innerHTML = `
            <div class="req-info">
              <strong>${r.empName}</strong> - ${cat} ${type ? '('+type+')' : ''}<br>
              <span style="color:#666;font-size:12px">
                ${r.start.substring(0,16).replace('T',' ')} ~ ${r.end.substring(0,16).replace('T',' ')}<br>
                æ™‚æ•¸: ${r.hours}h / äº‹ç”±: ${r.reason}
              </span>
            </div>
            <div class="req-actions">
              <button class="btn-approve" onclick="decide('${r.reqId}', 'APPROVED')">å‡†</button>
              <button class="btn-reject" onclick="decide('${r.reqId}', 'REJECTED')">é§</button>
            </div>
          `;
          pDiv.appendChild(div);
        });
      } else {
        pDiv.innerHTML = '<div style="padding:10px;color:#999">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸é …ç›®</div>';
      }

      // 2. è¼‰å…¥åœ˜éšŠå ±è¡¨
      const sRes = await api("get_team_stats");
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "";
      
      if(sRes.ok && sRes.list) {
        sRes.list.forEach(e => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.name} (${e.id})</td>
            <td>${e.annual.left} å¤©</td>
            <td>${e.comp.left} æ™‚</td>
          `;
          tbody.appendChild(tr);
        });
      }

    } catch(e) {
      alert("è¼‰å…¥å¤±æ•—: " + e);
    }
  }

  async function decide(reqId, decision) {
    if(!confirm(decision==='APPROVED'?"ç¢ºå®šæ ¸å‡†ï¼Ÿ":"ç¢ºå®šé§å›ï¼Ÿ")) return;
    const res = await api("review_request", { data: { reqId, decision } });
    alert(res.message);
    loadData(); // é‡æ–°è¼‰å…¥
  }

  loadData();
</script>
</body>
</html>
