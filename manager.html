<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸»ç®¡ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; color: #111; padding: 20px; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; }
    
    .section { background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; }
    h2 { margin-top: 0; font-size: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { color: #666; font-weight: 600; background: #fafafa; }
    
    .btn-action { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; margin-right: 5px; }
    .btn-approve { background: #d4edda; color: #155724; }
    .btn-reject { background: #f8d7da; color: #721c24; }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 8px; font-size: 14px; margin-bottom: 20px; }

    .tag { padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .tag-leave { background: #e3f2fd; color: #0d47a1; }
    .tag-ot { background: #fff3cd; color: #856404; }
    .tag-out { background: #d1e7dd; color: #0f5132; }

    .empty-msg { text-align: center; color: #999; padding: 20px; }
  </style>
</head>
<body>
  
  <div class="container">
    <a href="index.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>

    <div class="section">
      <h2>âš¡ï¸ å¾…å¯©æ ¸ç”³è«‹ (Pending)</h2>
      <div id="loading-pending">è¼‰å…¥ä¸­...</div>
      <table id="pendingTable" style="display:none;">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>é¡å‹</th>
            <th>å…§å®¹/æ™‚æ•¸</th>
            <th>äº‹ç”±</th>
            <th width="140">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody-pending"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>ğŸ“Š å“¡å·¥å‡å‹¤é¤˜é¡ç¸½è¦½</h2>
      <div id="loading-stats">è¼‰å…¥ä¸­...</div>
      <table id="statsTable" style="display:none;">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>ç‰¹ä¼‘å‰©é¤˜ (å¤©)</th>
            <th>è£œä¼‘å‰©é¤˜ (æ™‚)</th>
          </tr>
        </thead>
        <tbody id="tbody-stats"></tbody>
      </table>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || window.GAS_ENDPOINT;
    const userId = localStorage.getItem("employeeId");

    // åˆå§‹åŒ–ï¼šæª¢æŸ¥æ¬Šé™ä¸¦è¼‰å…¥è³‡æ–™
    async function init() {
      if (!userId) { alert("è«‹å…ˆç™»å…¥"); location.href = "login.html"; return; }
      
      loadPending();
      loadStats();
    }

    // 1. è¼‰å…¥å¾…å¯©æ ¸æ¸…å–®
    async function loadPending() {
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ action: "get_pending", userId })
        });
        const json = await res.json();
        document.getElementById("loading-pending").style.display = "none";
        
        if (json.ok) {
          renderPending(json.list);
        }
      } catch (e) { console.error(e); }
    }

    // 2. è¼‰å…¥å‡å‹¤çµ±è¨ˆ
    async function loadStats() {
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ action: "get_team_stats", userId })
        });
        const json = await res.json();
        document.getElementById("loading-stats").style.display = "none";

        if (json.ok) {
          renderStats(json.list);
        }
      } catch (e) { console.error(e); }
    }

    // æ¸²æŸ“å¾…å¯©æ ¸è¡¨æ ¼
    function renderPending(list) {
      const tbody = document.getElementById("tbody-pending");
      const table = document.getElementById("pendingTable");
      
      if (list.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' class='empty-msg'>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å–®æ“š ğŸ‰</td></tr>";
        table.style.display = "table";
        return;
      }

      let html = "";
      list.forEach(item => {
        let tagClass = "tag-leave";
        if(item.type === "åŠ ç­") tagClass = "tag-ot";
        if(item.type === "å¤–å‡º") tagClass = "tag-out";

        html += `
          <tr>
            <td>${item.empName}</td>
            <td><span class="tag ${tagClass}">${item.type}</span> <br><small>${item.detail}</small></td>
            <td>${item.hours} å°æ™‚<br><small style="color:#888">${item.date}</small></td>
            <td style="color:#555;font-size:13px;">${item.reason}</td>
            <td>
              <button class="btn-action btn-approve" onclick="review('${item.reqId}', 'APPROVED')">æ ¸å‡†</button>
              <button class="btn-action btn-reject" onclick="review('${item.reqId}', 'REJECTED')">é§å›</button>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
      table.style.display = "table";
    }

    // æ¸²æŸ“çµ±è¨ˆè¡¨æ ¼
    function renderStats(list) {
      const tbody = document.getElementById("tbody-stats");
      let html = "";
      list.forEach(item => {
        html += `
          <tr>
            <td><b>${item.name}</b> <span style="font-size:12px;color:#888">(${item.id})</span></td>
            <td style="color:${parseFloat(item.annual.left)<=0?'#c22':'#28a745'}">
              <b>${item.annual.left}</b> <small style="color:#999">/ ${item.annual.total}</small>
            </td>
            <td style="color:${parseFloat(item.comp.left)>0?'#28a745':'#111'}">
              <b>${item.comp.left}</b> <small style="color:#999">/ ç´¯ç© ${item.comp.total}</small>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
      document.getElementById("statsTable").style.display = "table";
    }

    // åŸ·è¡Œå¯©æ ¸å‹•ä½œ
    async function review(reqId, decision) {
      if(!confirm(`ç¢ºå®šè¦ ${decision === "APPROVED" ? "æ ¸å‡†" : "é§å›"} é€™å¼µå–®æ“šå—ï¼Ÿ`)) return;

      const btns = document.querySelectorAll("button");
      btns.forEach(b => b.disabled = true); // é˜²æ­¢é€£é»

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ action: "review_request", userId, data: { reqId, decision } })
        });
        const json = await res.json();
        alert(json.message);
        location.reload(); // é‡æ–°æ•´ç†é é¢æ›´æ–°æ¸…å–®
      } catch (e) {
        alert("é€£ç·šéŒ¯èª¤");
        btns.forEach(b => b.disabled = false);
      }
    }

    init();
  </script>
</body>
</html>
