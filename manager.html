<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸»ç®¡å¯©æ ¸å¾Œå°</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333;}
    .container{max-width:800px;margin:0 auto;}
    .btn-back{display:inline-block;padding:8px 16px;background:#333;color:#fff;text-decoration:none;border-radius:6px;margin-bottom:20px;}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:20px;}
    h3{margin-top:0;border-bottom:1px solid #eee;padding-bottom:10px;}
    
    .req-item{border-bottom:1px solid #eee;padding:12px 0;display:flex;justify-content:space-between;align-items:center;}
    .req-info{font-size:14px; line-height: 1.5;}
    .req-actions button{margin-left:8px;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;}
    .btn-approve{background:#28a745;color:#fff;}
    .btn-reject{background:#dc3545;color:#fff;}
    
    .tag { font-size:12px; padding:2px 6px; border-radius:4px; margin-left:5px; }
    .tag-blue { background:#e3f2fd; color:#007aff; }
    .tag-orange { background:#fff3e0; color:#ff9800; }

    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee;}
    th{background:#fafafa;}
    
    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>
<body>

<div class="container">
  <a href="app.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>

  <div class="card">
    <h3>âš¡ å¾…å¯©æ ¸ç”³è«‹ (Pending)</h3>
    <div id="pendingList">
      <div id="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å“¡å·¥å‡å‹¤é¤˜é¡ç¸½è¦½</h3>
    <div style="overflow-x:auto;">
      <table id="statsTable">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>ç‰¹ä¼‘å‰©é¤˜</th>
            <th>è£œä¼‘å‰©é¤˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");

  if(!userId) location.href="index.html";

  function api(act, data={}){
    return new Promise((resolve, reject)=>{
      const cb = "cb"+Date.now();
      const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
      window[cb] = (res) => { resolve(res); document.body.removeChild(s); };
      s.onerror = () => reject("é€£ç·šå¤±æ•—");
      document.body.appendChild(s);
    });
  }

  async function loadData(){
    try {
      const pRes = await api("get_pending");
      const pDiv = document.getElementById("pendingList");
      pDiv.innerHTML = "";
      
      if(pRes.ok && pRes.list && pRes.list.length > 0) {
        pRes.list.forEach(r => {
          const div = document.createElement("div");
          div.className = "req-item";
          
          // â˜… ä½¿ç”¨å¾Œç«¯å·²ä¿®å¾©çš„ CamelCase è®Šæ•¸
          const name = r.empName || r.empname || "æœªçŸ¥";
          const reqId = r.reqId || r.reqid;
          
          // å‡åˆ¥ä¸­æ–‡å°ç…§
          const typeMap = {
            'annual':'ç‰¹ä¼‘', 'comp':'è£œä¼‘', 'sick':'ç—…å‡', 'personal':'äº‹å‡',
            'menstrual':'ç”Ÿç†å‡', 'family':'å®¶åº­ç…§é¡§å‡', 'wedding':'å©šå‡',
            'funeral':'å–ªå‡', 'maternity':'ç”¢å‡', 'birthday':'ç”Ÿæ—¥å‡'
          };
          const typeStr = typeMap[r.leaveType || r.leavetype] || r.leaveType;
          const catStr = (r.category==='OT')?'åŠ ç­':(r.category==='OUTING'?'å¤–å‡º':'è«‹å‡');

          const start = r.start ? r.start.substring(0,16).replace('T',' ') : '';
          const end = r.end ? r.end.substring(0,16).replace('T',' ') : '';

          div.innerHTML = `
            <div class="req-info">
              <strong>${name}</strong> <span class="tag tag-blue">${catStr}</span> ${typeStr ? '<span class="tag tag-orange">'+typeStr+'</span>' : ''}<br>
              <span style="color:#666;font-size:12px">
                ${start} ~ ${end}<br>
                æ™‚æ•¸: ${r.hours}h / äº‹ç”±: ${r.reason || 'ç„¡'}
              </span>
            </div>
            <div class="req-actions">
              <button class="btn-approve" onclick="decide('${reqId}', 'APPROVED')">å‡†</button>
              <button class="btn-reject" onclick="decide('${reqId}', 'REJECTED')">é§</button>
            </div>
          `;
          pDiv.appendChild(div);
        });
      } else {
        pDiv.innerHTML = '<div style="padding:10px;color:#999">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸é …ç›®</div>';
      }

      const sRes = await api("get_team_stats");
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "";
      
      if(sRes.ok && sRes.list) {
        sRes.list.forEach(e => {
          const tr = document.createElement("tr");
          const ann = e.annual ? e.annual.left : 0;
          const comp = e.comp ? e.comp.left : 0;
          
          tr.innerHTML = `
            <td>${e.name} (${e.id})</td>
            <td>${ann} å¤©</td>
            <td>${comp} æ™‚</td>
          `;
          tbody.appendChild(tr);
        });
      }

    } catch(e) {
      alert("è¼‰å…¥å¤±æ•—: " + e);
    }
  }

  async function decide(reqId, decision) {
    if(!reqId || reqId === 'undefined') {
        alert("éŒ¯èª¤ï¼šç„¡æ³•å–å¾—ç”³è«‹å–®ç·¨è™Ÿ (reqId is undefined)");
        return;
    }
    if(!confirm(decision==='APPROVED'?"ç¢ºå®šæ ¸å‡†ï¼Ÿ":"ç¢ºå®šé§å›ï¼Ÿ")) return;
    const res = await api("review_request", { data: { reqId, decision } });
    alert(res.message);
    loadData();
  }

  loadData();
</script>
</body>
</html>
