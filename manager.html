<!DOCTYPE html>
<html>
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>主管</title>
<style>
  body{font-family:sans-serif;padding:16px;background:#f4f6f8;}
  .card{background:#fff;padding:16px;border-radius:12px;margin-bottom:10px;}
  .btn{padding:5px 10px;border:none;border-radius:4px;color:#fff;margin-left:5px;}
  .ok{background:#28a745} .no{background:#dc3545}
</style>
</head>
<body>
  <button onclick="location.href='app.html'" style="padding:10px;margin-bottom:10px;">回首頁</button>
  <div class="card">
    <h3>待審核</h3>
    <div id="list">載入中...</div>
  </div>
  <div class="card">
    <h3>員工餘額</h3>
    <div id="stats">...</div>
  </div>
  <script src="config.js"></script>
  <script>
    const uid=localStorage.getItem("employeeId");
    function api(a,d={}){
      return new Promise(r=>{
        const s=document.createElement("script");
        s.src=`${window.CONFIG.GAS_ENDPOINT}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d,userId:uid,webhookKey:window.CONFIG.WEBHOOK_KEY}))}&callback=cb${Date.now()}`;
        window[`cb${Date.now()}`]=(res)=>{r(res);s.remove()};
        document.body.appendChild(s);
      });
    }
    async function load(){
      const r = await api("get_pending");
      const d = document.getElementById("list");
      d.innerHTML = "";
      if(r.ok && r.list.length) {
        r.list.forEach(i => {
          d.innerHTML += `<div style="border-bottom:1px solid #eee;padding:10px;">
            <b>${i.empName}</b> ${i.category} (${i.leaveType||''})<br>
            <small>${i.start.substring(5,16)} ~ ${i.end.substring(5,16)}</small><br>
            <small>事由: ${i.reason||''}</small>
            <div style="margin-top:5px;text-align:right;">
              <button class="btn ok" onclick="rev('${i.reqId}','通過')">准</button>
              <button class="btn no" onclick="rev('${i.reqId}','駁回')">駁</button>
            </div>
          </div>`;
        });
      } else { d.innerHTML="無待審核"; }

      const s = await api("get_team_stats");
      if(s.ok) {
        let h = "<table width='100%'><tr><th>姓名</th><th>特休</th><th>補休</th></tr>";
        s.list.forEach(x=> h+=`<tr><td align='center'>${x.name}</td><td align='center'>${x.annual}</td><td align='center'>${x.comp}</td></tr>`);
        document.getElementById("stats").innerHTML = h+"</table>";
      }
    }
    async function rev(id,dec){ await api("review_request",{reqId:id,decision:dec}); load(); }
    load();
  </script>
</body>
</html>
