<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸»ç®¡ç®¡ç†</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f2f4f8; margin: 0; padding: 20px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    button { padding: 8px 16px; background: #111; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    h3 { color: #333; border-left: 5px solid #007aff; padding-left: 10px; margin-top: 30px; margin-bottom: 15px; }

    /* â˜… ä¿®å¾©é‡é»ï¼šåœ˜éšŠçµ±è¨ˆæ”¹ç”¨ Grid ç¶²æ ¼ï¼Œé¿å…è·‘ç‰ˆ */
    .stats-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
        gap: 15px; 
    }
    .stat-card { 
        background: white; 
        padding: 15px; 
        border-radius: 12px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        text-align: center; 
        border: 1px solid #eee;
    }
    .stat-name { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
    .stat-row { font-size: 13px; color: #666; display: flex; justify-content: space-between; margin-top: 5px; }
    .stat-val { font-weight: bold; color: #007aff; }

    /* å¾…å¯©æ ¸åˆ—è¡¨ */
    .req-card { 
        background: white; 
        padding: 15px; 
        border-radius: 12px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        margin-bottom: 10px;
    }
    .req-info div { margin-bottom: 4px; font-size: 14px; }
    .req-tag { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .req-actions { display: flex; gap: 8px; }
    .btn-ok { background: #34c759; padding: 6px 12px; font-size: 13px; }
    .btn-no { background: #ff3b30; padding: 6px 12px; font-size: 13px; }
  </style>
</head>
<body>

<div class="header">
  <h2>ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å°ˆå€</h2>
  <button onclick="location.href='app.html'">è¿”å›</button>
</div>

<h3>ğŸ“Š åœ˜éšŠé¤˜é¡</h3>
<div id="teamStats" class="stats-grid">è¼‰å…¥ä¸­...</div>

<h3>
  ğŸ“ å¾…å¯©æ ¸
  <button onclick="approveAll()" style="font-size:12px; background:#007aff; margin-left:10px;">ä¸€éµå…¨å‡†</button>
</h3>
<div id="pendingList">è¼‰å…¥ä¸­...</div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");

  function api(action, payload={}) {
    return new Promise(resolve => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${action}&payload=${encodeURIComponent(JSON.stringify({...payload, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { resolve(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function loadData() {
    // 1. åœ˜éšŠçµ±è¨ˆ (ä¿®å¾© undefined)
    const stats = await api("get_team_stats");
    const statsDiv = document.getElementById("teamStats");
    
    if(stats && stats.ok && stats.list) {
        let html = "";
        stats.list.forEach(d => {
            // â˜… å¼·åŠ›é˜²å‘†ï¼šå¦‚æœåå­—æ˜¯ undefinedï¼Œé¡¯ç¤º 'æœªçŸ¥' æˆ– ID
            const safeName = (d.name && d.name !== 'undefined') ? d.name : 'æœªçŸ¥å“¡å·¥';
            html += `
            <div class="stat-card">
              <div class="stat-name">${safeName}</div>
              <div class="stat-row"><span>ç‰¹ä¼‘</span> <span class="stat-val">${d.annual}</span></div>
              <div class="stat-row"><span>è£œä¼‘</span> <span class="stat-val">${d.comp}</span></div>
            </div>`;
        });
        statsDiv.innerHTML = html || "<div style='grid-column:1/-1;text-align:center'>ç„¡è³‡æ–™</div>";
    } else {
        statsDiv.innerHTML = "è®€å–å¤±æ•—";
    }

    // 2. å¾…å¯©æ ¸
    const pending = await api("get_pending");
    const listDiv = document.getElementById("pendingList");
    if(pending && pending.ok && pending.list) {
        let html = "";
        pending.list.forEach(r => {
            let label = r.leaveType;
            if(r.category === 'CORRECTION') label = "è£œå¡ (" + r.leaveType + ")";
            else if(r.category === 'OT') label = "åŠ ç­";
            
            html += `
            <div class="req-card" id="card-${r.reqId}">
              <div class="req-info">
                <div style="font-weight:bold">${r.reqId} <span class="req-tag">${label}</span></div>
                <div>${r.start.split('T')[0]} ${r.category!=='CORRECTION' ? '('+r.hours+'h)' : ''}</div>
                <div style="color:#666;font-size:12px">${r.reason||'ç„¡äº‹ç”±'}</div>
              </div>
              <div class="req-actions">
                <button class="btn-ok" onclick="review('${r.reqId}', 'APPROVED')">å‡†</button>
                <button class="btn-no" onclick="review('${r.reqId}', 'REJECTED')">é§</button>
              </div>
            </div>`;
        });
        listDiv.innerHTML = html || "<div style='text-align:center;padding:20px;color:#999'>ç›®å‰ç„¡å¾…å¯©æ ¸é …ç›®</div>";
    }
  }

  async function review(reqId, decision) {
      if(!confirm(decision==='APPROVED'?"ç¢ºå®šæ ¸å‡†ï¼Ÿ":"ç¢ºå®šé§å›ï¼Ÿ")) return;
      await api("review_request", { reqId, decision });
      // ç§»é™¤è©²å¡ç‰‡
      const card = document.getElementById(`card-${reqId}`);
      if(card) card.remove();
  }

  async function approveAll() {
      if(!confirm("ç¢ºå®šå…¨éƒ¨æ ¸å‡†æœ¬æœˆç”³è«‹ï¼Ÿ")) return;
      const now = new Date();
      await api("approve_month_all", { year: now.getFullYear(), month: now.getMonth()+1 });
      alert("è™•ç†å®Œæˆï¼Œè«‹é‡æ–°æ•´ç†");
      location.reload();
  }

  loadData();
</script>
</body>
</html>
