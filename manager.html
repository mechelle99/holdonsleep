<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸»ç®¡ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; color: #111; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; }
    .section { background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; }
    h2 { margin-top: 0; font-size: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { color: #666; font-weight: 600; background: #fafafa; }
    .btn-action { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; margin-right: 5px; }
    .btn-approve { background: #d4edda; color: #155724; }
    .btn-reject { background: #f8d7da; color: #721c24; }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 8px; font-size: 14px; margin-bottom: 20px; }
    .tag { padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .tag-leave { background: #e3f2fd; color: #0d47a1; }
    .tag-ot { background: #fff3cd; color: #856404; }
    .tag-out { background: #d1e7dd; color: #0f5132; }
    .empty-msg { text-align: center; color: #999; padding: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <a href="app.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>
    <a href="schedule.html" class="btn-back" style="background:#007aff; margin-left:10px;">ğŸ“… é€²å…¥æ’ç­è¡¨</a>

    <div class="section">
      <h2>âš¡ï¸ å¾…å¯©æ ¸ç”³è«‹ (Pending)</h2>
      <div id="loading-pending">è¼‰å…¥ä¸­...</div>
      <table id="pendingTable" style="display:none;">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>é¡å‹</th>
            <th>å…§å®¹/æ™‚æ•¸</th>
            <th>äº‹ç”±</th>
            <th width="140">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody-pending"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>ğŸ“Š å“¡å·¥å‡å‹¤é¤˜é¡ç¸½è¦½</h2>
      <div id="loading-stats">è¼‰å…¥ä¸­...</div>
      <table id="statsTable" style="display:none;">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>ç‰¹ä¼‘å‰©é¤˜ (å¤©)</th>
            <th>è£œä¼‘å‰©é¤˜ (æ™‚)</th>
          </tr>
        </thead>
        <tbody id="tbody-stats"></tbody>
      </table>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || window.GAS_ENDPOINT;
    const userId = localStorage.getItem("employeeId");
    const userName = localStorage.getItem("employeeName") || "";

    function jsonpCall(payload){
      return new Promise((resolve, reject)=>{
        if(!ENDPOINT) return reject(new Error("æœªè¨­å®š GAS"));
        const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
        window[cbName] = (resp)=>{ cleanup(); resolve(resp); };

        const qs = new URLSearchParams();
        qs.set("callback", cbName);
        qs.set("payload", JSON.stringify(payload));

        const script = document.createElement("script");
        script.src = ENDPOINT + "?" + qs.toString();
        script.onerror = ()=>{ cleanup(); reject(new Error("ç¶²è·¯é€£ç·šå¤±æ•—ï¼ˆJSONPï¼‰")); };
        document.body.appendChild(script);

        const timer = setTimeout(()=>{ cleanup(); reject(new Error("é€¾æ™‚ï¼ˆJSONPï¼‰")); }, 20000);
        function cleanup(){
          try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
          if(script && script.parentNode) script.parentNode.removeChild(script);
          clearTimeout(timer);
        }
      });
    }

    async function init() {
      if (!ENDPOINT) return alert("Config æœªè¨­å®š");
      if (!userId) { alert("è«‹å…ˆç™»å…¥"); location.href = "login.html"; return; }

      // å¾Œç«¯æœƒæª¢æŸ¥ä½ æ˜¯ä¸æ˜¯ä¸»ç®¡ï¼Œä¸æ˜¯å°±æœƒå›éŒ¯èª¤
      loadPending();
      loadStats();
    }

    async function loadPending() {
      try {
        const json = await jsonpCall({ action: "get_pending", userId, displayName: userName });
        document.getElementById("loading-pending").style.display = "none";
        if (json.ok) renderPending(json.list || []);
        else document.getElementById("loading-pending").innerHTML = `<span style="color:red">âŒ ${json.message}</span>`;
      } catch (e) {
        document.getElementById("loading-pending").innerHTML = `<span style="color:red">âŒ ${e.message}</span>`;
      }
    }

    async function loadStats() {
      try {
        const json = await jsonpCall({ action: "get_team_stats", userId, displayName: userName });
        document.getElementById("loading-stats").style.display = "none";
        if (json.ok) renderStats(json.list || []);
        else document.getElementById("loading-stats").innerHTML = `<span style="color:red">âŒ ${json.message}</span>`;
      } catch (e) {
        document.getElementById("loading-stats").innerHTML = `<span style="color:red">âŒ ${e.message}</span>`;
      }
    }

    function renderPending(list) {
      const tbody = document.getElementById("tbody-pending");
      const table = document.getElementById("pendingTable");

      if (list.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' class='empty-msg'>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å–®æ“š ğŸ‰</td></tr>";
        table.style.display = "table";
        return;
      }

      let html = "";
      list.forEach(item => {
        let tagClass = "tag-leave";
        if (item.type === "åŠ ç­") tagClass = "tag-ot";
        if (item.type === "å¤–å‡º") tagClass = "tag-out";

        html += `
          <tr>
            <td>${item.empName}</td>
            <td><span class="tag ${tagClass}">${item.type}</span> <br><small>${item.detail}</small></td>
            <td>${item.hours} å°æ™‚<br><small style="color:#888">${item.date}</small></td>
            <td style="color:#555;font-size:13px;">${item.reason}</td>
            <td>
              <button class="btn-action btn-approve" onclick="review('${item.reqId}', 'APPROVED')">æ ¸å‡†</button>
              <button class="btn-action btn-reject" onclick="review('${item.reqId}', 'REJECTED')">é§å›</button>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
      table.style.display = "table";
    }

    function renderStats(list) {
      const tbody = document.getElementById("tbody-stats");
      let html = "";
      list.forEach(item => {
        html += `
          <tr>
            <td><b>${item.name}</b> <span style="font-size:12px;color:#888">(${item.id})</span></td>
            <td style="color:${parseFloat(item.annual.left)<=0?'#c22':'#28a745'}">
              <b>${item.annual.left}</b> <small style="color:#999">/ ${item.annual.total}</small>
            </td>
            <td style="color:${parseFloat(item.comp.left)>0?'#28a745':'#111'}">
              <b>${item.comp.left}</b> <small style="color:#999">/ ç´¯ç© ${item.comp.total}</small>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
      document.getElementById("statsTable").style.display = "table";
    }

    async function review(reqId, decision) {
      if(!confirm(`ç¢ºå®šè¦ ${decision === "APPROVED" ? "æ ¸å‡†" : "é§å›"} é€™å¼µå–®æ“šå—ï¼Ÿ`)) return;
      const btns = document.querySelectorAll("button");
      btns.forEach(b => b.disabled = true);

      try{
        const json = await jsonpCall({ action: "review_request", userId, displayName:userName, data:{ reqId, decision } });
        alert(json.message || "å®Œæˆ");
        location.reload();
      }catch(e){
        alert("âŒ " + e.message);
        btns.forEach(b => b.disabled = false);
      }
    }

    init();
  </script>
</body>
</html>
