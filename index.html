<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HOLDON 出勤系統 - 登入</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;padding:24px;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .card{width:100%;max-width:360px;background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    input{width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px;}
    button{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:10px;font-size:16px;}
    .link{text-align:center;margin-top:16px;font-size:13px}
    .link a{color:#666;text-decoration:none;border-bottom:1px dotted #999}
    .hidden{display:none}
    #loading{color:#007aff;font-size:13px;text-align:center;margin-top:10px;display:none;}
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h2 style="margin-top:0;text-align:center;">HOLDON 登入</h2>
    <input id="empId" placeholder="員工編號 (例如 M001)" />
    <input id="pass" type="password" placeholder="密碼" />
    <button onclick="login()">登入</button>
    <div id="loading">系統連線中...</div>
    
    <div class="link">
      <a href="javascript:showForgot()">忘記密碼？</a>
    </div>
  </div>

  <div class="card hidden" id="forgotCard">
    <h2 style="margin-top:0">重設密碼</h2>
    <p style="font-size:13px;color:#666">請輸入員工編號，我們將寄送驗證碼到您的 Email。</p>
    <input id="f_empId" placeholder="員工編號" />
    <button onclick="sendForgot()">寄送驗證碼</button>
    <div class="link"><a href="javascript:showLogin()">回登入</a></div>
  </div>

  <div class="card hidden" id="resetCard">
    <h2 style="margin-top:0">設定新密碼</h2>
    <input id="r_token" placeholder="驗證碼" />
    <input id="r_p1" type="password" placeholder="新密碼" />
    <button onclick="doReset()">確認重設</button>
    <div class="link"><a href="javascript:showLogin()">取消</a></div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    
    function showLogin(){ 
        document.getElementById("loginCard").style.display="block";
        document.getElementById("forgotCard").style.display="none";
        document.getElementById("resetCard").style.display="none";
    }
    function showForgot(){
        document.getElementById("loginCard").style.display="none";
        document.getElementById("forgotCard").style.display="block";
    }
    function showReset(){
        document.getElementById("forgotCard").style.display="none";
        document.getElementById("resetCard").style.display="block";
    }

    function jsonpCall(action, data){
      // ★★★ 修正：延長超時時間到 30 秒，避免冷啟動報錯 ★★★
      const timeoutMs = 30000; 
      
      return new Promise((resolve, reject)=>{
        const cbName = "cb" + Date.now();
        const script = document.createElement("script");
        const payload = JSON.stringify({ ...data, webhookKey: window.CONFIG?.WEBHOOK_KEY });
        const url = `${ENDPOINT}?action=${action}&payload=${encodeURIComponent(payload)}&callback=${cbName}`;
        
        let isSettled = false;

        // 設定超時
        const timer = setTimeout(() => {
            if(!isSettled) {
                isSettled = true;
                reject("連線逾時 (請檢查網路或稍後再試)");
                // 嘗試清理
                try { delete window[cbName]; document.body.removeChild(script); } catch(e){}
            }
        }, timeoutMs);

        window[cbName] = (res) => {
           if(isSettled) return; // 如果已經 timeout 就忽略成功的回調
           isSettled = true;
           clearTimeout(timer);
           resolve(res);
           delete window[cbName];
           script.remove();
        };
        
        script.onerror = () => {
           if(isSettled) return;
           isSettled = true;
           clearTimeout(timer);
           reject("網路錯誤 (Script Error)");
        };
        
        script.src = url;
        document.body.appendChild(script);
      });
    }

    async function login(){
       const empId = document.getElementById("empId").value.trim();
       const pass = document.getElementById("pass").value.trim();
       if(!empId || !pass) return alert("請輸入帳號密碼");

       document.getElementById("loading").style.display = "block";

       try {
         const res = await jsonpCall("login", { empId, pass });
         document.getElementById("loading").style.display = "none";
         
         if(res.ok){
             localStorage.setItem("employeeId", res.empId);
             localStorage.setItem("employeeName", res.name);
             localStorage.setItem("isManager", res.isManager ? "Y":"N");
             localStorage.setItem("canSchedule", res.canSchedule ? "Y":"N");
             
             // ★★★ 修正：強制跳轉到 app.html ★★★
             location.href = "app.html";
         } else {
             alert(res.message);
         }
       } catch(e){ 
           document.getElementById("loading").style.display = "none";
           alert("登入失敗：" + e); 
       }
    }

    async function sendForgot(){
        const empId = document.getElementById("f_empId").value;
        if(!empId) return alert("請輸入編號");
        try {
            const res = await jsonpCall("forgot_password", { empId });
            if(res.ok) { alert(res.message); showReset(); } else { alert(res.message); }
        } catch(e) { alert(e); }
    }

    async function doReset(){
        const empId = document.getElementById("f_empId").value;
        const token = document.getElementById("r_token").value;
        const newPass = document.getElementById("r_p1").value;
        if(!token || !newPass) return alert("請填寫完整");
        
        try {
            const res = await jsonpCall("reset_password", { empId, token, newPass });
            if(res.ok){ alert("修改成功，請登入"); showLogin(); } else { alert(res.message); }
        } catch(e) { alert(e); }
    }
  </script>
</body>
</html>
