<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>HOLDON æ‰“å¡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 14px; }
    button { margin: 6px 6px 0 0; padding: 10px 12px; }
    #debug { margin-top: 12px; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; font-size: 12px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤æ‰“å¡</h2>

  <p id="user">è¼‰å…¥ä¸­...</p>
  <p id="status" class="muted"></p>

  <button id="btnIn"  disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
  <button id="btnOut" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
  <button id="btnOT"  disabled>ğŸ•’ åŠ ç­æ‰“å¡</button>

  <div id="debug">debug: (waiting)</div>

<script>
  // â‘   LIFF ID
  const LIFF_ID = "2009036245-XmZMSuuS";

  // â‘¡ GAS Web App /exec
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

  let userId = "";
  let displayName = "";
  let ready = false;

  const $ = (id) => document.getElementById(id);

  function log(msg){
    $("debug").innerText = ($("debug").innerText || "") + "\n" + msg;
  }
  function setStatus(msg){ $("status").innerText = msg; }
  function setButtonsEnabled(on){
    $("btnIn").disabled  = !on;
    $("btnOut").disabled = !on;
    $("btnOT").disabled  = !on;
  }

  async function init(){
    try{
      setButtonsEnabled(false);
      $("debug").innerText = "debug: start";
      setStatus("åˆå§‹åŒ–ä¸­...");

      log("has liff=" + (typeof liff));
      log("origin=" + location.origin);

      log("liff.init start");
      await liff.init({ liffId: LIFF_ID });
      log("liff.init ok");

      log("isLoggedIn=" + liff.isLoggedIn());
      if(!liff.isLoggedIn()){
        log("calling liff.login()");
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      userId = profile.userId || "";
      displayName = profile.displayName || "";

      $("user").innerText = "ä½ å¥½ï¼Œ" + displayName;

      // ç¶å®šæŒ‰éˆ•
      $("btnIn").onclick  = () => sendLog("ä¸Šç­");
      $("btnOut").onclick = () => sendLog("ä¸‹ç­");
      $("btnOT").onclick  = () => sendLog("åŠ ç­");

      ready = true;
      setButtonsEnabled(true);
      setStatus("å¯ä»¥æ‰“å¡äº† âœ…");
      log("ready=true");
    }catch(e){
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼š" + (e.message || e));
      log("ERROR: " + (e.stack || e.message || e));
    }
  }

  async function sendLog(type){
    if(!ready){
      setStatus("é‚„åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨ç­‰");
      return;
    }

    setButtonsEnabled(false);
    setStatus("å¯«å…¥ä¸­...");
    log("sendLog type=" + type);

    try{
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type, userId, displayName })
      });

      log("http status=" + res.status);

      const text = await res.text();
      log("raw=" + text.slice(0, 200));

      let data;
      try { data = JSON.parse(text); } catch(e) { throw new Error("not JSON response"); }

      if(!data.ok) throw new Error((data.message || "unknown") + (data.stack ? (" | " + data.stack) : ""));
      setStatus(data.message || "å¯«å…¥æˆåŠŸ âœ…");
      setButtonsEnabled(true);
    }catch(err){
      setStatus("å¯«å…¥å¤±æ•—ï¼š" + (err.message || err));
      setButtonsEnabled(true);
      log("failure: " + (err.message || err));
    }
  }

  init();
</script>
</body>
</html>
