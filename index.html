<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>HOLDON æ‰“å¡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    button { margin: 6px 6px 0 0; padding: 10px 12px; }
    #debug { margin-top: 12px; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤æ‰“å¡</h2>
  <p id="user">è¼‰å…¥ä¸­...</p>
  <p id="status"></p>

  <button id="btnIn"  disabled onclick="sendLog('ä¸Šç­')">ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
  <button id="btnOut" disabled onclick="sendLog('ä¸‹ç­')">ğŸ”´ ä¸‹ç­æ‰“å¡</button>
  <button id="btnOT"  disabled onclick="sendLog('åŠ ç­')">ğŸ•’ åŠ ç­æ‰“å¡</button>

  <div id="debug">debug: (waiting)</div>

  <script>
    // âœ… ç”¨ä½ å¾Œå°é¡¯ç¤ºçš„é‚£ä¸²
    const LIFF_ID = "2009036245-XmZMSuuS";

    // âœ… ç­‰ä¸‹ä½ æœƒæŠŠ GAS /exec API è²¼åˆ°é€™è£¡
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

    const $ = (id) => document.getElementById(id);
    function log(msg){ $("debug").innerText += "\n" + msg; }
    function setStatus(msg){ $("status").innerText = msg; }
    function setButtons(on){
      $("btnIn").disabled = !on;
      $("btnOut").disabled = !on;
      $("btnOT").disabled = !on;
    }

    let userId = "";
    let displayName = "";
    let ready = false;

    async function init(){
      $("debug").innerText = "debug: start";
      log("url=" + location.href);
      log("has liff=" + (typeof liff));
      setButtons(false);
      setStatus("åˆå§‹åŒ–ä¸­...");

      try{
        log("liff.init start");
        await liff.init({ liffId: LIFF_ID });
        log("liff.init ok");

        if(!liff.isLoggedIn()){
          log("not logged in -> login()");
          liff.login();
          return;
        }

        const p = await liff.getProfile();
        userId = p.userId || "";
        displayName = p.displayName || "";

        $("user").innerText = "ä½ å¥½ï¼Œ" + displayName;
        ready = true;
        setButtons(true);
        setStatus("å¯ä»¥æ‰“å¡äº† âœ…");
      }catch(e){
        log("ERROR: " + (e.message || e));
        setStatus("åˆå§‹åŒ–å¤±æ•—ï¼š" + (e.message || e));
      }
    }

    async function sendLog(type){
      if(!ready){
        setStatus("é‚„åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨ç­‰");
        return;
      }
      setButtons(false);
      setStatus("å¯«å…¥ä¸­...");

      try{
        const res = await fetch(GAS_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, userId, displayName })
        });
        const data = await res.json();
        if(!data.ok) throw new Error(data.message || "unknown error");

        setStatus(data.message);
        setButtons(true);
        log("success: " + JSON.stringify(data));
      }catch(err){
        setStatus("å¯«å…¥å¤±æ•—ï¼š" + (err.message || err));
        setButtons(true);
        log("failure: " + (err.message || err));
      }
    }

    init();
  </script>
</body>
</html>
