<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:16px;color:#111;}
    h2{margin:0 0 8px;}
    .muted{color:#666;font-size:12px;margin:6px 0 14px;}
    .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap;}
    .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer;font-size:13px;}
    .tab.active{border-color:#111;}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.05);}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{padding:10px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer;}
    .btn.primary{border-color:#111;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    label{font-size:12px;color:#444;display:block;margin:10px 0 4px;}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;}
    textarea{min-height:70px;resize:vertical;}
    .status{font-size:13px;margin-top:10px;white-space:pre-wrap;}
    .ok{color:#0a7a2f;}
    .err{color:#b00020;}
    .hidden{display:none;}
    .item{border-top:1px solid #eee;padding-top:10px;margin-top:10px;}
    .pill{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid #ddd;border-radius:999px;color:#444;margin-left:6px;}
    .hint{font-size:12px;color:#666;margin-top:6px;white-space:pre-wrap;}
    pre{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word;}
    hr{border:none;border-top:1px solid #eee;margin:14px 0;}
    small{color:#666}
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤ç³»çµ±</h2>
  <div class="muted">ä¸Š/ä¸‹ç­ç«‹å³ç”Ÿæ•ˆï¼›æ‰“å¡éœ€åœ¨å…¬å¸ 100 å…¬å°ºå…§ï¼›åŠ ç­èˆ‡è«‹å‡éœ€ä¸»ç®¡æ ¸å‡†ã€‚</div>

  <div class="card">
    <div id="user">è¼‰å…¥ä¸­...</div>
    <div id="gpsHint" class="hint">å®šä½ï¼šæœªå–å¾—</div>
    <div id="status" class="status muted"></div>
    <pre id="errbox" class="hidden"></pre>

    <div class="row" style="margin-top:10px;">
      <button id="btnIn"  class="btn primary" disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
      <button id="btnOut" class="btn primary" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
      <button id="btnGPS" class="btn">ğŸ“ é‡æ–°å®šä½</button>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabApply">ç”³è«‹</button>
      <button class="tab" id="tabMine">æˆ‘çš„ç”³è«‹</button>
      <button class="tab hidden" id="tabMgr">ä¸»ç®¡æ ¸å‡†</button>
    </div>
  </div>

  <div id="panelApply" class="card">
    <h3 style="margin:0 0 8px;">ğŸ•’ åŠ ç­ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>åŠ ç­æ—¥æœŸ</label><input id="otDate" type="date"/>
    <div class="row">
      <div style="flex:1;min-width:140px;">
        <label>é–‹å§‹æ™‚é–“</label><input id="otStart" type="time"/>
      </div>
      <div style="flex:1;min-width:140px;">
        <label>çµæŸæ™‚é–“</label><input id="otEnd" type="time"/>
      </div>
    </div>
    <label>åŠ ç­æ™‚æ•¸ï¼ˆå°æ™‚ï¼Œè‡ªå‹•è¨ˆç®—ï¼‰</label>
    <input id="otHours" type="number" min="0.5" step="0.5" placeholder="æœƒè‡ªå‹•è¨ˆç®—" readonly />

    <label>åŸå› èªªæ˜</label><textarea id="otReason" placeholder="ç°¡è¿°åŠ ç­åŸå› "></textarea>

    <label>é™„ä»¶é€£çµï¼ˆå¯é¸ï¼Œå…ˆä¸Šå‚³åˆ° Drive å¾Œè²¼é€£çµï¼‰</label>
    <input id="otAttachLink" type="url" placeholder="https://drive.google.com/..." />
    <div class="row" style="margin-top:8px;">
      <button id="btnOpenDrive" class="btn" type="button">ğŸ“‚ é–‹å•Ÿé™„ä»¶è³‡æ–™å¤¾</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnOTApply" class="btn" disabled>é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <hr/>

    <h3 style="margin:0 0 8px;">ğŸ“ è«‹å‡ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>å‡åˆ¥</label>
    <select id="leaveType">
      <option value="äº‹å‡">äº‹å‡</option>
      <option value="ç—…å‡">ç—…å‡</option>
      <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
      <option value="ç”Ÿæ—¥å‡">ç”Ÿæ—¥å‡</option>
    </select>

    <label>è«‹å‡æ—¥æœŸ</label><input id="leaveDate" type="date"/>
    <div class="row">
      <div style="flex:1;min-width:140px;">
        <label>é–‹å§‹æ™‚é–“</label><input id="leaveStart" type="time"/>
      </div>
      <div style="flex:1;min-width:140px;">
        <label>çµæŸæ™‚é–“</label><input id="leaveEnd" type="time"/>
      </div>
    </div>

    <label>è«‹å‡æ™‚æ•¸ï¼ˆå°æ™‚ï¼Œè‡ªå‹•è¨ˆç®—ï¼‰</label>
    <input id="leaveHours" type="number" min="0.5" step="0.5" placeholder="æœƒè‡ªå‹•è¨ˆç®—" readonly />

    <label>åŸå› èªªæ˜</label><textarea id="leaveReason" placeholder="ç°¡è¿°è«‹å‡åŸå› "></textarea>

    <label>çœ‹ç—…è­‰æ˜/é™„ä»¶é€£çµï¼ˆç—…å‡å»ºè­°ï¼›æ²’é™„ä¹Ÿå¯ï¼‰</label>
    <input id="leaveAttachLink" type="url" placeholder="https://drive.google.com/..." />

    <div class="row" style="margin-top:10px;">
      <button id="btnLeaveApply" class="btn" disabled>é€å‡ºè«‹å‡ç”³è«‹</button>
    </div>

    <div class="hint"><small>âš ï¸ GitHub + JSONP æ¶æ§‹ç„¡æ³•ç©©å®šç›´æ¥ä¸Šå‚³æª”æ¡ˆï¼Œé™„ä»¶è«‹è²¼ Drive é€£çµã€‚</small></div>
  </div>

  <div id="panelMine" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“„ æˆ‘çš„ç”³è«‹</h3>
    <div class="row">
      <button class="btn" id="btnReloadMine">é‡æ–°æ•´ç†</button>
    </div>
    <div id="mineList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

  <div id="panelMgr" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“¥ å¾…æ ¸å‡†æ¸…å–®</h3>
    <div class="row">
      <button class="btn" id="btnReloadPending">é‡æ–°æ•´ç†</button>
    </div>
    <div id="pendingList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

<script>
/* ================== è¨­å®š ================== */
const LIFF_ID = "2009036245-XmZMSuuS";

// âœ… é€™è£¡ä¸€å®šè¦æ›æˆä½  GAS éƒ¨ç½²çš„ /exec
const GAS_URL = "https://script.google.com/macros/s/AKfycbwPDqm4YawpB5vgOOG9qqPA51-u_vCb-bbfr-91k6EtjkN6ZDrjTlK9-xBpwxtmuVAQkA/exec";

// âœ… å…¬å¸åº§æ¨™ï¼šä½ æˆªåœ–å…©é»ï¼ˆå·²è½‰åé€²ä½ï¼‰
const ALLOW_DISTANCE = 100;
const COMPANY_POINTS = [
  { name:"å…¬å¸é»A", lat:25.0175556, lng:121.5302500 },
  { name:"å…¬å¸é»B", lat:25.0255556, lng:121.5235556 },
];

// âœ… ä½ æŒ‡å®šçš„é™„ä»¶è³‡æ–™å¤¾
const DRIVE_FOLDER_URL = "https://drive.google.com/drive/u/0/folders/1Ys3V05qm7RDYGnVSFWjjzL3Pl1xiBM5w";

/* ================== ç‹€æ…‹ ================== */
let userId="", displayName="", ready=false, isManager=false;
let lastGPS=null;

const $ = id => document.getElementById(id);

function setStatus(msg,type="muted"){
  $("status").className="status "+(type==="ok"?"ok":type==="err"?"err":"muted");
  $("status").innerText=msg||"";
}
function showErr(e, title="Error"){
  const box = $("errbox");
  box.classList.remove("hidden");
  box.textContent = `${title}\n\n${e?.stack || e?.message || String(e)}`;
}
window.addEventListener("error", (ev)=>{ setStatus("ç¨‹å¼éŒ¯èª¤ï¼ˆè«‹çœ‹ä¸‹æ–¹éŒ¯èª¤ï¼‰","err"); showErr(ev.error || ev.message, "window.onerror"); });
window.addEventListener("unhandledrejection",(ev)=>{ setStatus("ç¨‹å¼éŒ¯èª¤ï¼ˆè«‹çœ‹ä¸‹æ–¹éŒ¯èª¤ï¼‰","err"); showErr(ev.reason, "unhandledrejection"); });

function escapeHtml_(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function traceId_(){ return "liff-"+Date.now()+"-"+Math.random().toString(16).slice(2); }

/* ================== è·é›¢è¨ˆç®— ================== */
function calcDistance(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function minDistanceToCompany(lat,lng){
  let best = { distance: Infinity, name:"" };
  for(const p of COMPANY_POINTS){
    const d = calcDistance(lat,lng,p.lat,p.lng);
    if(d < best.distance) best = { distance:d, name:p.name };
  }
  return best;
}

/* ================== JSONPï¼ˆä¿®æ­£ç‰ˆï¼‰================== */
function jsonp_(paramsObj){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    paramsObj.callback = cb;

    const url = GAS_URL + "?" + new URLSearchParams(paramsObj).toString();
    const script = document.createElement("script");

    window[cb] = (data)=>{
      try{ resolve(data); }
      finally{
        try{ delete window[cb]; }catch(_){}
        script.remove();
      }
    };

    script.src = url;
    script.onerror = ()=>{
      try{ delete window[cb]; }catch(_){}
      script.remove();
      reject(new Error("jsonp_failed"));
    };

    document.body.appendChild(script);

    setTimeout(()=>{
      if(window[cb]){
        try{ delete window[cb]; }catch(_){}
        script.remove();
        reject(new Error("jsonp_timeout"));
      }
    }, 12000);
  });
}

async function jsonpWrite_(paramsObj, okMsg){
  try{
    setStatus("é€å‡ºä¸­...");
    const data = await jsonp_(paramsObj);
    if(data?.ok){
      setStatus(okMsg,"ok");
      return data;
    }
    setStatus(data?.message || "é€å‡ºå¤±æ•—","err");
    return null;
  }catch(e){
    console.error(e);
    setStatus("é€å‡ºå¤±æ•—ï¼ˆé€£ç·š/é€¾æ™‚ï¼‰","err");
    showErr(e, "JSONP failed");
    return null;
  }
}

/* ================== GPSï¼ˆä¸å¡ä½ç‰ˆï¼‰================== */
async function getGPS_(){
  $("gpsHint").innerText = "å®šä½ï¼šå–å¾—ä¸­â€¦";
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation){
      $("gpsHint").innerText = "å®šä½ï¼šæ­¤è£ç½®ä¸æ”¯æ´å®šä½";
      return reject(new Error("æ­¤è£ç½®ä¸æ”¯æ´å®šä½"));
    }

    navigator.geolocation.getCurrentPosition(
      pos=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const best = minDistanceToCompany(lat,lng);
        const d = best.distance;

        lastGPS = { lat, lng, distance:d, companyName:best.name };
        $("gpsHint").innerText = `å®šä½ï¼šè·é›¢ ${best.name} ${Math.round(d)} å…¬å°ºï¼ˆå…è¨± â‰¤ ${ALLOW_DISTANCE}mï¼‰`;

        if(d > ALLOW_DISTANCE){
          return reject(new Error(`ä¸åœ¨æ‰“å¡ç¯„åœå…§ï¼ˆ${Math.round(d)}mï¼‰`));
        }
        resolve(lastGPS);
      },
      err=>{
        const msg = (err && err.code === 1)
          ? "GPS æ¬Šé™è¢«æ‹’çµ•ï¼ˆè«‹åœ¨ LINE/æ‰‹æ©Ÿè¨­å®šå…è¨±å®šä½ï¼‰"
          : "GPS å–å¾—å¤±æ•—ï¼ˆè«‹é–‹å•Ÿå®šä½/åˆ°æˆ¶å¤–é‡è©¦ï¼‰";
        $("gpsHint").innerText = "å®šä½ï¼š" + msg;
        reject(new Error(msg));
      },
      { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
    );
  });
}

/* ================== æ™‚æ•¸è‡ªå‹•è¨ˆç®— ================== */
function diffHours_(start, end){
  // "HH:MM"
  if(!start || !end) return "";
  const [sh, sm] = start.split(":").map(Number);
  const [eh, em] = end.split(":").map(Number);
  if([sh,sm,eh,em].some(n => Number.isNaN(n))) return "";

  let s = sh*60 + sm;
  let e = eh*60 + em;

  // è·¨åˆå¤œï¼šä¾‹å¦‚ 23:00 -> 01:00
  if(e < s) e += 24*60;

  const mins = e - s;
  const hours = mins / 60;

  // ä»¥ 0.5 å°æ™‚ç‚ºå–®ä½å››æ¨äº”å…¥ï¼ˆå¯æ”¹ï¼‰
  const rounded = Math.round(hours * 2) / 2;
  return rounded > 0 ? String(rounded) : "";
}

function refreshAutoHours(){
  $("otHours").value = diffHours_($("otStart").value, $("otEnd").value);
  $("leaveHours").value = diffHours_($("leaveStart").value, $("leaveEnd").value);
  refreshButtons();
}

/* ================== UI / Tabs ================== */
function showTab(which){
  ["tabApply","tabMine","tabMgr"].forEach(id=>$(id).classList.remove("active"));
  $("tab"+which).classList.add("active");
  $("panelApply").classList.toggle("hidden", which!=="Apply");
  $("panelMine").classList.toggle("hidden", which!=="Mine");
  $("panelMgr").classList.toggle("hidden", which!=="Mgr");
}

/* ================== Buttons enable/disable ================== */
function refreshButtons(){
  // åªè¦ ready æ‰èƒ½æ‰“å¡/é€å–®ï¼›ä½† GPS æ¸¬è©¦æ°¸é å¯æŒ‰
  $("btnIn").disabled  = !ready;
  $("btnOut").disabled = !ready;

  const otOk =
    $("otDate").value && $("otStart").value && $("otEnd").value && $("otHours").value;

  const leaveOk =
    $("leaveDate").value && $("leaveStart").value && $("leaveEnd").value && $("leaveHours").value;

  $("btnOTApply").disabled = !(ready && otOk);
  $("btnLeaveApply").disabled = !(ready && leaveOk);

  $("btnReloadMine").disabled = !ready;
  $("btnReloadPending").disabled = !(ready && isManager);
}

/* ================== æ ¸å¿ƒç¶å®š ================== */
function bindCoreButtons(){
  $("tabApply").onclick = ()=>showTab("Apply");
  $("tabMine").onclick  = ()=>{ showTab("Mine"); loadMine(); };
  $("tabMgr").onclick   = ()=>{ showTab("Mgr");  loadPending(); };

  $("btnGPS").onclick = async ()=>{
    try{
      await getGPS_();
      setStatus("å®šä½å®Œæˆ âœ…","ok");
    }catch(e){
      setStatus(e.message,"err");
    }
  };

  $("btnOpenDrive").onclick = ()=>{
    window.open(DRIVE_FOLDER_URL, "_blank");
  };

  $("btnIn").onclick  = ()=> punch_("IN");
  $("btnOut").onclick = ()=> punch_("OUT");

  $("btnOTApply").onclick    = ()=> submitOT();
  $("btnLeaveApply").onclick = ()=> submitLeave();

  $("btnReloadMine").onclick    = ()=> loadMine();
  $("btnReloadPending").onclick = ()=> loadPending();

  // è‡ªå‹•è¨ˆç®—æ™‚æ•¸
  ["change","input"].forEach(ev=>{
    ["otStart","otEnd","leaveStart","leaveEnd"].forEach(id=>{
      $(id).addEventListener(ev, refreshAutoHours);
    });
  });

  // ä¸€èˆ¬æ¬„ä½è®Šå‹•
  ["change","input","keyup"].forEach(ev=>{
    ["otDate","otReason","otAttachLink","leaveType","leaveDate","leaveReason","leaveAttachLink"].forEach(id=>{
      $(id).addEventListener(ev, refreshButtons);
    });
  });

  refreshButtons();
}

/* ================== æ‰“å¡ ================== */
async function punch_(type){
  if(!ready) return;

  // é˜²æ­¢é€£é»
  $("btnIn").disabled = true;
  $("btnOut").disabled = true;

  try{
    const gps = await getGPS_(); // æ¯æ¬¡æ‰“å¡é‡æ–°å®šä½

    const r = await jsonpWrite_({
      action:"punch",
      type,
      userId,
      displayName,
      lat:gps.lat,
      lng:gps.lng,
      distance: Math.round(gps.distance),
      companyName: gps.companyName,
      ts: Date.now(),
      traceId: traceId_()
    }, type==="IN" ? "ä¸Šç­æ‰“å¡æˆåŠŸ âœ…" : "ä¸‹ç­æ‰“å¡æˆåŠŸ âœ…");

    if(!r) return;
  }catch(e){
    setStatus(e.message || "æ‰“å¡å¤±æ•—","err");
  }finally{
    refreshButtons();
  }
}

/* ================== ç”³è«‹é€å‡º ================== */
async function submitOT(){
  if(!ready) return;
  const payload = {
    action:"apply",
    kind:"OT",
    userId,
    displayName,
    date: $("otDate").value,
    startTime: $("otStart").value,
    endTime: $("otEnd").value,
    hours: $("otHours").value,
    reason: $("otReason").value || "",
    attachLink: $("otAttachLink").value || "",
    ts: Date.now(),
    traceId: traceId_()
  };
  const r = await jsonpWrite_(payload, "åŠ ç­ç”³è«‹å·²é€å‡º âœ…");
  if(r?.ok){
    $("otReason").value = "";
    $("otAttachLink").value = "";
    refreshButtons();
  }
}

async function submitLeave(){
  if(!ready) return;
  const payload = {
    action:"apply",
    kind:"LEAVE",
    leaveType: $("leaveType").value,
    userId,
    displayName,
    date: $("leaveDate").value,
    startTime: $("leaveStart").value,
    endTime: $("leaveEnd").value,
    hours: $("leaveHours").value,
    reason: $("leaveReason").value || "",
    attachLink: $("leaveAttachLink").value || "",
    ts: Date.now(),
    traceId: traceId_()
  };
  const r = await jsonpWrite_(payload, "è«‹å‡ç”³è«‹å·²é€å‡º âœ…");
  if(r?.ok){
    $("leaveReason").value = "";
    $("leaveAttachLink").value = "";
    refreshButtons();
  }
}

/* ================== æˆ‘çš„ç”³è«‹ ================== */
async function loadMine(){
  $("mineList").innerText = "è¼‰å…¥ä¸­â€¦";
  try{
    const data = await jsonp_({ action:"mine", userId, ts:Date.now(), traceId: traceId_() });
    if(!data?.ok){ $("mineList").innerText = data?.message || "è®€å–å¤±æ•—"; return; }

    const items = Array.isArray(data.items) ? data.items : [];
    if(items.length===0){ $("mineList").innerText = "å°šç„¡è³‡æ–™"; return; }

    $("mineList").innerHTML = items.map(it=>{
      const k = escapeHtml_(it.kind||"");
      const s = escapeHtml_(it.status||"");
      const d = escapeHtml_(it.date||"");
      const st = escapeHtml_(it.startTime||"");
      const et = escapeHtml_(it.endTime||"");
      const lt = escapeHtml_(it.leaveType||"");
      const h = escapeHtml_(String(it.hours||""));
      const r = escapeHtml_(it.reason||"");
      const link = escapeHtml_(it.attachLink||"");
      return `<div class="item">
        <div><b>${k}</b> <span class="pill">${s}</span></div>
        <div class="muted">${d}ã€€${st}~${et}ã€€${lt}ã€€${h} å°æ™‚</div>
        ${r ? `<div class="muted">åŸå› ï¼š${r}</div>` : ""}
        ${link ? `<div class="muted">é™„ä»¶ï¼š<a href="${link}" target="_blank">${link}</a></div>` : ""}
      </div>`;
    }).join("");

  }catch(e){
    $("mineList").innerText = "è¼‰å…¥å¤±æ•—ï¼ˆé€£ç·š/é€¾æ™‚ï¼‰";
    showErr(e, "loadMine failed");
  }
}

/* ================== å¾…æ ¸å‡† ================== */
async function loadPending(){
  $("pendingList").innerText = "è¼‰å…¥ä¸­â€¦";
  try{
    const data = await jsonp_({ action:"pending", userId, ts:Date.now(), traceId: traceId_() });
    if(!data?.ok){ $("pendingList").innerText = data?.message || "è®€å–å¤±æ•—"; return; }

    const items = Array.isArray(data.items) ? data.items : [];
    if(items.length===0){ $("pendingList").innerText = "å°šç„¡è³‡æ–™"; return; }

    $("pendingList").innerHTML = items.map(it=>{
      const id = escapeHtml_(it.id||"");
      const name = escapeHtml_(it.displayName||"");
      const k = escapeHtml_(it.kind||"");
      const s = escapeHtml_(it.status||"");
      const d = escapeHtml_(it.date||"");
      const st = escapeHtml_(it.startTime||"");
      const et = escapeHtml_(it.endTime||"");
      const lt = escapeHtml_(it.leaveType||"");
      const h = escapeHtml_(String(it.hours||""));
      const r = escapeHtml_(it.reason||"");
      const link = escapeHtml_(it.attachLink||"");
      return `<div class="item">
        <div><b>${name}</b> <span class="pill">${k}</span> <span class="pill">${s}</span></div>
        <div class="muted">${d}ã€€${st}~${et}ã€€${lt}ã€€${h} å°æ™‚</div>
        ${r ? `<div class="muted">åŸå› ï¼š${r}</div>` : ""}
        ${link ? `<div class="muted">é™„ä»¶ï¼š<a href="${link}" target="_blank">${link}</a></div>` : ""}
        <div class="row" style="margin-top:8px;">
          <button class="btn" onclick="approve_('${id}','APPROVE')">âœ… æ ¸å‡†</button>
          <button class="btn" onclick="approve_('${id}','REJECT')">â›”ï¸ é§å›</button>
        </div>
      </div>`;
    }).join("");

  }catch(e){
    $("pendingList").innerText = "è¼‰å…¥å¤±æ•—ï¼ˆé€£ç·š/é€¾æ™‚ï¼‰";
    showErr(e, "loadPending failed");
  }
}

async function approve_(id, decision){
  const r = await jsonpWrite_({
    action:"approve",
    id,
    decision,
    userId,
    ts: Date.now(),
    traceId: traceId_()
  }, decision==="APPROVE" ? "å·²æ ¸å‡† âœ…" : "å·²é§å› âœ…");
  if(r?.ok) loadPending();
}

/* ================== LIFF åˆå§‹åŒ– ================== */
async function initApp(){
  setStatus("åˆå§‹åŒ–ä¸­â€¦");
  try{
    if(!window.liff) throw new Error("LIFF SDK æœªè¼‰å…¥ï¼ˆç¶²è·¯/é˜»æ“‹ï¼‰");

    await liff.init({ liffId: LIFF_ID });

    if(!liff.isInClient()){
      $("user").innerHTML = "âš ï¸ è«‹ç”¨ LINE é–‹å•Ÿæ­¤é ï¼ˆLIFFï¼‰";
      setStatus("é LINE å…§é–‹å•Ÿï¼šå…ˆå¯æ¸¬å®šä½ï¼Œä½†ä¸èƒ½é€å–®/æ‰“å¡","err");
      ready = false;
      refreshButtons();
      return;
    }

    if(!liff.isLoggedIn()){
      setStatus("å°å‘ç™»å…¥ä¸­â€¦");
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;
    displayName = profile.displayName || "æœªå‘½å";
    ready = true;

    $("user").innerHTML = `ğŸ‘¤ ${escapeHtml_(displayName)} <span class="pill">å·²ç™»å…¥</span>`;

    // å•å¾Œç«¯æˆ‘æ˜¯ä¸æ˜¯ä¸»ç®¡ï¼ˆå¯é¸ï¼šä½ æ²’è¨­ manager ä¹Ÿä¸å½±éŸ¿ï¼‰
    try{
      const who = await jsonp_({ action:"whoami", userId, ts:Date.now(), traceId: traceId_() });
      isManager = !!who?.isManager;
      $("tabMgr").classList.toggle("hidden", !isManager);
    }catch(_){
      isManager = false;
      $("tabMgr").classList.add("hidden");
    }

    setStatus("ç³»çµ±å°±ç·’ âœ…","ok");
    refreshAutoHours(); // é †ä¾¿ç®—ä¸€ä¸‹
    refreshButtons();

  }catch(e){
    console.error(e);
    $("user").innerHTML = "âš ï¸ åˆå§‹åŒ–å¤±æ•—";
    setStatus("åˆå§‹åŒ–å¤±æ•—ï¼ˆè«‹çœ‹éŒ¯èª¤é¢æ¿ï¼‰","err");
    showErr(e, "initApp failed");
    ready = false;
    refreshButtons();
  }
}

window.onload = ()=>{
  bindCoreButtons();
  initApp();
};
</script>
</body>
</html>
