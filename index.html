<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HOLDON 出勤系統 - 登入</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:#f4f6f8;margin:0;padding:24px;}
    .card{max-width:420px;margin:48px auto;background:#fff;border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h2{margin:0 0 12px}
    input{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin:8px 0;font-size:16px;box-sizing:border-box}
    button{width:100%;padding:12px;border:none;border-radius:12px;background:#111;color:#fff;font-weight:700;font-size:16px;cursor:pointer}
    .muted{color:#666;font-size:13px;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h2>HOLDON 出勤系統</h2>
    <input id="empId" placeholder="員工編號 (例如 M001)" />
    <input id="pass" type="password" placeholder="密碼" />
    <button onclick="login()">登入</button>
    <div class="muted" id="msg"></div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const WEBHOOK_KEY = window.CONFIG?.WEBHOOK_KEY || "";

    function jsonpCall(action, dataObj = {}, timeoutMs = 12000){
      return new Promise((resolve, reject)=>{
        const cbName="__cb_"+Math.random().toString(36).slice(2);
        const payload={webhookKey:WEBHOOK_KEY, ...dataObj};
        const qs=new URLSearchParams();
        qs.set("action", action);
        qs.set("payload", JSON.stringify(payload));
        const url = ENDPOINT + "?" + qs.toString() + "&callback=" + cbName;

        const script=document.createElement("script");
        let done=false;

        const timer=setTimeout(()=>{
          if(done) return;
          done=true; cleanup();
          reject(new Error("timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cbName]; }catch(e){}
          if(script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName]=(res)=>{
          if(done) return;
          done=true; cleanup();
          resolve(res);
        };
        script.onerror=()=>{
          if(done) return;
          done=true; cleanup();
          reject(new Error("network error"));
        };

        document.head.appendChild(script);
        script.src=url;
      });
    }

    async function login(){
      const empId=document.getElementById("empId").value.trim();
      const pass=document.getElementById("pass").value.trim();
      const msg=document.getElementById("msg");
      msg.textContent="";

      try{
        const res = await jsonpCall("login", { empId, pass });
        if(!res.ok) throw new Error(res.message || "login failed");

        localStorage.setItem("employeeId", res.empId);
        localStorage.setItem("employeeName", res.name);
        localStorage.setItem("isManager", res.isManager ? "Y":"N");
        localStorage.setItem("canSchedule", res.canSchedule ? "Y":"N");

        if(res.isManager) location.href="manager.html";
        else location.href="app.html";
      }catch(e){
        msg.textContent = "登入失敗：" + e.message;
      }
    }
  </script>
</body>
</html>
