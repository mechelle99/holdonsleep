<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å“¡å·¥ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; padding: 20px; }
    
    /* è³‡è¨Šå¡ */
    .info-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .user-name { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .bal-box { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; }
    .bal-label { font-size: 13px; color: #666; }
    .bal-num { font-size: 20px; font-weight: bold; color: #007aff; }

    /* æ‰“å¡ */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .btn-clock { padding: 30px 10px; font-size: 20px; border: none; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-in { background: linear-gradient(135deg, #34c759, #30b753); }
    .btn-out { background: linear-gradient(135deg, #ff9500, #e68600); }
    
    /* é¸å–® */
    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .btn-menu { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; text-decoration: none; color: #333; font-weight: 500; font-size: 15px; }
    
    #gpsStatus { text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; }
  </style>
</head>
<body>

<div class="info-card">
  <div class="user-name">Hi, <span id="uName">...</span></div>
  <div class="balance-grid">
    <div class="bal-box">
      <div class="bal-label">ç‰¹ä¼‘é¤˜é¡</div>
      <div class="bal-num" id="annBal">--</div>
    </div>
    <div class="bal-box">
      <div class="bal-label">è£œä¼‘é¤˜é¡</div>
      <div class="bal-num" id="compBal">--</div>
    </div>
  </div>
</div>

<div id="gpsStatus">ğŸ“ GPS å®šä½ä¸­...</div>

<div class="clock-grid">
  <button class="btn-clock btn-in" onclick="clock('clock_in')">ä¸Šç­æ‰“å¡</button>
  <button class="btn-clock btn-out" onclick="clock('clock_out')">ä¸‹ç­æ‰“å¡</button>
</div>

<div class="menu-grid">
  <a href="request.html" class="btn-menu">ğŸ“ ç”³è«‹ä½œæ¥­</a>
  <a href="history.html" class="btn-menu">ğŸ“‹ ç”³è«‹ç´€éŒ„</a> <a href="attendance.html" class="btn-menu">ğŸ“… å‡ºå‹¤ç´€éŒ„</a>
  <a href="roster.html" class="btn-menu">ğŸ“Š åœ˜éšŠæ’ç­</a>
  <a href="manager.html" class="btn-menu" id="mgrBtn" style="display:none; color:#007aff;">ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å°ˆå€</a>
</div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  let lat='', lng='';
  navigator.geolocation.getCurrentPosition(
    p => { lat=p.coords.latitude; lng=p.coords.longitude; document.getElementById('gpsStatus').innerText='âœ… GPS å·²å®šä½'; },
    e => { document.getElementById('gpsStatus').innerText='âš ï¸ å®šä½å¤±æ•—'; }
  );

  function api(act, data={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...data, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function init() {
      const res = await api("get_me");
      if(res.ok) {
          document.getElementById("uName").innerText = res.name; // æœƒé¡¯ç¤ºåå­—
          document.getElementById("annBal").innerText = res.balances.annual.left;
          document.getElementById("compBal").innerText = res.balances.comp.left;
          if(res.isManager) document.getElementById("mgrBtn").style.display = 'block';
      }
  }

  async function clock(type) {
      if(!lat) { alert("è«‹ç­‰å¾… GPS å®šä½"); return; }
      const res = await api(type, {lat, lng});
      alert(res.message);
  }

  init();
</script>
</body>
</html>
