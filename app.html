<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>HOLDON ç³»çµ±</title>
  <style>
    :root{ --blue:#007aff; --bg:#f4f6f8; --card:#fff; }
    body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);margin:0;padding:16px;color:#333;padding-bottom:100px;}
    
    input, select, textarea {
      -webkit-appearance: none; appearance: none;
      background: #fff; border: 1px solid #ddd; border-radius: 8px;
      width: 100%; padding: 12px; box-sizing: border-box; font-size: 16px; margin-top: 5px;
    }
    
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.04);margin-bottom:16px;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;color:#fff;cursor:pointer;margin-top:10px;}
    .btn-in{background:var(--blue);}
    .btn-out{background:#ff9500;}
    .btn-gray{background:#555;}
    
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    label{font-size:13px;color:#666;font-weight:600;margin-top:12px;display:block;}
    
    .hidden{display:none;}
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);display:none;justify-content:center;align-items:center;z-index:999;}
    
    .balance-box { display: flex; gap: 10px; margin-top: 10px; }
    .bal-item { flex: 1; background: #f0f7ff; padding: 10px; border-radius: 8px; text-align: center; }
    .bal-num { font-size: 18px; font-weight: bold; color: var(--blue); }
    
    .search-bar { display: flex; gap: 8px; margin-bottom: 10px; }
    .rec-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 15px; }
  </style>
</head>
<body>

  <div id="loading">è™•ç†ä¸­...</div>

  <div class="card">
    <div class="header">
      <h2 style="margin:0;font-size:20px;" id="userName">è¼‰å…¥ä¸­...</h2>
      <a href="javascript:logout()" style="color:#c00;font-size:14px;">ç™»å‡º</a>
    </div>
    
    <div class="balance-box">
      <div class="bal-item">
        <div style="font-size:12px;color:#666;">ç‰¹ä¼‘å‰©é¤˜</div>
        <div class="bal-num" id="balAnn">--</div>
      </div>
      <div class="bal-item">
        <div style="font-size:12px;color:#666;">è£œä¼‘å‰©é¤˜</div>
        <div class="bal-num" id="balComp">--</div>
      </div>
    </div>

    <div id="mgrBtn" class="hidden" style="margin-top:10px;">
      <button class="btn" style="background:#6f42c1;" onclick="location.href='manager.html'">ğŸ‘‘ ä¸»ç®¡å¾Œå°</button>
    </div>
    <div id="schBtn" class="hidden">
      <button class="btn" style="background:#17a2b8;" onclick="location.href='schedule.html'">ğŸ“… æ’ç­è¡¨</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="clockMsg" style="text-align:center;margin-top:10px;font-size:13px;color:var(--blue);"></div>
  </div>

  <div class="card">
    <h3 style="margin:0">ğŸ“ ç·šä¸Šç”³è«‹</h3>
    <label>é¡å‹</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­ (è½‰è£œä¼‘)</option>
      <option value="OUTING">å¤–å‡ºå…¬å‹™</option>
      <option value="CORRECTION">è£œå¡ (æ¯æœˆé™5æ¬¡)</option>
    </select>

    <div id="areaLeave">
      <label>å‡åˆ¥</label>
      <select id="lType">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="sick">ç—…å‡</option>
        <option value="personal">äº‹å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="wedding">å©šå‡</option>
        <option value="funeral">å–ªå‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡ (é™ç•¶æœˆ/å–®æ—¥)</option>
        <option value="comp">è£œä¼‘</option>
      </select>
    </div>
    
    <div id="areaCorrect" class="hidden">
      <label>è£œå¡é¡åˆ¥</label>
      <select id="cType">
        <option value="IN">ä¸Šç­å¡</option>
        <option value="OUT">ä¸‹ç­å¡</option>
      </select>
    </div>

    <div id="areaAuto" class="hidden">
      <label>è‡ªå‹•æ‰“å¡ (æ ¸å‡†å¾Œç”Ÿæ•ˆ)</label>
      <select id="autoClock">
        <option value="">æ‰‹å‹•æ‰“å¡</option>
        <option value="OUT">è‡ªå‹•æ‰“å¤–å‡ºå‡ºç™¼(ä¸Šç­)</option>
        <option value="BOTH">è‡ªå‹•æ‰“å¾€è¿”å¡</option>
      </select>
    </div>

    <div class="grid">
      <div><label>é–‹å§‹æ™‚é–“</label><input type="datetime-local" id="start" onchange="calc()"></div>
      <div><label>çµæŸæ™‚é–“</label><input type="datetime-local" id="end" onchange="calc()"></div>
    </div>
    
    <label>æ™‚æ•¸ (ç³»çµ±è‡ªå‹•è¨ˆç®—)</label>
    <input id="hours" readonly style="background:#f9f9f9;color:#555;">

    <label>äº‹ç”±</label>
    <textarea id="reason" rows="2"></textarea>

    <button class="btn btn-gray" onclick="submit()">é€å‡ºç”³è«‹</button>
    <button class="btn" style="background:#fff;color:#007aff;border:1px solid #007aff;margin-top:12px;" onclick="location.href='history.html'">ğŸ“œ æŸ¥è©¢æ­·å²ç´€éŒ„</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“Š æ‰“å¡ç´€éŒ„æŸ¥è©¢</h3>
    <div class="search-bar">
      <select id="sYear"></select>
      <select id="sMonth"></select>
      <button class="btn" style="width:auto;margin:0;padding:0 15px;" onclick="searchClock()">æœå°‹</button>
    </div>
    <div id="clockList" style="min-height:50px;"></div>
  </div>

  <script src="config.js"></script>
  <script>
    const userId = localStorage.getItem("employeeId");
    if(!userId) location.href="index.html";
    document.getElementById("userName").textContent = localStorage.getItem("employeeName");

    // æ¬Šé™é¡¯ç¤º
    if(localStorage.getItem("isManager")==="Y") document.getElementById("mgrBtn").classList.remove("hidden");
    if(localStorage.getItem("canSchedule")==="Y" || localStorage.getItem("isManager")==="Y") document.getElementById("schBtn").classList.remove("hidden");

    // åˆå§‹åŒ–æ—¥æœŸé¸å–®
    const now = new Date();
    const sY = document.getElementById("sYear");
    const sM = document.getElementById("sMonth");
    for(let i=now.getFullYear(); i>=2024; i--) sY.add(new Option(i+"å¹´", i));
    for(let i=1; i<=12; i++) sM.add(new Option(i+"æœˆ", i, i===(now.getMonth()+1), i===(now.getMonth()+1)));

    function api(act, data={}) {
      document.getElementById("loading").style.display="flex";
      return new Promise((r,rj)=>{
        const cb = "cb"+Date.now();
        const payload = JSON.stringify({...data, userId, webhookKey:window.CONFIG.WEBHOOK_KEY});
        const s = document.createElement("script");
        s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        window[cb]=(res)=>{ r(res); s.remove(); document.getElementById("loading").style.display="none"; };
        s.onerror=()=>{ rj(); document.getElementById("loading").style.display="none"; }
        document.body.appendChild(s);
      });
    }

    async function init() {
      // å–å¾—é¤˜é¡èˆ‡ç´€éŒ„
      const res = await api("get_balances");
      if(res.ok) {
        document.getElementById("balAnn").textContent = res.annual.left + " æ™‚";
        document.getElementById("balComp").textContent = res.comp.left + " æ™‚";
      }
      searchClock();
    }
    init();

    function uiChange() {
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = (v==='LEAVE')?'block':'none';
      document.getElementById("areaAuto").style.display = (v==='OUTING')?'block':'none';
      document.getElementById("areaCorrect").style.display = (v==='CORRECTION')?'block':'none';
    }

    function calc() {
      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(sVal && eVal) {
        const s = new Date(sVal);
        const e = new Date(eVal);
        const diff = (e - s) / 36e5; // è½‰å°æ™‚
        document.getElementById("hours").value = diff > 0 ? diff.toFixed(1) : 0;
      }
    }

    async function clock(type) {
      if(!navigator.geolocation) return alert("ç„¡å®šä½æ¬Šé™");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const res = await api(type, { lat: pos.coords.latitude, lng: pos.coords.longitude });
        alert(res.message);
        if(res.ok) {
          document.getElementById("clockMsg").textContent = `æœ€å¾Œ: ${res.time}`;
          searchClock();
        }
      });
    }

    async function submit() {
      const cat = document.getElementById("cat").value;
      let lType = "";
      if (cat === 'LEAVE') lType = document.getElementById("lType").value;
      if (cat === 'CORRECTION') lType = document.getElementById("cType").value;

      const data = {
        category: cat,
        leaveType: lType,
        autoClock: (cat==='OUTING') ? document.getElementById("autoClock").value : '',
        start_ts: document.getElementById("start").value,
        end_ts: document.getElementById("end").value,
        hours: document.getElementById("hours").value,
        reason: document.getElementById("reason").value
      };
      
      if(!data.start_ts || !data.end_ts) return alert("è«‹å¡«å¯«æ™‚é–“");
      
      const res = await api("submit_request", data);
      alert(res.message);
      if(res.ok) { 
        document.getElementById("reason").value=""; 
        init(); // é‡æ–°æ•´ç†é¤˜é¡
      }
    }

    async function searchClock() {
      const list = document.getElementById("clockList");
      list.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">è¼‰å…¥ä¸­...</div>';
      
      const res = await api("get_dashboard", { year: sY.value, month: sM.value });
      if(res.ok && res.searchResult && res.searchResult.length > 0) {
        list.innerHTML = res.searchResult.map(r => `
          <div class="rec-item">
            <span>${r.date} <span style="font-weight:bold;color:${r.type.includes('ä¸Šç­')?'#007aff':'#ff9500'}">${r.type}</span></span>
            <span>${r.time}</span>
          </div>
        `).join("");
      } else {
        list.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">è©²æœˆç„¡ç´€éŒ„</div>';
      }
    }
    
    function logout(){ localStorage.clear(); location.href="index.html"; }
  </script>
</body>
</html>
