<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:16px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,0.05);margin-bottom:16px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer;color:#fff;}
    .btn-in{background:#007aff;}
    .btn-out{background:#ff9500;}
    .btn-mgr{background:#666;margin-bottom:10px;}
    .btn-sub{background:#333;margin-top:10px;}
    input,select{width:100%;padding:10px;margin-top:5px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;}
    .big-num{font-size:28px;font-weight:800;}
    .hidden{display:none;}
  </style>
</head>
<body>

<div id="loading" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:99;justify-content:center;align-items:center;">è™•ç†ä¸­...</div>

<div class="header">
  <div style="font-weight:bold" id="who">...</div>
  <a href="javascript:logout()" style="color:#c22;text-decoration:none;">ç™»å‡º</a>
</div>

<button id="btnMgr" class="btn btn-mgr hidden" onclick="location.href='manager.html'">ğŸ‘‘ é€²å…¥ä¸»ç®¡å¯©æ ¸å¾Œå°</button>

<div class="grid">
  <div class="card">
    <div style="font-size:12px;color:#666">ç‰¹ä¼‘å‰©é¤˜</div>
    <div class="big-num" id="valAnnual">-</div>
  </div>
  <div class="card">
    <div style="font-size:12px;color:#666">è£œä¼‘å‰©é¤˜</div>
    <div class="big-num" id="valComp">-</div>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 10px">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</h3>
  <div class="grid">
    <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
    <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
  </div>
  <div id="msg" style="margin-top:10px;color:blue;font-size:13px;"></div>
</div>

<div class="card">
  <h3 style="margin:0 0 10px">ğŸ“ ç”³è«‹å–®</h3>
  <label>é¡å‹</label>
  <select id="cat" onchange="toggle()">
    <option value="LEAVE">è«‹å‡</option>
    <option value="OT">åŠ ç­</option>
    <option value="OUTING">å¤–å‡º</option>
  </select>
  
  <div id="areaLeave">
    <label>å‡åˆ¥</label>
    <select id="lType">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="sick">ç—…å‡</option>
      <option value="birthday">ç”Ÿæ—¥å‡</option>
    </select>
  </div>

  <label>é–‹å§‹</label>
  <input type="datetime-local" id="start">
  <label>çµæŸ</label>
  <input type="datetime-local" id="end">
  <label>äº‹ç”±</label>
  <input id="reason" placeholder="è«‹è¼¸å…¥åŸå› ">

  <button class="btn btn-sub" onclick="submit()">é€å‡ºç”³è«‹</button>
</div>

<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");
  
  if(!userId) location.href="index.html";
  document.getElementById("who").textContent = `${localStorage.getItem("employeeName")} (${userId})`;
  
  // é¡¯ç¤ºä¸»ç®¡æŒ‰éˆ•
  if(localStorage.getItem("isManager")==="Y") document.getElementById("btnMgr").classList.remove("hidden");

  function api(act, data={}){
    document.getElementById("loading").style.display="flex";
    return new Promise((res, rej)=>{
      const cb = "cb"+Date.now();
      const p = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(p)}&callback=${cb}`;
      window[cb] = (r) => { res(r); document.body.removeChild(s); document.getElementById("loading").style.display="none"; };
      document.body.appendChild(s);
    });
  }

  async function init(){
    const r = await api("get_balances");
    if(r.ok){
      document.getElementById("valAnnual").textContent = r.annual.left + " å¤©";
      document.getElementById("valComp").textContent = r.comp.left + " æ™‚";
    }
  }
  init();

  async function clock(type){
    if(!confirm("ç¢ºå®šæ‰“å¡ï¼Ÿ")) return;
    navigator.geolocation.getCurrentPosition(async pos => {
       const r = await api(type, { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy });
       alert(r.message);
       document.getElementById("msg").textContent = `${r.message} @ ${r.time}`;
    }, () => alert("ç„¡æ³•å®šä½"));
  }

  async function submit(){
    const cat = document.getElementById("cat").value;
    const r = await api("submit_request", {
      category: cat,
      leaveType: cat==="LEAVE" ? document.getElementById("lType").value : "",
      start: document.getElementById("start").value,
      end: document.getElementById("end").value,
      reason: document.getElementById("reason").value
    });
    alert(r.message);
    if(r.ok) location.reload();
  }

  function toggle(){
    const v = document.getElementById("cat").value;
    document.getElementById("areaLeave").style.display = v==="LEAVE"?"block":"none";
  }

  function logout(){ localStorage.clear(); location.href="index.html"; }
</script>
</body>
</html>
