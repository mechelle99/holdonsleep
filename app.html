<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:16px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:16px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    
    .big-num{font-size:32px;font-weight:800;color:#111;}
    .label{font-size:13px;color:#666;margin-bottom:4px;}
    
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer;color:#fff;display:flex;justify-content:center;align-items:center;}
    .btn-in{background:#007aff;}
    .btn-out{background:#ff9500;}
    .btn-outing-start{background:#34c759;} 
    .btn-outing-end{background:#5856d6;}   
    
    .btn-sub{background:#111;margin-top:12px;}
    .btn-mgr{background:#6f42c1;margin-bottom:12px;}
    
    input,select{width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box;font-size:16px;}
    .hidden{display:none;}
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:999;}
    .calc-hint { font-size:13px; color:#c22; margin-top:5px; font-weight:bold; }
  </style>
</head>
<body>

  <div id="loading">è™•ç†ä¸­...</div>

  <div class="header">
    <div style="font-weight:bold;font-size:18px;" id="who">...</div>
    <a href="javascript:logout()" style="color:#c22;text-decoration:none;">ç™»å‡º</a>
  </div>

  <button id="btnMgr" class="btn btn-mgr hidden" onclick="location.href='manager.html'">ğŸ‘‘ é€²å…¥ä¸»ç®¡å¯©æ ¸å¾Œå°</button>

  <div class="grid">
    <div class="card">
      <div class="label">ç‰¹ä¼‘å‰©é¤˜</div>
      <div class="big-num"><span id="valAnnual">-</span><span style="font-size:14px"> å¤©</span></div>
    </div>
    <div class="card">
      <div class="label">è£œä¼‘å‰©é¤˜</div>
      <div class="big-num"><span id="valComp">-</span><span style="font-size:14px"> æ™‚</span></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="clockMsg" style="margin-top:10px;color:#007aff;font-size:13px;text-align:center;"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸš€ å¤–å‡º / å…¬å‹™</h3>
    <div class="grid">
      <button class="btn btn-outing-start" onclick="clock('clock_outing_start')">å¤–å‡ºå‡ºç™¼</button>
      <button class="btn btn-outing-end" onclick="clock('clock_outing_end')">å¤–å‡ºè¿”å›</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸ“ æå‡ºç”³è«‹</h3>
    <label class="label">é¡å‹</label>
    <select id="cat" onchange="toggle()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­ (è½‰è£œä¼‘)</option>
      <option value="OUTING">å¤–å‡ºç”³è«‹ (äº‹å…ˆ)</option>
    </select>
    
    <div id="areaLeave">
      <label class="label" style="margin-top:10px">å‡åˆ¥</label>
      <select id="lType">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="sick">ç—…å‡</option>
        <option value="personal">äº‹å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="wedding">å©šå‡</option>
        <option value="funeral">å–ªå‡</option>
        <option value="maternity">ç”¢å‡/é™ªç”¢å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡ (é™ç•¶æœˆ)</option>
      </select>
    </div>

    <label class="label" style="margin-top:10px">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start" onchange="calcHours()">
    
    <label class="label" style="margin-top:10px">çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcHours()">
    
    <div id="calcResult" class="calc-hint">å…± 0 å°æ™‚</div>

    <label class="label" style="margin-top:10px">äº‹ç”±</label>
    <input id="reason" placeholder="è«‹è¼¸å…¥åŸå› ">

    <button class="btn btn-sub" onclick="submit()">é€å‡ºç”³è«‹</button>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const userId = localStorage.getItem("employeeId");
    
    if(!userId) location.href="index.html";
    document.getElementById("who").textContent = `${localStorage.getItem("employeeName")} (${userId})`;
    
    if(localStorage.getItem("isManager")==="Y") document.getElementById("btnMgr").classList.remove("hidden");

    function api(act, data={}){
      document.getElementById("loading").style.display="flex";
      return new Promise((resolve, reject)=>{
        const cb = "cb"+Date.now();
        const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
        const s = document.createElement("script");
        s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        
        window[cb] = (res) => {
           resolve(res);
           document.body.removeChild(s);
           document.getElementById("loading").style.display="none";
        };
        s.onerror = () => {
           alert("é€£ç·šå¤±æ•—");
           document.getElementById("loading").style.display="none";
        };
        document.body.appendChild(s);
      });
    }

    async function init(){
      try {
        const r = await api("get_balances");
        if(r.ok){
          document.getElementById("valAnnual").textContent = r.annual.left;
          document.getElementById("valComp").textContent = r.comp.left;
        }
      } catch(e) { console.error(e); }
    }
    init();

    // è‡ªå‹•è¨ˆç®—æ™‚æ•¸
    function calcHours() {
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      if(s && e) {
        const diff = new Date(e) - new Date(s);
        if(diff > 0) {
          const hours = (diff / 3600000).toFixed(1);
          document.getElementById("calcResult").textContent = `å…± ${hours} å°æ™‚`;
        } else {
          document.getElementById("calcResult").textContent = "çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“";
        }
      }
    }

    async function clock(type){
      if(!confirm("ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ")) return;
      
      if (!navigator.geolocation) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
        return;
      }

      document.getElementById("loading").style.display="flex";

      navigator.geolocation.getCurrentPosition(async pos => {
         try {
           const r = await api(type, { 
             lat: pos.coords.latitude, 
             lng: pos.coords.longitude, 
             accuracy: pos.coords.accuracy 
           });
           
           alert(r.message);
           document.getElementById("clockMsg").innerText = `${r.message}\næ™‚é–“ï¼š${r.time}`;
         } catch(e) {
           alert("æ‰“å¡éŒ¯èª¤ï¼š" + e);
         }
         document.getElementById("loading").style.display="none";
      }, (err) => {
         // å®šä½å¤±æ•—æ˜ç¢ºæç¤º
         document.getElementById("loading").style.display="none";
         let msg = "ç„¡æ³•å–å¾—å®šä½";
         if (err.code === 1) msg = "è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®æ¬Šé™ (Permission Denied)";
         else if (err.code === 2) msg = "å®šä½è¨Šè™Ÿä¸è‰¯";
         else if (err.code === 3) msg = "å®šä½é€¾æ™‚";
         alert("æ‰“å¡å¤±æ•—ï¼š" + msg);
      }, {
         enableHighAccuracy: true,
         timeout: 10000,
         maximumAge: 0
      });
    }

    async function submit(){
      const cat = document.getElementById("cat").value;
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      
      // è¨ˆç®—æ™‚æ•¸
      let hours = 0;
      if(s && e) {
         hours = (new Date(e) - new Date(s)) / 3600000;
         hours = Math.round(hours * 10) / 10;
      }

      const r = await api("submit_request", {
        category: cat,
        leaveType: cat==="LEAVE" ? document.getElementById("lType").value : "",
        start: s,
        end: e,
        hours: hours, // å‚³é€å‰ç«¯ç®—å¥½çš„æ™‚æ•¸
        reason: document.getElementById("reason").value
      });
      alert(r.message);
      if(r.ok) location.reload();
    }

    function toggle(){
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = v==="LEAVE"?"block":"none";
    }

    function logout(){ localStorage.clear(); location.href="index.html"; }
  </script>
</body>
</html>
