<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:16px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:16px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .big-num{font-size:32px;font-weight:800;color:#111;}
    .label{font-size:13px;color:#666;margin-bottom:4px;}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer;color:#fff;display:flex;justify-content:center;align-items:center;}
    .btn-in{background:#007aff;}
    .btn-out{background:#ff9500;}
    .btn-sub{background:#111;margin-top:12px;}
    .btn-mgr{background:#6f42c1;margin-bottom:8px;}
    .btn-sch{background:#17a2b8;margin-bottom:12px;}
    .btn-correct{background:#6c757d;}
    .btn-hist{background:#20c997;margin-top:12px;} /* æ–°æŒ‰éˆ•æ¨£å¼ */
    
    input,select{width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:10px;box-sizing:border-box;font-size:16px;}
    .hidden{display:none;}
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:999;}
    .calc-hint { font-size:13px; color:#c22; margin-top:5px; font-weight:bold; text-align:right; }
  </style>
</head>
<body>

  <div id="loading">è™•ç†ä¸­...</div>

  <div class="header">
    <div style="font-weight:bold;font-size:18px;" id="who">...</div>
    <a href="javascript:logout()" style="color:#c22;text-decoration:none;">ç™»å‡º</a>
  </div>

  <button id="btnMgr" class="btn btn-mgr hidden" onclick="location.href='manager.html'">ğŸ‘‘ é€²å…¥ä¸»ç®¡å¯©æ ¸å¾Œå°</button>
  <button class="btn btn-sch" onclick="location.href='schedule.html'">ğŸ“… é€²å…¥æ’ç­è¡¨</button>

  <div class="grid">
    <div class="card">
      <div class="label">ç‰¹ä¼‘å‰©é¤˜</div>
      <div class="big-num"><span id="valAnnual">-</span><span style="font-size:14px"> å¤©</span></div>
    </div>
    <div class="card">
      <div class="label">è£œä¼‘å‰©é¤˜</div>
      <div class="big-num"><span id="valComp">-</span><span style="font-size:14px"> æ™‚</span></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="clockMsg" style="margin-top:10px;color:#007aff;font-size:13px;text-align:center;"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸ› ï¸ å¿˜è¨˜æ‰“å¡ï¼Ÿ(è£œå¡)</h3>
    <div style="font-size:13px;color:#666;margin-bottom:8px;">æ¯æœˆé™ 5 æ¬¡ï¼Œéœ€ä¸»ç®¡æ ¸å‡†ã€‚</div>
    <label class="label">è£œå¡æ™‚é–“</label>
    <input type="datetime-local" id="correctTime">
    <label class="label" style="margin-top:10px;">é¡å‹</label>
    <select id="correctType">
      <option value="IN">è£œ ä¸Šç­å¡</option>
      <option value="OUT">è£œ ä¸‹ç­å¡</option>
    </select>
    <label class="label" style="margin-top:10px;">åŸå› </label>
    <input id="correctReason" placeholder="ä¾‹ï¼šå¿˜è¨˜æ‰“å¡ã€ç³»çµ±ç•°å¸¸">
    <button class="btn btn-sub btn-correct" onclick="submitCorrection()">é€å‡ºè£œå¡ç”³è«‹</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 12px">ğŸ“ æå‡ºç”³è«‹</h3>
    <label class="label">é¡å‹</label>
    <select id="cat" onchange="toggle()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­ (è½‰è£œä¼‘)</option>
      <option value="OUTING">å¤–å‡ºç”³è«‹ (äº‹å…ˆ)</option>
    </select>
    
    <div id="areaLeave">
      <label class="label" style="margin-top:10px">å‡åˆ¥</label>
      <select id="lType" onchange="calcHours()">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="sick">ç—…å‡</option>
        <option value="personal">äº‹å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="wedding">å©šå‡</option>
        <option value="funeral">å–ªå‡</option>
        <option value="maternity">ç”¢å‡/é™ªç”¢å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡ (é™ç•¶æœˆ)</option>
      </select>
    </div>

    <div id="areaOuting" class="hidden">
      <label class="label" style="margin-top:10px">è‡ªå‹•æ‰“å¡è¨­å®š (æ ¸å‡†å¾Œç”Ÿæ•ˆ)</label>
      <select id="autoClock">
        <option value="">ä¸è‡ªå‹•æ‰“å¡ (éœ€æ‰‹å‹•æ‰“å¡)</option>
        <option value="IN">è‡ªå‹•æ‰“ä¸Šç­å¡ (ä¾é–‹å§‹æ™‚é–“)</option>
        <option value="OUT">è‡ªå‹•æ‰“ä¸‹ç­å¡ (ä¾çµæŸæ™‚é–“)</option>
        <option value="BOTH">è‡ªå‹•æ‰“ä¸Šä¸‹ç­å¡</option>
      </select>
      <div style="font-size:12px;color:#666;margin-top:4px;">* æ ¸å‡†å¾Œç³»çµ±è‡ªå‹•ç”Ÿæˆå‡ºå‹¤ç´€éŒ„ï¼Œä¸éœ€å†æ‰‹å‹•æ‰“å¡ã€‚</div>
    </div>

    <label class="label" style="margin-top:10px">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start" onchange="calcHours()">
    
    <label class="label" style="margin-top:10px">çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcHours()">
    
    <div id="calcResult" class="calc-hint"></div>

    <label class="label" style="margin-top:10px">äº‹ç”±</label>
    <input id="reason" placeholder="è«‹è¼¸å…¥åŸå› ">

    <button class="btn btn-sub" onclick="submit()">é€å‡ºç”³è«‹</button>
    
    <button class="btn btn-hist" onclick="location.href='history.html'">ğŸ“œ æŸ¥è©¢æ­·å²ç”³è«‹ç´€éŒ„</button>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const userId = localStorage.getItem("employeeId");
    
    if(!userId) location.href="index.html";
    document.getElementById("who").textContent = `${localStorage.getItem("employeeName")} (${userId})`;
    
    if(localStorage.getItem("isManager")==="Y") {
        document.getElementById("btnMgr").classList.remove("hidden");
    }

    function api(act, data={}){
      document.getElementById("loading").style.display="flex";
      return new Promise((resolve, reject)=>{
        const cb = "cb"+Date.now();
        const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
        const s = document.createElement("script");
        s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        window[cb] = (res) => { resolve(res); document.body.removeChild(s); document.getElementById("loading").style.display="none"; };
        s.onerror = () => { alert("é€£ç·šå¤±æ•—"); document.getElementById("loading").style.display="none"; };
        document.body.appendChild(s);
      });
    }

    async function init(){
      try {
        const r = await api("get_balances");
        if(r.ok){
          document.getElementById("valAnnual").textContent = r.annual.left;
          document.getElementById("valComp").textContent = r.comp.left;
        }
      } catch(e) { console.error(e); }
    }
    init();

    function calcHours() {
      const type = document.getElementById("lType").value;
      const cat = document.getElementById("cat").value;
      if (cat === 'LEAVE' && type === 'birthday') {
         document.getElementById("calcResult").textContent = "ğŸ‚ ç”Ÿæ—¥å‡å›ºå®šç‚º 1 å¤© (8å°æ™‚)";
         return;
      }
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      if(s && e) {
        const diff = new Date(e) - new Date(s);
        if(diff > 0) {
          const hours = (diff / 3600000).toFixed(1);
          document.getElementById("calcResult").textContent = `é ä¼°æ™‚æ•¸: ${hours} å°æ™‚`;
        } else {
          document.getElementById("calcResult").textContent = "æ™‚é–“ç„¡æ•ˆ";
        }
      } else {
        document.getElementById("calcResult").textContent = "";
      }
    }

    async function clock(type){
      if(!confirm("ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ")) return;
      if (!navigator.geolocation) {
        alert("ä¸æ”¯æ´å®šä½");
        return;
      }
      document.getElementById("loading").style.display="flex";
      navigator.geolocation.getCurrentPosition(async pos => {
         try {
           const r = await api(type, { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy });
           alert(r.message);
           document.getElementById("clockMsg").innerText = `${r.message} @ ${r.time}`;
         } catch(e) { alert("æ‰“å¡éŒ¯èª¤ï¼š" + e); }
         document.getElementById("loading").style.display="none";
      }, (err) => {
         document.getElementById("loading").style.display="none";
         alert("ç„¡æ³•å®šä½ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ– GPS");
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }

    async function submitCorrection() {
      const time = document.getElementById("correctTime").value;
      const type = document.getElementById("correctType").value;
      const reason = document.getElementById("correctReason").value;
      if(!time || !reason) return alert("è«‹å¡«å¯«è£œå¡æ™‚é–“èˆ‡åŸå› ");
      const r = await api("submit_request", { category: "CORRECTION", leaveType: type, start: time, end: time, hours: 0, reason: reason });
      if(r.ok) { alert("âœ… " + r.message); location.reload(); } else { alert("âŒ " + r.message); }
    }

    async function submit(){
      const cat = document.getElementById("cat").value;
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      const autoClockVal = document.getElementById("autoClock").value;
      let hours = 0;
      if(s && e) {
         hours = (new Date(e) - new Date(s)) / 3600000;
         hours = Math.round(hours * 10) / 10;
      }
      const r = await api("submit_request", {
        category: cat, leaveType: cat==="LEAVE" ? document.getElementById("lType").value : "",
        start: s, end: e, hours: hours, reason: document.getElementById("reason").value,
        autoClock: (cat === 'OUTING') ? autoClockVal : "" 
      });
      if(r.ok) { alert("âœ… " + r.message); location.reload(); } 
      else { alert("âŒ å¤±æ•—ï¼š" + r.message); }
    }

    function toggle(){
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = v==="LEAVE"?"block":"none";
      if(v === "OUTING") { document.getElementById("areaOuting").style.display = "block"; } 
      else { document.getElementById("areaOuting").style.display = "none"; }
      calcHours();
    }

    function logout(){ localStorage.clear(); location.href="index.html"; }
  </script>
</body>
</html>
