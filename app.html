<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON æ‰“å¡/è«‹å‡</title>

  <style>
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      margin:0;
      background:#f6f7fb;
      color:#111;
    }
    .wrap{max-width:560px;margin:0 auto;padding:18px;}
    .card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      padding:16px;
      margin:12px 0;
    }
    h1{font-size:18px;margin:0 0 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    button{
      flex:1;
      min-width:140px;
      border:0;
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
    }

    .primary{background:#16a34a;color:#fff}
    .danger{background:#dc2626;color:#fff}
    .ghost{background:#111827;color:#fff}

    .muted{color:#6b7280;font-size:13px}
    .msg{
      white-space:pre-wrap;
      background:#0b1220;
      color:#e5e7eb;
      border-radius:12px;
      padding:12px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      min-height:72px
    }

    .hidden{display:none}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      background:#eef2ff;
      color:#3730a3;
      margin-left:8px;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- ä¸»å¡ -->
  <div class="card">
    <h1 id="title">è¼‰å…¥ä¸­â€¦ <span class="pill" id="modePill">LIFF</span></h1>
    <div class="muted" id="subtitle">è«‹åœ¨ LINE å…§é–‹å•Ÿ</div>

    <div class="row" style="margin-top:12px">
      <button class="primary" id="btnIn">ğŸ“ ä¸Šç­æ‰“å¡</button>
      <button class="danger" id="btnOut">ğŸ“ ä¸‹ç­æ‰“å¡</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="ghost" id="btnMy">ğŸ“Š æˆ‘çš„ç´€éŒ„</button>
    </div>
  </div>

  <!-- å“¡å·¥ç´€éŒ„ -->
  <div class="card hidden" id="cardEmployee">
    <h1>ğŸ“Š æˆ‘çš„å‡ºå‹¤ç´€éŒ„</h1>
    <div class="msg" id="empResult">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- Console -->
  <div class="card">
    <h1>Console</h1>
    <div class="msg" id="msg"></div>
  </div>

</div>

<script src="config.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
  const $ = (id)=>document.getElementById(id);

  function log(msg){
    $('msg').textContent =
      "["+new Date().toLocaleTimeString('zh-TW',{hour12:false})+"]\n"+
      msg + "\n\n" + $('msg').textContent;
  }

  function q(name){
    return new URL(location.href).searchParams.get(name) || '';
  }

  // === éœæ…‹è¨­å®šï¼ˆå¾ config.js è®€ï¼‰===
  const API_URL = (window.CONFIG?.GAS_ENDPOINT || "").trim();
  const LIFF_ID = (window.CONFIG?.LIFF_ID || "").trim();
  const WEBHOOK_KEY = (window.CONFIG?.WEBHOOK_KEY || "").trim();

  function assertConfig(){
    if(!API_URL) throw new Error("âŒ config.js æœªè¨­å®š GAS_ENDPOINT");
    if(!LIFF_ID) throw new Error("âŒ config.js æœªè¨­å®š LIFF_ID");
    if(!WEBHOOK_KEY) throw new Error("âŒ config.js æœªè¨­å®š WEBHOOK_KEY");
  }

  async function postApi(action,data){
    assertConfig();
    const idToken = liff.getIDToken();
    if(!idToken) throw new Error("Missing idToken");

    const payload = Object.assign({}, data||{}, {
      idToken,
      webhookKey: WEBHOOK_KEY
    });

    const res = await fetch(API_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action, payload })
    });

    const json = await res.json();
    return json;
  }

  async function getLocation(){
    const pos = await liff.getCurrentPosition();
    return {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude,
      accuracy: pos.coords.accuracy
    };
  }

  async function loadDashboard(){
    try{
      const r = await postApi("get_my_dashboard",{});
      $('empResult').textContent = JSON.stringify(r,null,2);
    }catch(e){
      $('empResult').textContent = "è¼‰å…¥å¤±æ•—ï¼š" + (e?.message || e);
    }
  }

  async function boot(){
    assertConfig();

    // åˆå§‹åŒ– LIFF
    await liff.init({ liffId: LIFF_ID });

    if(!liff.isLoggedIn()){
      liff.login();
      return;
    }

    // å–å¾—ä½¿ç”¨è€…
    const me = await postApi("get_me",{});
    log("get_me => " + JSON.stringify(me));

    if(!me.ok){
      $('title').textContent="ç„¡æ³•ä½¿ç”¨";
      $('subtitle').textContent=me.message || "éŒ¯èª¤";
      return;
    }

    $('title').textContent = "å—¨ " + (me.emp?.name || "åŒä»") + " ğŸ‘‹";
    $('subtitle').textContent = "å¯é–‹å§‹æ‰“å¡";

    // æŒ‰éˆ•ï¼šæ‰“å¡
    $('btnIn').onclick = async ()=>{
      try{
        const loc = await getLocation();
        const r = await postApi("clock_in", loc);
        log("clock_in => " + JSON.stringify(r));
        alert(r.message || "å®Œæˆ");
      }catch(e){
        log("clock_in error => " + (e?.message || e));
        alert("æ‰“å¡å¤±æ•—ï¼š" + (e?.message || e));
      }
    };

    $('btnOut').onclick = async ()=>{
      try{
        const loc = await getLocation();
        const r = await postApi("clock_out", loc);
        log("clock_out => " + JSON.stringify(r));
        alert(r.message || "å®Œæˆ");
      }catch(e){
        log("clock_out error => " + (e?.message || e));
        alert("æ‰“å¡å¤±æ•—ï¼š" + (e?.message || e));
      }
    };

    // æŒ‰éˆ•ï¼šæˆ‘çš„ç´€éŒ„
    $('btnMy').onclick = ()=>{
      const u = new URL(location.href);
      u.searchParams.set("page","employee");
      location.href = u.toString();
    };

    // åˆ¤æ–·é é¢
    if(q('page')==='employee'){
      $('cardEmployee').classList.remove('hidden');
      loadDashboard();
    }
  }

  boot().catch(e=>{
    log("åˆå§‹åŒ–å¤±æ•— => " + (e?.message || e));
    $('title').textContent = "åˆå§‹åŒ–å¤±æ•—";
    $('subtitle').textContent = (e?.message || e);
  });
</script>
</body>
</html>
