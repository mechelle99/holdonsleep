<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>HOLDON</title>
  <style>
    :root{ --blue:#007aff; --bg:#f4f6f8; --card:#fff; }
    body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);margin:0;padding:16px;color:#333;padding-bottom:100px;}
    
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; box-sizing: border-box; font-size:16px; -webkit-appearance:none; background:#fff;}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:16px;}
    
    .btn{width:100%;padding:12px;border:none;border-radius:8px;font-weight:bold;color:#fff;cursor:pointer;margin-top:10px;font-size:16px;}
    .btn-in{background:var(--blue);} .btn-out{background:#ff9500;} .btn-gray{background:#555;}
    
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .bal-box{display:flex;gap:10px;}
    .bal-item{flex:1;background:#f0f7ff;padding:8px;border-radius:8px;text-align:center;}
    
    /* ç´€éŒ„å¡ç‰‡ */
    .rec-card { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
    .rec-date { font-weight: bold; font-size: 15px; width: 60px; }
    .rec-shift { font-size: 12px; color: #666; width: 40px; text-align: center; background: #eee; border-radius: 4px; padding: 2px 0; }
    .rec-time { font-size: 14px; text-align: right; flex: 1; margin-right: 10px; line-height: 1.4; color:#333; }
    .status-tag { font-size: 12px; padding: 3px 8px; border-radius: 4px; color: #fff; font-weight: bold; min-width: 50px; text-align: center; }
    
    .st-ok { background: #34c759; } /* æ­£å¸¸ */
    .st-late { background: #ffcc00; color: #333; } /* é²åˆ°/æ—©é€€ */
    .st-miss { background: #ff3b30; } /* ç¼ºå¡/æ› è· */
    .st-abn { background: #5856d6; } /* ç•°å¸¸(è¶…æ™‚) */
    .st-off { background: #ccc; color: #fff; } /* ä¼‘å‡ */
    .st-leave { background: #007aff; } /* è«‹å‡ */

    .hidden { display: none; }
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:999;}
  </style>
</head>
<body>
  <div id="loading">è™•ç†ä¸­...</div>
  
  <div class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
      <h2 style="margin:0;font-size:18px;" id="uName">...</h2>
      <a href="javascript:logout()" style="color:#c00;font-size:14px;">ç™»å‡º</a>
    </div>
    <div class="bal-box">
      <div class="bal-item"><small>ç‰¹ä¼‘å‰©é¤˜</small><div style="font-size:18px;color:var(--blue);font-weight:bold;" id="bAnn">--</div></div>
      <div class="bal-item"><small>è£œä¼‘å‰©é¤˜</small><div style="font-size:18px;color:var(--blue);font-weight:bold;" id="bComp">--</div></div>
    </div>
    <div id="admBtns" style="margin-top:10px;" class="hidden">
      <button class="btn" style="width:auto;background:#6f42c1;padding:8px 15px;" onclick="location.href='manager.html'">ğŸ‘‘ ä¸»ç®¡</button>
      <button class="btn" style="width:auto;background:#17a2b8;padding:8px 15px;" onclick="location.href='schedule.html'">ğŸ“… æ’ç­</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“ æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="cMsg" style="text-align:center;margin-top:8px;font-size:13px;color:var(--blue);"></div>
  </div>

  <div class="card">
    <h3 style="margin:0">ğŸ“ ç”³è«‹</h3>
    <label>é¡å‹</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option><option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡ºå…¬å‹™</option><option value="CORRECTION">è£œå¡</option>
    </select>
    <div id="areaLeave">
      <label>å‡åˆ¥</label>
      <select id="lType">
        <option value="annual">ç‰¹ä¼‘</option><option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option><option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="comp">è£œä¼‘</option><option value="birthday">ç”Ÿæ—¥å‡</option>
        <option value="checkup">ç”¢æª¢å‡</option><option value="paternity">é™ªç”¢å‡</option>
        <option value="maternity">ç”¢å‡</option><option value="wedding">å©šå‡</option>
        <option value="funeral">å–ªå‡</option><option value="injury">å…¬å‚·ç—…å‡</option>
      </select>
    </div>
    <div id="areaOut" class="hidden"><label>è‡ªå‹•æ‰“å¡</label><select id="autoClock"><option value="">æ‰‹å‹•</option><option value="OUT">è‡ªå‹•å¤–å‡º(ä¸Šç­)</option><option value="BOTH">è‡ªå‹•å¾€è¿”</option></select></div>
    <div class="grid">
      <div><label>é–‹å§‹</label><input type="datetime-local" id="start" onchange="calc()"></div>
      <div><label>çµæŸ</label><input type="datetime-local" id="end" onchange="calc()"></div>
    </div>
    <label>æ™‚æ•¸ (è‡ªå‹•)</label><input id="hrs" readonly style="background:#eee">
    <label>äº‹ç”±</label><textarea id="reason" rows="1"></textarea>
    <button class="btn btn-gray" onclick="submit()">é€å‡º</button>
    <button class="btn" style="background:#fff;color:#007aff;border:1px solid #007aff;margin-top:10px;" onclick="location.href='history.html'">ğŸ“œ æ­·å²ç´€éŒ„</button>
  </div>

  <div class="card">
  <button class="btn" style="width:100%;background:#333;color:#fff;" onclick="location.href='attendance.html'">
    ğŸ“… æŸ¥çœ‹è©³ç´°å‡ºå‹¤ç´€éŒ„
  </button>
</div>

  <script src="config.js"></script>
  <script>
    const uid=localStorage.getItem("employeeId");
    if(!uid) location.href="index.html";
    document.getElementById("uName").textContent = localStorage.getItem("employeeName");
    
    // åš´æ ¼æ¬Šé™é¡¯ç¤º
    if(localStorage.getItem("isManager")==='Y') document.getElementById("admBtns").classList.remove("hidden");
    else if(localStorage.getItem("canSchedule")==='Y') document.getElementById("admBtns").classList.remove("hidden");

    const now=new Date();
    const yS=document.getElementById("y"), mS=document.getElementById("m");
    for(let i=now.getFullYear();i>=2024;i--) yS.add(new Option(i,i));
    for(let i=1;i<=12;i++) mS.add(new Option(i,i,i===now.getMonth()+1,i===now.getMonth()+1));

    function api(a,d={}){
      document.getElementById("loading").style.display="flex";
      return new Promise(r=>{
        const s=document.createElement("script");
        s.src=`${window.CONFIG.GAS_ENDPOINT}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d,userId:uid,webhookKey:window.CONFIG.WEBHOOK_KEY}))}&callback=cb${Date.now()}`;
        window[`cb${Date.now()}`]=(res)=>{r(res);s.remove();document.getElementById("loading").style.display="none"};
        document.body.appendChild(s);
      });
    }

    async function init(){
      const r = await api("get_balances");
      if(r.ok) {
        document.getElementById("bAnn").textContent = r.annual.left;
        document.getElementById("bComp").textContent = r.comp.left;
      }
      search();
    }
    init();

    function uiChange(){
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = (v==='LEAVE')?'block':'none';
      document.getElementById("areaOut").style.display = (v==='OUTING')?'block':'none';
    }
    function calc(){
      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(sVal && eVal) {
        const s = new Date(sVal), e = new Date(eVal);
        if(e <= s) { 
           alert("çµæŸæ™‚é–“ä¸èƒ½æ—©æ–¼é–‹å§‹æ™‚é–“"); 
           document.getElementById("end").value = "";
           document.getElementById("hrs").value = "";
           return;
        }
        document.getElementById("hrs").value = ((e-s)/36e5).toFixed(1);
      }
    }
    async function clock(t){
      navigator.geolocation.getCurrentPosition(async p => {
        const r = await api(t, {lat:p.coords.latitude, lng:p.coords.longitude});
        alert(r.message); if(r.ok) search();
      }, ()=>alert("ç„¡å®šä½"));
    }
    async function submit(){
      const d = {
        category: document.getElementById("cat").value,
        leaveType: document.getElementById("lType").value,
        autoClock: document.getElementById("autoClock").value,
        start_ts: document.getElementById("start").value,
        end_ts: document.getElementById("end").value,
        hours: document.getElementById("hrs").value,
        reason: document.getElementById("reason").value
      };
      if(!d.start_ts) return alert("è«‹å¡«æ™‚é–“");
      const r = await api("submit_request", d);
      alert(r.message); if(r.ok) init();
    }

    async function search(){
      const r = await api("get_dashboard", {year:yS.value, month:mS.value});
      const d = document.getElementById("resList");
      d.innerHTML = "";
      
      if(r.ok && r.schedule) {
        const days = new Date(yS.value, mS.value, 0).getDate();
        const map = {}; 
        
        // 1. åˆå§‹åŒ– (ä¸åœ¨ç­è¡¨=é è¨­æ—©ç­)
        for(let i=1; i<=days; i++) map[i] = { shift: r.schedule[i] || 'EARLY', in:null, out:null, leave:null };
        
        // 2. å¡«å…¥æ‰“å¡
        r.clocks.forEach(c => {
          const parts = c.date.split('-');
          const day = parseInt(parts[2]);
          if(map[day]) {
            if(c.type.includes('ä¸Šç­')) map[day].in = c.time;
            if(c.type.includes('ä¸‹ç­')) map[day].out = c.time;
          }
        });

        // 3. å¡«å…¥è«‹å‡
        if(r.leaves) {
          r.leaves.forEach(l => {
            const parts = l.date.split('-');
            const day = parseInt(parts[2]);
            if(map[day]) map[day].leave = l.type; // å„ªå…ˆé¡¯ç¤ºå‡åˆ¥
          });
        }

        // 4. æ¸²æŸ“ (å€’åº)
        for(let i=days; i>=1; i--) { 
          const item = map[i];
          let stTag = "æ­£å¸¸", stCls = "st-ok";
          let shiftTxt = item.shift==='EARLY'?'æ—©':(item.shift==='LATE'?'åˆ':'ä¼‘');
          
          if (item.leave) {
             stTag = item.leave; stCls = "st-leave";
          } 
          else if (item.shift === 'OFF') {
             stTag = "ä¼‘å‡"; stCls = "st-off";
             if(item.in || item.out) { stTag="åŠ ç­"; stCls="st-ok"; }
          } else {
             // å·¥ä½œæ—¥åˆ¤æ–·
             if (!item.in && !item.out) { stTag="æ› è·"; stCls="st-miss"; }
             else if (!item.in) { stTag="ç¼ºä¸Šç­å¡"; stCls="st-miss"; }
             else if (!item.out) { stTag="ç¼ºä¸‹ç­å¡"; stCls="st-miss"; }
             else {
                // æ™‚é–“æ¨™æº–
                const startTarget = item.shift==='EARLY' ? '10:00:00' : '12:00:00';
                const endTarget   = item.shift==='EARLY' ? '18:00:00' : '21:00:00';
                
                // 1. é²åˆ°
                if(item.in > startTarget) { stTag="é²åˆ°"; stCls="st-late"; }
                
                // 2. æ—©é€€ (ä¸‹ç­æ™‚é–“æ—©æ–¼è¡¨å®š)
                if(item.out < endTarget) { 
                    stTag = (stTag==="é²åˆ°") ? "é²åˆ°/æ—©é€€" : "æ—©é€€";
                    stCls="st-late"; 
                }

                // 3. ç•°å¸¸ (è¶…é1å°æ™‚ä¸‹ç­)
                const outH = parseInt(item.out.split(':')[0]);
                const stdH = item.shift==='EARLY' ? 18 : 21;
                if(outH >= stdH + 1) { stTag="ç•°å¸¸"; stCls="st-abn"; }
             }
          }
          
          // æœªä¾†æ—¥æœŸä¸é¡¯ç¤º
          if(new Date(yS.value, mS.value-1, i) > new Date()) { stTag="--"; stCls="st-off"; }

          d.innerHTML += `
            <div class="rec-card">
              <div class="rec-date">${mS.value}/${i}</div>
              <div class="rec-shift">${shiftTxt}</div>
              <div class="rec-time">
                ä¸Š: ${item.in||'--:--'}<br>
                ä¸‹: ${item.out||'--:--'}
              </div>
              <div class="status-tag ${stCls}">${stTag}</div>
            </div>`;
        }
      } else { d.innerHTML = "<div style='text-align:center'>ç„¡è³‡æ–™</div>"; }
    }
    function logout(){ localStorage.clear(); location.href="index.html"; }
  </script>
</body>
</html>
