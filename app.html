<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å“¡å·¥ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
    
    /* å¡ç‰‡é€šç”¨æ¨£å¼ */
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .card h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333; }

    /* æ‰“å¡å€ */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    button.clock-btn { padding: 15px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; }
    .btn-in { background: #34c759; }
    .btn-out { background: #ff9500; }
    .btn-outing { background: #5856d6; grid-column: span 2; } /* å¤–å‡º */
    
    /* ç”³è«‹è¡¨å–® */
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-weight: bold; color: #555; font-size: 14px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { width: 100%; background: #007aff; color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }

    /* åŠŸèƒ½é¸å–® */
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .menu-btn { padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 8px; text-align: center; color: #333; font-size: 14px; cursor: pointer; text-decoration: none; display: block; }
    .menu-btn:hover { background: #f0f0f0; }

    /* æ­¡è¿è© */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .user-info { font-size: 18px; font-weight: bold; }
    .logout { font-size: 14px; color: #ff3b30; cursor: pointer; }
  </style>
</head>
<body>

<div class="header">
  <div class="user-info">Hi, <span id="userName">...</span></div>
  <div class="logout" onclick="logout()">ç™»å‡º</div>
</div>

<div class="card">
  <h3>ğŸ•’ æ‰“å¡ä½œæ¥­</h3>
  <div class="clock-grid">
    <button class="clock-btn btn-in" onclick="clock('clock_in')">ä¸Šç­æ‰“å¡</button>
    <button class="clock-btn btn-out" onclick="clock('clock_out')">ä¸‹ç­æ‰“å¡</button>
    <button class="clock-btn btn-outing" onclick="clock('outing_clock_in')">ğŸ“ å¤–å‡ºæ‰“å¡</button>
  </div>
  <div id="gpsStatus" style="font-size:12px; color:#999; text-align:center;">å®šä½ä¸­...</div>
</div>

<div class="card">
  <h3>ğŸ“ æå‡ºç”³è«‹</h3>
  
  <div class="form-group">
    <label>ç”³è«‹é¡åˆ¥</label>
    <select id="category" onchange="updateFormUI()">
      <option value="LEAVE">è«‹å‡ç”³è«‹</option>
      <option value="OT">åŠ ç­ç”³è«‹</option>
      <option value="CORRECTION">è£œå¡ç”³è«‹</option>
    </select>
  </div>

  <div class="form-group" id="typeGroup">
    <label>å‡åˆ¥</label>
    <select id="leaveType">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="personal">äº‹å‡</option>
      <option value="sick">ç—…å‡</option>
      <option value="comp">è£œä¼‘</option>
      <option value="official">å…¬å‡</option>
      <option value="maternity">ç”¢å‡/é™ªç”¢å‡</option>
      <option value="bereavement">å–ªå‡</option>
    </select>
  </div>

  <div class="form-group">
    <label id="startLabel">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start">
  </div>

  <div class="form-group" id="endGroup">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcHours()">
  </div>

  <div class="form-group" id="hoursGroup">
    <label>æ™‚æ•¸</label>
    <input type="number" id="hours" step="0.5" placeholder="è‡ªå‹•è¨ˆç®—">
  </div>

  <div class="form-group">
    <label>äº‹ç”±</label>
    <textarea id="reason" rows="2" placeholder="è«‹è¼¸å…¥èªªæ˜..."></textarea>
  </div>

  <button class="btn-submit" onclick="submitRequest()">é€å‡ºç”³è«‹</button>
</div>

<div class="menu-grid">
  <a href="attendance.html" class="menu-btn">ğŸ“… å‡ºå‹¤ç´€éŒ„</a>
  <a href="roster.html" class="menu-btn">ğŸ“Š åœ˜éšŠæ’ç­</a>
  <a href="manager.html" class="menu-btn" id="mgrBtn" style="display:none; color:#007aff; font-weight:bold;">ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å°ˆå€</a>
</div>

<script src="config.js"></script>
<script>
  // åˆå§‹åŒ–æª¢æŸ¥
  const uid = localStorage.getItem("employeeId");
  const uname = localStorage.getItem("employeeName");
  const isMgr = localStorage.getItem("isManager") === "true";

  if (!uid) { location.href = "index.html"; }
  document.getElementById("userName").innerText = uname || uid;
  if (isMgr) document.getElementById("mgrBtn").style.display = "block";

  // GPS è®Šæ•¸
  let currentLat = "", currentLng = "";

  // å•Ÿå‹• GPS
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      currentLat = pos.coords.latitude;
      currentLng = pos.coords.longitude;
      document.getElementById("gpsStatus").innerText = "âœ… GPS å·²å®šä½";
    },
    (err) => {
      document.getElementById("gpsStatus").innerText = "âš ï¸ ç„¡æ³•å®šä½ (è«‹å…è¨±æ¬Šé™)";
    },
    { enableHighAccuracy: true }
  );

  // API å‘¼å«å·¥å…·
  function api(action, payload={}) {
    return new Promise(resolve => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${action}&payload=${encodeURIComponent(JSON.stringify({...payload, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { resolve(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  // --- æ‰“å¡åŠŸèƒ½ ---
  async function clock(type) {
    if (!currentLat) { alert("è«‹ç­‰å¾… GPS å®šä½å®Œæˆ"); return; }
    
    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "è™•ç†ä¸­...";
    btn.disabled = true;

    const res = await api(type, { lat: currentLat, lng: currentLng });
    alert(res.message);
    
    btn.innerText = originalText;
    btn.disabled = false;
  }

  // --- ç”³è«‹è¡¨å–® UI é€£å‹• (é—œéµä¿®å¾©ï¼šè£œå¡éš±è—æ¬„ä½) ---
  function updateFormUI() {
      const cat = document.getElementById("category").value;
      const typeGroup = document.getElementById("typeGroup");
      const typeSel = document.getElementById("leaveType");
      const endGroup = document.getElementById("endGroup");
      const hoursGroup = document.getElementById("hoursGroup");
      const startLabel = document.getElementById("startLabel");

      if (cat === 'CORRECTION') {
          // è£œå¡æ¨¡å¼
          endGroup.style.display = 'none';
          hoursGroup.style.display = 'none';
          startLabel.innerText = "è£œå¡æ™‚é–“ (è«‹é¸æ­£ç¢ºæ‰“å¡é»)";
          
          // å‡åˆ¥è®Šæˆ ä¸Š/ä¸‹ç­
          typeSel.innerHTML = `
            <option value="IN">ä¸Šç­å¡</option>
            <option value="OUT">ä¸‹ç­å¡</option>
          `;
      } else {
          // æ¢å¾©æ­£å¸¸æ¨¡å¼
          endGroup.style.display = 'block';
          hoursGroup.style.display = 'block';
          startLabel.innerText = "é–‹å§‹æ™‚é–“";
          
          if(cat === 'LEAVE') {
             typeSel.innerHTML = `
                <option value="annual">ç‰¹ä¼‘</option>
                <option value="personal">äº‹å‡</option>
                <option value="sick">ç—…å‡</option>
                <option value="comp">è£œä¼‘</option>
                <option value="official">å…¬å‡</option>
                <option value="maternity">ç”¢å‡/é™ªç”¢å‡</option>
                <option value="bereavement">å–ªå‡</option>
             `;
          } else {
             // åŠ ç­
             typeSel.innerHTML = `<option value="OT">åŠ ç­</option>`;
          }
      }
  }

  // è‡ªå‹•è¨ˆç®—æ™‚æ•¸
  function calcHours() {
      const s = new Date(document.getElementById("start").value);
      const e = new Date(document.getElementById("end").value);
      if(s && e && e > s) {
          const diff = (e - s) / (1000 * 60 * 60);
          document.getElementById("hours").value = diff.toFixed(1);
      }
  }

  // --- é€å‡ºç”³è«‹ ---
  async function submitRequest() {
      const cat = document.getElementById("category").value;
      const start = document.getElementById("start").value;
      
      if(!start) { alert("è«‹é¸æ“‡æ™‚é–“"); return; }

      const payload = {
          category: cat,
          leaveType: document.getElementById("leaveType").value,
          start: start,
          // è£œå¡æ™‚ï¼ŒçµæŸæ™‚é–“ = é–‹å§‹æ™‚é–“ (å¾Œç«¯æœƒè™•ç†)
          end: document.getElementById("end").value || start, 
          hours: document.getElementById("hours").value || 0,
          reason: document.getElementById("reason").value
      };

      const btn = document.querySelector(".btn-submit");
      btn.innerText = "é€å‡ºä¸­...";
      btn.disabled = true;

      const res = await api("submit_request", payload);
      alert(res.message);
      
      btn.innerText = "é€å‡ºç”³è«‹";
      btn.disabled = false;
      
      if(res.ok) {
          // æ¸…ç©ºè¡¨å–®
          document.getElementById("reason").value = "";
          document.getElementById("hours").value = "";
      }
  }

  function logout() {
      localStorage.clear();
      location.href = "index.html";
  }

  // åˆå§‹åŒ– UI
  updateFormUI();
</script>
</body>
</html>
