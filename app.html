<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>HOLDON ç³»çµ±</title>
  <style>
    :root{ --blue:#007aff; --bg:#f4f6f8; --card:#fff; }
    body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);margin:0;padding:16px;color:#333;padding-bottom:100px;}
    input, select, textarea {
      -webkit-appearance: none; appearance: none;
      background: #fff; border: 1px solid #ddd; border-radius: 8px;
      width: 100%; padding: 12px; font-size: 16px; margin-top: 5px; box-sizing: border-box;
    }
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.04);margin-bottom:16px;}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;color:#fff;cursor:pointer;margin-top:10px;}
    .btn-in{background:var(--blue);} .btn-out{background:#ff9500;} .btn-gray{background:#555;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .bal-box{display:flex;gap:10px;margin-top:10px;}
    .bal-item{flex:1;background:#f0f7ff;padding:10px;border-radius:8px;text-align:center;}
    .hidden{display:none;}
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);display:none;justify-content:center;align-items:center;z-index:999;}
  </style>
</head>
<body>
  <div id="loading">è™•ç†ä¸­...</div>
  
  <div class="card">
    <div style="display:flex;justify-content:space-between;">
      <h2 style="margin:0;font-size:20px;" id="uName">...</h2>
      <a href="javascript:logout()" style="color:#c00;font-size:14px;">ç™»å‡º</a>
    </div>
    <div class="bal-box">
      <div class="bal-item"><div style="font-size:12px;color:#666">ç‰¹ä¼‘(æ™‚)</div><b style="font-size:18px;color:var(--blue)" id="bAnn">--</b></div>
      <div class="bal-item"><div style="font-size:12px;color:#666">è£œä¼‘(æ™‚)</div><b style="font-size:18px;color:var(--blue)" id="bComp">--</b></div>
    </div>
    <div id="btns" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“ æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="cMsg" style="text-align:center;margin-top:10px;font-size:13px;color:var(--blue);"></div>
  </div>

  <div class="card">
    <h3 style="margin:0">ğŸ“ ç”³è«‹</h3>
    <label>é¡å‹</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡ºå…¬å‹™</option>
      <option value="CORRECTION">è£œå¡</option>
    </select>
    
    <div id="areaLeave">
      <label>å‡åˆ¥</label>
      <select id="lType">
        <option value="annual">ç‰¹ä¼‘</option><option value="comp">è£œä¼‘</option>
        <option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option><option value="wedding">å©šå‡</option>
      </select>
    </div>
    
    <div id="areaOut" class="hidden">
      <label>è‡ªå‹•æ‰“å¡</label>
      <select id="autoClock">
        <option value="">æ‰‹å‹•</option><option value="OUT">è‡ªå‹•å¤–å‡º(ä¸Šç­)</option><option value="BOTH">è‡ªå‹•å¾€è¿”</option>
      </select>
    </div>

    <div class="grid">
      <div><label>é–‹å§‹</label><input type="datetime-local" id="start" onchange="calc()"></div>
      <div><label>çµæŸ</label><input type="datetime-local" id="end" onchange="calc()"></div>
    </div>
    <label>æ™‚æ•¸ (è‡ªå‹•)</label><input id="hrs" readonly style="background:#eee;">
    <label>äº‹ç”±</label><textarea id="reason"></textarea>
    <button class="btn btn-gray" onclick="submit()">é€å‡º</button>
    <button class="btn" style="background:#fff;color:#007aff;border:1px solid #007aff;margin-top:10px;" onclick="location.href='history.html'">ğŸ“œ ç´€éŒ„</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“Š æ‰“å¡æŸ¥è©¢</h3>
    <div style="display:flex;gap:5px;">
      <select id="y"></select><select id="m"></select>
      <button class="btn" style="width:auto;margin:0;padding:0 15px;" onclick="search()">æœ</button>
    </div>
    <div id="resList" style="padding-top:10px;"></div>
  </div>

  <script src="config.js"></script>
  <script>
    const uid=localStorage.getItem("employeeId");
    if(!uid) location.href="index.html";
    document.getElementById("uName").textContent = localStorage.getItem("employeeName");
    
    if(localStorage.getItem("isManager")==='Y') document.getElementById("btns").innerHTML += `<button class="btn" style="background:#6f42c1" onclick="location.href='manager.html'">ğŸ‘‘ ä¸»ç®¡</button>`;
    if(localStorage.getItem("canSchedule")==='Y'||localStorage.getItem("isManager")==='Y') document.getElementById("btns").innerHTML += `<button class="btn" style="background:#17a2b8;margin-top:5px;" onclick="location.href='schedule.html'">ğŸ“… æ’ç­</button>`;

    const now=new Date();
    const yS=document.getElementById("y"), mS=document.getElementById("m");
    for(let i=now.getFullYear();i>=2024;i--) yS.add(new Option(i,i));
    for(let i=1;i<=12;i++) mS.add(new Option(i,i,i===now.getMonth()+1,i===now.getMonth()+1));

    function api(a,d={}){
      document.getElementById("loading").style.display="flex";
      return new Promise(r=>{
        const cb="c"+Date.now();
        const s=document.createElement("script");
        s.src=`${window.CONFIG.GAS_ENDPOINT}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d,userId:uid,webhookKey:window.CONFIG.WEBHOOK_KEY}))}&callback=${cb}`;
        window[cb]=(res)=>{r(res);s.remove();document.getElementById("loading").style.display="none"};
        document.body.appendChild(s);
      });
    }

    async function init(){
      const r = await api("get_balances");
      if(r.ok) {
        document.getElementById("bAnn").textContent = r.annual.left;
        document.getElementById("bComp").textContent = r.comp.left;
      }
      search();
    }
    init();

    function uiChange(){
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = (v==='LEAVE')?'block':'none';
      document.getElementById("areaOut").style.display = (v==='OUTING')?'block':'none';
    }

    function calc(){
      const s = new Date(document.getElementById("start").value);
      const e = new Date(document.getElementById("end").value);
      if(s&&e) {
        const h = (e-s)/36e5;
        document.getElementById("hrs").value = h>0 ? h.toFixed(1) : 0;
      }
    }

    async function clock(t){
      navigator.geolocation.getCurrentPosition(async p => {
        const r = await api(t, {lat:p.coords.latitude, lng:p.coords.longitude});
        alert(r.message);
        if(r.ok) { document.getElementById("cMsg").innerText = "æœ€å¾Œ: "+r.time; search(); }
      }, ()=>alert("ç„¡å®šä½"));
    }

    async function submit(){
      const c = document.getElementById("cat").value;
      const d = {
        category: c,
        leaveType: (c==='LEAVE') ? document.getElementById("lType").value : (c==='CORRECTION'?'è£œå¡':''),
        autoClock: document.getElementById("autoClock").value,
        start_ts: document.getElementById("start").value,
        end_ts: document.getElementById("end").value,
        hours: document.getElementById("hrs").value,
        reason: document.getElementById("reason").value
      };
      if(!d.start_ts) return alert("è«‹å¡«æ™‚é–“");
      const r = await api("submit_request", d);
      alert(r.message);
      if(r.ok) init();
    }

    async function search(){
      const r = await api("get_dashboard", {year:yS.value, month:mS.value});
      const d = document.getElementById("resList");
      d.innerHTML = (r.ok && r.searchResult.length) ? 
        r.searchResult.map(x=>`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;"><span>${x.date} ${x.type}</span><span>${x.time}</span></div>`).join("") : 
        "<div style='text-align:center;color:#999'>ç„¡ç´€éŒ„</div>";
    }
    function logout(){ localStorage.clear(); location.href="index.html"; }
  </script>
</body>
</html>
